# Form implementation generated from reading ui file 'App_Comercial.ui'
#
# Created by: PyQt6 UI code generator 6.4.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic6 is
# run again.  Do not edit this file unless you know what you are doing.

from PyQt6 import QtCore, QtGui, QtWidgets
from PyQt6.QtWidgets import QMenu
from PyQt6.QtCore import Qt
import psycopg2
from config import config, get_path
from datetime import *
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
from matplotlib import ticker
from ExportDocs_Menu import Ui_ExportDocs_Menu
from tkinter.filedialog import askopenfilename, asksaveasfilename
import pandas as pd
from utils.Database_Manager import Database_Connection, Create_DBconnection
from utils.Show_Message import MessageHelper
from PDF_Styles import CustomPDF_A3
from PDF_Viewer import PDF_Viewer
import matplotlib.pyplot as plt
from matplotlib.ticker import FuncFormatter
from io import BytesIO
import numpy as np
import sys
from Excel_Export_Templates import order_reports



class AlignDelegate(QtWidgets.QStyledItemDelegate):
    """
    A custom item delegate for aligning cell content in a QTableView or QTableWidget to the center.

    Inherits from:
        QtWidgets.QStyledItemDelegate: Provides custom rendering and editing for table items.
    """
    def initStyleOption(self, option, index):
        """
        Initializes the style option for the item, setting its display alignment to center.

        Args:
            option (QtWidgets.QStyleOptionViewItem): The style option to initialize.
            index (QtCore.QModelIndex): The model index of the item.
        """
        super(AlignDelegate, self).initStyleOption(option, index)
        option.displayAlignment = QtCore.Qt.AlignmentFlag.AlignCenter

class ImageCalendarWidget(QtWidgets.QCalendarWidget):
    """
    A custom QCalendarWidget that highlights specific dates by painting an image on the calendar cells.

    This widget allows the user to set a list of dates (`task_dates`) and draws a custom image 
    on the corresponding calendar cells when these dates are displayed.

    Attributes:
    -----------
    task_dates : list
        A list of QDate objects that represent the dates on which the image will be displayed.
    """
    def __init__(self, parent=None):
        """
        Initializes the ImageCalendarWidget instance.

        Args:
        -----------
        parent : QWidget, optional
            The parent widget, if any. Defaults to None.

        Initializes the `task_dates` attribute as an empty list.
        """
        super().__init__(parent)
        self.task_dates = []

    def set_task_dates(self, dates):
        """
        Sets the dates on which the custom image will be drawn and refreshes the calendar.

        Args:
        -----------
        dates : list of QDate
            A list of QDate objects representing the dates on which the image should appear.
        """
        self.task_dates = dates
        self.updateCells()

    def paintCell(self, painter, rect, date):
        """
        Customizes the painting of calendar cells to include a flag image on specific dates.

        Args:
        -----------
        painter : QPainter
            The QPainter object responsible for rendering the cell.
        rect : QRect
            The rectangular area of the cell to be painted.
        date : QDate
            The date associated with the cell being painted.
        """
        QtWidgets.QCalendarWidget.paintCell(self, painter, rect, date)

        if date in self.task_dates:
            image_path = str(get_path("Resources", "Iconos", "Flag.png"))
            image = QtGui.QImage(image_path)
            if not image.isNull():
                image_scaled = image.scaled(rect.width() // 4, rect.height() // 4, QtCore.Qt.AspectRatioMode.KeepAspectRatio, QtCore.Qt.TransformationMode.SmoothTransformation)
                image_rect = image_scaled.rect()
                image_rect.moveTopRight(rect.topRight() - QtCore.QPoint(2, -5))
                painter.drawImage(image_rect, image_scaled)

class Ui_App_Comercial(QtWidgets.QMainWindow):
    """
    Main application window for the commercial app.
    """
    def __init__(self, name, username):
        """
        Initializes the main window, setting up the user interface and storing user-specific details.

        Args:
            name (str): The name of the user.
            username (str): The username of the user.
        """
        super(Ui_App_Comercial, self).__init__()
        self.name=name
        self.username=username
        self.pdf_viewer = PDF_Viewer()
        self.setupUi(self)

    def setupUi(self, App_Comercial):
        """
        Sets up the user interface components for the main application window.

        Args:
            App_Comercial (QtWidgets.QMainWindow): The main window object to set up.
        """
        App_Comercial.setObjectName("App_Comercial")
        App_Comercial.resize(945, 860)
        App_Comercial.setMinimumSize(QtCore.QSize(945, 860))
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "icon.ico"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        App_Comercial.setWindowIcon(icon)
        App_Comercial.setStyleSheet("background-color: rgb(255, 255, 255);")
        self.centralwidget = QtWidgets.QWidget(parent=App_Comercial)
        self.centralwidget.setObjectName("centralwidget")
        self.gridLayout_2 = QtWidgets.QGridLayout(self.centralwidget)
        self.gridLayout_2.setObjectName("gridLayout_2")
        self.frame = QtWidgets.QFrame(parent=self.centralwidget)
        self.frame.setFrameShape(QtWidgets.QFrame.Shape.StyledPanel)
        self.frame.setFrameShadow(QtWidgets.QFrame.Shadow.Raised)
        self.frame.setObjectName("frame")
        self.gridLayout = QtWidgets.QGridLayout(self.frame)
        self.gridLayout.setObjectName("gridLayout")
        self.FrameApp = QtWidgets.QVBoxLayout()
        self.FrameApp.setObjectName("FrameApp")
        self.Header = QtWidgets.QHBoxLayout()
        self.Header.setContentsMargins(-1, 0, -1, -1)
        self.Header.setObjectName("Header")
        self.LogoIcon = QtWidgets.QLabel(parent=self.frame)
        self.LogoIcon.setMinimumSize(QtCore.QSize(220, 52))
        self.LogoIcon.setMaximumSize(QtCore.QSize(220, 52))
        self.LogoIcon.setText("")
        self.LogoIcon.setPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Logo Nobg.png"))))
        self.LogoIcon.setScaledContents(True)
        self.LogoIcon.setObjectName("LogoIcon")
        self.Header.addWidget(self.LogoIcon)
        spacerItem = QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem)
        self.Button_ExpOffer = QtWidgets.QPushButton(parent=self.frame)
        self.Button_ExpOffer.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_ExpOffer.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_ExpOffer.setToolTip('Exportar Documentos')
        self.Button_ExpOffer.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_ExpOffer.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_ExpOffer.setText("")
        icon12 = QtGui.QIcon()
        icon12.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Export_Doc.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_ExpOffer.setIcon(icon12)
        self.Button_ExpOffer.setIconSize(QtCore.QSize(40, 40))
        self.Button_ExpOffer.setObjectName("Button_ExpOffer")
        self.Header.addWidget(self.Button_ExpOffer)
        spacerItem11 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem11)
        self.Button_Doc = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Doc.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_Doc.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_Doc.setToolTip('Documentaci칩n')
        self.Button_Doc.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_Doc.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_Doc.setText("")
        icon1 = QtGui.QIcon()
        icon1.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Documents_Search.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_Doc.setIcon(icon1)
        self.Button_Doc.setIconSize(QtCore.QSize(40, 40))
        self.Button_Doc.setObjectName("Button_Doc")
        self.Header.addWidget(self.Button_Doc)
        spacerItem1 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem1)
        self.Button_Graphs = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Graphs.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_Graphs.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_Graphs.setToolTip('Gr치ficos')
        self.Button_Graphs.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_Graphs.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_Graphs.setText("")
        icon14 = QtGui.QIcon()
        icon14.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Chart.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_Graphs.setIcon(icon14)
        self.Button_Graphs.setIconSize(QtCore.QSize(40, 40))
        self.Button_Graphs.setObjectName("Button_Graphs")
        self.Header.addWidget(self.Button_Graphs)
        spacerItem10 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem10)
        self.Button_ClientsResume = QtWidgets.QPushButton(parent=self.frame)
        self.Button_ClientsResume.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_ClientsResume.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_ClientsResume.setToolTip('Resumen Clientes')
        self.Button_ClientsResume.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_ClientsResume.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_ClientsResume.setText("")
        icon15 = QtGui.QIcon()
        icon15.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Customers.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_ClientsResume.setIcon(icon15)
        self.Button_ClientsResume.setIconSize(QtCore.QSize(40, 40))
        self.Button_ClientsResume.setObjectName("Button_ClientsResume")
        self.Header.addWidget(self.Button_ClientsResume)
        spacerItem13 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem13)
        self.Button_QueryTask = QtWidgets.QPushButton(parent=self.frame)
        self.Button_QueryTask.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_QueryTask.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_QueryTask.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_QueryTask.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_QueryTask.setText("")
        icon5 = QtGui.QIcon()
        icon5.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Task.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_QueryTask.setIcon(icon5)
        self.Button_QueryTask.setIconSize(QtCore.QSize(40, 40))
        self.Button_QueryTask.setObjectName("Button_QueryTask")
        self.Button_QueryTask.setToolTip("Tareas")
        self.Header.addWidget(self.Button_QueryTask)
        spacerItem14 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem14)
        self.Button_RecOffer = QtWidgets.QPushButton(parent=self.frame)
        self.Button_RecOffer.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_RecOffer.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_RecOffer.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_RecOffer.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_RecOffer.setText("")
        icon16 = QtGui.QIcon()
        icon16.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Reclamation.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_RecOffer.setIcon(icon16)
        self.Button_RecOffer.setIconSize(QtCore.QSize(40, 40))
        self.Button_RecOffer.setObjectName("Button_RecOffer")
        self.Button_RecOffer.setToolTip("Reclamar Ofertas")
        self.Header.addWidget(self.Button_RecOffer)
        spacerItem12 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem12)
        self.Button_FutureProjects = QtWidgets.QPushButton(parent=self.frame)
        self.Button_FutureProjects.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_FutureProjects.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_FutureProjects.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_FutureProjects.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_FutureProjects.setText("")
        icon16 = QtGui.QIcon()
        icon16.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Future_Projects.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_FutureProjects.setIcon(icon16)
        self.Button_FutureProjects.setIconSize(QtCore.QSize(40, 40))
        self.Button_FutureProjects.setObjectName("Button_FutureProjects")
        self.Button_FutureProjects.setToolTip("Proyectos Futuros")
        self.Header.addWidget(self.Button_FutureProjects)
        spacerItem12 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem12)

        if self.name in ['Luis Bravo']:
            self.Button_ClockIn = QtWidgets.QPushButton(parent=self.frame)
            self.Button_ClockIn.setMinimumSize(QtCore.QSize(50, 50))
            self.Button_ClockIn.setMaximumSize(QtCore.QSize(50, 50))
            self.Button_ClockIn.setToolTip('Fichajes')
            self.Button_ClockIn.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            self.Button_ClockIn.setStyleSheet("QPushButton{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(3, 174, 236);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:hover{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:pressed{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(200, 200, 200);\n"
    "    border-radius: 10px;\n"
    "}")
            self.Button_ClockIn.setText("")
            icon17 = QtGui.QIcon()
            icon17.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "ClockIn.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            self.Button_ClockIn.setIcon(icon17)
            self.Button_ClockIn.setIconSize(QtCore.QSize(40, 40))
            self.Button_ClockIn.setObjectName("Button_ClockIn")
            self.Button_ClockIn.clicked.connect(self.clockin)
            self.Header.addWidget(self.Button_ClockIn)

        elif self.name in ['Ana Calvo']:
            self.Button_Users = QtWidgets.QPushButton(parent=self.frame)
            self.Button_Users.setMinimumSize(QtCore.QSize(50, 50))
            self.Button_Users.setMaximumSize(QtCore.QSize(50, 50))
            self.Button_Users.setToolTip('Gesti칩n Usuarios')
            self.Button_Users.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            self.Button_Users.setStyleSheet("QPushButton{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(3, 174, 236);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:hover{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:pressed{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(200, 200, 200);\n"
    "    border-radius: 10px;\n"
    "}")
            self.Button_Users.setText("")
            icon2 = QtGui.QIcon()
            icon2.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "User_Edit.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            self.Button_Users.setIcon(icon2)
            self.Button_Users.setIconSize(QtCore.QSize(40, 40))
            self.Button_Users.setObjectName("Button_Users")
            self.Header.addWidget(self.Button_Users)
            spacerItem16 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
            self.Header.addItem(spacerItem16)
            self.Button_Upload = QtWidgets.QPushButton(parent=self.frame)
            self.Button_Upload.setMinimumSize(QtCore.QSize(50, 50))
            self.Button_Upload.setMaximumSize(QtCore.QSize(50, 50))
            self.Button_Upload.setToolTip('Importar Ofertas/Pedidos')
            self.Button_Upload.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            self.Button_Upload.setStyleSheet("QPushButton{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(3, 174, 236);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:hover{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:pressed{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(200, 200, 200);\n"
    "    border-radius: 10px;\n"
    "}")
            self.Button_Upload.setText("")
            icon18 = QtGui.QIcon()
            icon18.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Upload_Arrow.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            self.Button_Upload.setIcon(icon18)
            self.Button_Upload.setIconSize(QtCore.QSize(40, 40))
            self.Button_Upload.setObjectName("Button_Upload")
            self.Header.addWidget(self.Button_Upload)
            spacerItem13 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
            self.Header.addItem(spacerItem13)
            self.Button_Reports = QtWidgets.QPushButton(parent=self.frame)
            self.Button_Reports.setMinimumSize(QtCore.QSize(50, 50))
            self.Button_Reports.setMaximumSize(QtCore.QSize(50, 50))
            self.Button_Reports.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
            self.Button_Reports.setStyleSheet("QPushButton{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(3, 174, 236);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:hover{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(255, 255, 255);\n"
    "    border-radius: 10px;\n"
    "}\n"
    "\n"
    "QPushButton:pressed{\n"
    "    border: 1px solid transparent;\n"
    "    border-color: rgb(0, 0, 0);\n"
    "    color: rgb(0,0,0);\n"
    "    background-color: rgb(200, 200, 200);\n"
    "    border-radius: 10px;\n"
    "}")
            self.Button_Reports.setText("")
            icon5 = QtGui.QIcon()
            icon5.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Reports.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            self.Button_Reports.setIcon(icon5)
            self.Button_Reports.setIconSize(QtCore.QSize(40, 40))
            self.Button_Reports.setObjectName("Button_Reports")
            self.Button_Reports.setToolTip("Informes")
            self.Header.addWidget(self.Button_Reports)

            self.Button_Users.clicked.connect(self.user_edition)
            self.Button_Upload.clicked.connect(self.upload_offer_order)
            self.Button_Reports.clicked.connect(self.generate_report)

        spacerItem2 = QtWidgets.QSpacerItem(40, 20, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem2)
        self.HeaderUserName = QtWidgets.QLabel(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.HeaderUserName.setFont(font)
        self.HeaderUserName.setStyleSheet("color:rgb(255, 255, 255)")
        self.HeaderUserName.setAlignment(QtCore.Qt.AlignmentFlag.AlignRight|QtCore.Qt.AlignmentFlag.AlignTrailing|QtCore.Qt.AlignmentFlag.AlignVCenter)
        self.HeaderUserName.setObjectName("HeaderUserName")
        self.Header.addWidget(self.HeaderUserName)
        self.HeaderName = QtWidgets.QLabel(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.HeaderName.setFont(font)
        self.HeaderName.setStyleSheet("color:rgb(3, 174, 236)")
        self.HeaderName.setAlignment(QtCore.Qt.AlignmentFlag.AlignRight|QtCore.Qt.AlignmentFlag.AlignTrailing|QtCore.Qt.AlignmentFlag.AlignVCenter)
        self.HeaderName.setObjectName("HeaderName")
        self.Header.addWidget(self.HeaderName)
        spacerItem3 = QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem3)
        self.Button_Notification = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Notification.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_Notification.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_Notification.setToolTip('Notificaciones')
        self.Button_Notification.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_Notification.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_Notification.setText("")
        self.Button_Notification.setIconSize(QtCore.QSize(40, 40))
        self.Button_Notification.setObjectName("Button_Notification")
        self.Header.addWidget(self.Button_Notification)
        spacerItem15 = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.Header.addItem(spacerItem15)
        self.Button_Profile = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Profile.setMinimumSize(QtCore.QSize(50, 50))
        self.Button_Profile.setMaximumSize(QtCore.QSize(50, 50))
        self.Button_Profile.setToolTip('Configuraci칩n')
        self.Button_Profile.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        self.Button_Profile.setStyleSheet("QPushButton{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.Button_Profile.setText("")
        icon13 = QtGui.QIcon()
        if self.name == 'Luis Bravo':
            icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Mando.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        elif self.name == 'Sandra Sanz':
            icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Bender.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        elif self.name == 'Carlos Crespo':
            icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Pikachu.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        elif self.name == 'Ana Calvo':
            icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Girl.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        else:
            icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "User.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_Profile.setIcon(icon13)
        self.Button_Profile.setIconSize(QtCore.QSize(40, 40))
        self.Button_Profile.setObjectName("Button_Profile")
        self.Header.addWidget(self.Button_Profile)
        self.FrameApp.addLayout(self.Header)
        spacerItem4 = QtWidgets.QSpacerItem(20, 5, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
        self.FrameApp.addItem(spacerItem4)
        self.PrincipalScreen = QtWidgets.QHBoxLayout()
        self.PrincipalScreen.setObjectName("PrincipalScreen")
        self.ButtonFrame = QtWidgets.QFrame(parent=self.frame)
        self.ButtonFrame.setMinimumSize(QtCore.QSize(220, 0))
        self.ButtonFrame.setMaximumSize(QtCore.QSize(220, 16777215))
        self.ButtonFrame.setAutoFillBackground(False)
        self.ButtonFrame.setStyleSheet("QFrame{\n"
"    background-color: rgb(3, 174, 236);\n"
"}\n"
"\n"
"QPushButton{\n"
"    border: 1px solid transparent;\n"
"    color: rgb(3, 174, 236);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:hover{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(255, 255, 255);\n"
"    border-radius: 10px;\n"
"}\n"
"\n"
"QPushButton:pressed{\n"
"    border: 1px solid transparent;\n"
"    border-color: rgb(0, 0, 0);\n"
"    color: rgb(0,0,0);\n"
"    background-color: rgb(200, 200, 200);\n"
"    border-radius: 10px;\n"
"}")
        self.ButtonFrame.setFrameShape(QtWidgets.QFrame.Shape.StyledPanel)
        self.ButtonFrame.setFrameShadow(QtWidgets.QFrame.Shadow.Raised)
        self.ButtonFrame.setObjectName("ButtonFrame")
        self.verticalLayout_3 = QtWidgets.QVBoxLayout(self.ButtonFrame)
        self.verticalLayout_3.setContentsMargins(9, 0, -1, 0)
        self.verticalLayout_3.setSpacing(25)
        self.verticalLayout_3.setObjectName("verticalLayout_3")
        self.Button_NewOffer = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_NewOffer.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_NewOffer.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_NewOffer.setFont(font)
        self.Button_NewOffer.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon3 = QtGui.QIcon()
        icon3.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Offer_New.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_NewOffer.setIcon(icon3)
        self.Button_NewOffer.setIconSize(QtCore.QSize(40, 40))
        self.Button_NewOffer.setCheckable(False)
        self.Button_NewOffer.setAutoRepeat(False)
        self.Button_NewOffer.setAutoExclusive(False)
        self.Button_NewOffer.setObjectName("Button_NewOffer")
        self.verticalLayout_3.addWidget(self.Button_NewOffer)
        self.Button_EditOffer = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_EditOffer.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_EditOffer.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_EditOffer.setFont(font)
        self.Button_EditOffer.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon4 = QtGui.QIcon()
        icon4.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Offer_Edit.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_EditOffer.setIcon(icon4)
        self.Button_EditOffer.setIconSize(QtCore.QSize(40, 40))
        self.Button_EditOffer.setObjectName("Button_EditOffer")
        self.verticalLayout_3.addWidget(self.Button_EditOffer)
        self.Button_QueryOffer = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_QueryOffer.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_QueryOffer.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_QueryOffer.setFont(font)
        self.Button_QueryOffer.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon5 = QtGui.QIcon()
        icon5.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Offer_Search.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_QueryOffer.setIcon(icon5)
        self.Button_QueryOffer.setIconSize(QtCore.QSize(40, 40))
        self.Button_QueryOffer.setObjectName("Button_QueryOffer")
        self.verticalLayout_3.addWidget(self.Button_QueryOffer)
        self.Button_NewOrder = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_NewOrder.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_NewOrder.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_NewOrder.setFont(font)
        self.Button_NewOrder.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon6 = QtGui.QIcon()
        icon6.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Order_New.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_NewOrder.setIcon(icon6)
        self.Button_NewOrder.setIconSize(QtCore.QSize(40, 40))
        self.Button_NewOrder.setObjectName("Button_NewOrder")
        self.verticalLayout_3.addWidget(self.Button_NewOrder)
        self.Button_EditOrder = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_EditOrder.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_EditOrder.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_EditOrder.setFont(font)
        self.Button_EditOrder.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon7 = QtGui.QIcon()
        icon7.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Order_Edit.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_EditOrder.setIcon(icon7)
        self.Button_EditOrder.setIconSize(QtCore.QSize(40, 40))
        self.Button_EditOrder.setObjectName("Button_EditOrder")
        self.verticalLayout_3.addWidget(self.Button_EditOrder)
        self.Button_QueryOrder = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_QueryOrder.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_QueryOrder.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_QueryOrder.setFont(font)
        self.Button_QueryOrder.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon8 = QtGui.QIcon()
        icon8.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Order_Search.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_QueryOrder.setIcon(icon8)
        self.Button_QueryOrder.setIconSize(QtCore.QSize(40, 40))
        self.Button_QueryOrder.setObjectName("Button_QueryOrder")
        self.verticalLayout_3.addWidget(self.Button_QueryOrder)
        self.Button_NewTag = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_NewTag.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_NewTag.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_NewTag.setFont(font)
        self.Button_NewTag.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon9 = QtGui.QIcon()
        icon9.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "TAG_New.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_NewTag.setIcon(icon9)
        self.Button_NewTag.setIconSize(QtCore.QSize(40, 40))
        self.Button_NewTag.setObjectName("Button_NewTag")
        self.verticalLayout_3.addWidget(self.Button_NewTag)
        self.Button_EditTag = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_EditTag.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_EditTag.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_EditTag.setFont(font)
        self.Button_EditTag.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon10 = QtGui.QIcon()
        icon10.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "TAG_Edit.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_EditTag.setIcon(icon10)
        self.Button_EditTag.setIconSize(QtCore.QSize(40, 40))
        self.Button_EditTag.setObjectName("Button_EditTag")
        self.verticalLayout_3.addWidget(self.Button_EditTag)
        self.Button_QueryTag = QtWidgets.QPushButton(parent=self.ButtonFrame)
        self.Button_QueryTag.setMinimumSize(QtCore.QSize(200, 50))
        self.Button_QueryTag.setMaximumSize(QtCore.QSize(200, 50))
        font = QtGui.QFont()
        font.setPointSize(12)
        font.setBold(True)
        self.Button_QueryTag.setFont(font)
        self.Button_QueryTag.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.PointingHandCursor))
        icon11 = QtGui.QIcon()
        icon11.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "TAG_Search.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.Button_QueryTag.setIcon(icon11)
        self.Button_QueryTag.setIconSize(QtCore.QSize(40, 40))
        self.Button_QueryTag.setObjectName("Button_QueryTag")
        self.verticalLayout_3.addWidget(self.Button_QueryTag)
        self.PrincipalScreen.addWidget(self.ButtonFrame)
        spacerItem5 = QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.PrincipalScreen.addItem(spacerItem5)
        self.MainLayout = QtWidgets.QVBoxLayout()
        self.MainLayout.setObjectName("MainLayout")
        self.tableOffer = QtWidgets.QTableWidget(parent=self.frame)
        self.tableOffer.setMinimumSize(QtCore.QSize(650, 280))
        self.tableOffer.setObjectName("tableOffer")
        self.tableOffer.setColumnCount(0)
        self.tableOffer.setRowCount(0)
        self.tableOffer.verticalHeader().setVisible(False)
        self.tableOffer.setSortingEnabled(False)
        self.tableOffer.horizontalHeader().setStyleSheet("QHeaderView::section {background-color: #33bdef; border: 1px solid black;}")
        self.MainLayout.addWidget(self.tableOffer)
        spacerItem6 = QtWidgets.QSpacerItem(20, 5, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
        self.MainLayout.addItem(spacerItem6)
        self.BottomLayout = QtWidgets.QGridLayout()
        self.BottomLayout.setContentsMargins(-1, 0, -1, -1)
        self.BottomLayout.setObjectName("BottomLayout")
        # spacerItem8 = QtWidgets.QSpacerItem(15, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        # self.BottomLayout.addItem(spacerItem8)
        self.Calendar = ImageCalendarWidget(parent=self.frame)
        self.Calendar.setEnabled(True)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Preferred)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.Calendar.sizePolicy().hasHeightForWidth())
        self.Calendar.setSizePolicy(sizePolicy)
        self.Calendar.setMinimumSize(QtCore.QSize(300, 400))
        self.Calendar.setMaximumSize(QtCore.QSize(583, 400))
        self.Calendar.setCursor(QtGui.QCursor(QtCore.Qt.CursorShape.ArrowCursor))
        self.Calendar.setStyleSheet("QCalendarWidget QWidget{\n"
"background-color: rgb(3, 174, 236);\n"
"}\n"
"\n"
"QCalendarWidget QTableView{\n"
"    background-color: white;\n"
"}\n"
"\n"
"QCalendarWidget QToolButton {\n"
"    color: white;\n"
"    font-size:20px;\n"
"    icon-size:30px 30px;\n"
"    background-color:rgb(3, 174, 236);\n"
"}\n"
"\n"
"QCalendarWidget QToolButton::hover {\n"
"    background-color : #019ad2;\n"
"}\n"
"\n"
"QCalendarWidget QToolButton::pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border: 3px solid;\n"
"    border-color: rgb(255, 255, 255);\n"
"}\n"
"\n"
"QCalendarWidget QSpinBox{\n"
"    background-color: rgb(255, 255, 255);\n"
"    border: 2px solid;\n"
"    border-color: rgb(3,174, 236);\n"
"}\n"
"\n"
"QCalendarWidget QAbstractItemView:enabled{\n"
"    selection-background-color: rgb(3, 174, 236);\n"
"    selection-color: white;\n"
"}\n"
"\n"
"#qt_calendar_prevmonth {\n"
"    qproperty-icon: url(//ERP-EIPSA-DATOS/DATOS/Comunes/EIPSA-ERP/Resources/Iconos/back_arrow.png);\n"
"}\n"
"#qt_calendar_nextmonth {\n"
"    qproperty-icon: url(//ERP-EIPSA-DATOS/DATOS/Comunes/EIPSA-ERP/Resources/Iconos/forward_arrow.png);\n"
"\n"
"}")
        self.Calendar.setSelectedDate(QtCore.QDate.currentDate())
        self.Calendar.setGridVisible(True)
        self.Calendar.setNavigationBarVisible(True)
        self.Calendar.setDateEditEnabled(True)
        self.Calendar.setObjectName("Calendar")
        self.Calendar.setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)
        self.BottomLayout.addWidget(self.Calendar, 0, 2, 1, 1)
        self.MainLayout.addLayout(self.BottomLayout)
        self.PrincipalScreen.addLayout(self.MainLayout)
        self.FrameApp.addLayout(self.PrincipalScreen)
        self.gridLayout.addLayout(self.FrameApp, 3, 0, 1, 1)
        self.gridLayout_2.addWidget(self.frame, 0, 0, 1, 1)
        App_Comercial.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(parent=App_Comercial)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 945, 22))
        self.menubar.setObjectName("menubar")
        App_Comercial.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(parent=App_Comercial)
        self.statusbar.setObjectName("statusbar")
        App_Comercial.setStatusBar(self.statusbar)
        self.tableOffer.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeMode.Stretch)

        self.retranslateUi(App_Comercial)
        QtCore.QMetaObject.connectSlotsByName(App_Comercial)

        self.Button_NewOffer.clicked.connect(self.new_offer)
        self.Button_EditOffer.clicked.connect(self.edit_offer)
        self.Button_QueryOffer.clicked.connect(self.query_offer)
        self.Button_NewOrder.clicked.connect(self.new_order)
        self.Button_EditOrder.clicked.connect(self.edit_order)
        self.Button_QueryOrder.clicked.connect(self.query_order)
        self.Button_NewTag.clicked.connect(self.new_tag)
        self.Button_EditTag.clicked.connect(self.edit_tag)
        self.Button_QueryTag.clicked.connect(self.query_tag)
        self.Button_ExpOffer.clicked.connect(self.export_menu)
        self.Button_Doc.clicked.connect(self.query_documents)
        self.Button_Graphs.clicked.connect(self.stats_offers)
        self.Button_ClientsResume.clicked.connect(self.clients_generalresume)
        self.Button_QueryTask.clicked.connect(self.querytask)
        self.Button_RecOffer.clicked.connect(self.reclamation_offer)
        self.Button_FutureProjects.clicked.connect(self.future_projects)
        self.Button_Profile.clicked.connect(self.showMenu)
        self.tableOffer.itemDoubleClicked.connect(self.on_item_double_clicked)
        self.Calendar.activated.connect(self.show_selected_date_tasks)
        self.Calendar.customContextMenuRequested.connect(self.show_context_menu)
        self.Button_Notification.clicked.connect(self.notifications)

        self.setup_task_dates()

        self.update_principal_screen()

        self.alert_offers()
        self.alert_reclamation_offers()

        self.load_notifications()


    def show_context_menu(self, point):
        """
        Displays a context menu at the specified point in the calendar widget. 
        Provides options to add or edit tasks for the selected date.
        
        Args:
            point (QPoint): The location where the context menu will appear.
        """
        selected_date = self.Calendar.selectedDate()
        menu = QMenu(self.centralwidget)
        menu.setStyleSheet("QMenu { border: 1px solid black; width: 150px; right: -1px; }"
        "QMenu::item:selected { background-color: rgb(3, 174, 236); color: white; }")

        action1 = menu.addAction("Agregar tareas")
        action1.triggered.connect(lambda: self.newtask(selected_date))
        action2 = menu.addAction("Editar tareas")
        action2.triggered.connect(lambda: self.querytask(selected_date))

        menu.exec(self.Calendar.mapToGlobal(point))

# Function to translate and updates the text of various UI elements
    def retranslateUi(self, App_Comercial):
        """
        Translates and updates the text of various UI elements in the given App_Comercial.
        """
        _translate = QtCore.QCoreApplication.translate
        App_Comercial.setWindowTitle(_translate("App_Comercial", "ERP EIPSA - Comercial"))
        self.HeaderName.setText(_translate("App_Comercial", self.name))
        self.HeaderUserName.setText(_translate("App_Comercial", self.username))
        self.Button_NewOffer.setText(_translate("App_Comercial", "    Nueva Oferta"))
        self.Button_EditOffer.setText(_translate("App_Comercial", "    Editar Oferta"))
        self.Button_QueryOffer.setText(_translate("App_Comercial", "    Consultar Ofertas"))
        self.Button_NewOrder.setText(_translate("App_Comercial", "    Nuevo Pedido"))
        self.Button_EditOrder.setText(_translate("App_Comercial", "    Editar Pedido"))
        self.Button_QueryOrder.setText(_translate("App_Comercial", "   Consultar Pedidos"))
        self.Button_NewTag.setText(_translate("App_Comercial", "    Nuevo(s) TAG(s)"))
        self.Button_EditTag.setText(_translate("App_Comercial", "    Editar TAG(s)"))
        self.Button_QueryTag.setText(_translate("App_Comercial", "    Consultar TAG(s)"))
        self.tableOffer.setSortingEnabled(True)
        __sortingEnabled = self.tableOffer.isSortingEnabled()
        self.tableOffer.setSortingEnabled(False)
        self.tableOffer.setSortingEnabled(__sortingEnabled)

# Function to open window for create offers
    def new_offer(self):
        """
        Opens a new window for creating a new offer in the application. 
        """
        # from OfferNew_Menu import Ui_NewOffer_Menu
        # self.new_offer_menu=QtWidgets.QMainWindow()
        # self.ui=Ui_NewOffer_Menu(self.username)
        # self.ui.setupUi(self.new_offer_menu)
        # self.new_offer_menu.show()
        # self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

        from OfferNew_Window import Ui_New_Offer_Window
        self.projectoffer_window=QtWidgets.QMainWindow()
        self.ui=Ui_New_Offer_Window(self.username)
        self.ui.setupUi(self.projectoffer_window)
        self.projectoffer_window.show()
        self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

# Function to open window for edit offers
    def edit_offer(self):
        """
        Opens a new window for editing an existing offer. 
        """
        from OfferEdit_Menu import Ui_EditOffer_Menu
        self.edit_offer_menu=QtWidgets.QMainWindow()
        self.ui=Ui_EditOffer_Menu(self.username)
        self.ui.setupUi(self.edit_offer_menu)
        self.edit_offer_menu.show()
        self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

# Function to open window for query offers
    def query_offer(self):
        """
        Opens a new window for querying offers. 
        """
        from OfferQuery_Window import Ui_QueryOffer_Window
        self.query_offer_window=Ui_QueryOffer_Window(self.username)
        self.query_offer_window.show()

# Function to open window for create orders
    def new_order(self):
        """
        Opens a new window for creating a new order. 
        """
        from OrderNewAddData_Window import Ui_New_OrderAddData_Window
        self.new_orderAddData_window=QtWidgets.QMainWindow()
        self.ui=Ui_New_OrderAddData_Window()
        self.ui.setupUi(self.new_orderAddData_window)
        self.new_orderAddData_window.show()
        self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

# Function to open window for edit orders
    def edit_order(self):
        """
        Opens a new window for editing an existing order. 
        """
        from OrderEdit_Menu import Ui_EditOrder_Menu
        self.edit_order_window=QtWidgets.QMainWindow()
        self.ui=Ui_EditOrder_Menu()
        self.ui.setupUi(self.edit_order_window)
        self.edit_order_window.show()
        self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

# Function to open window for query orders
    def query_order(self):
        """
        Opens a new window for querying orders. 
        """
        from OrderQuery_Window import Ui_QueryOrder_Window
        self.query_order_window=Ui_QueryOrder_Window()
        self.query_order_window.show()

# Function to open window for create tags
    def new_tag(self):
        """
        Opens a new window for creating new tags. 
        """
        from TAGCreate_Menu import Ui_CreateTag_Menu
        self.new_tag_window=QtWidgets.QMainWindow()
        self.ui=Ui_CreateTag_Menu()
        self.ui.setupUi(self.new_tag_window)
        self.new_tag_window.show()

# Function to open window for edit tags
    def edit_tag(self):
        """
        Opens a new menu for different types of editing existing tags. 
        """
        from TAGEdit_Menu import Ui_EditTags_Menu
        self.edittags_menu=QtWidgets.QMainWindow()
        self.ui=Ui_EditTags_Menu()
        self.ui.setupUi(self.edittags_menu)
        self.edittags_menu.show()

# Function to open window for query tags
    def query_tag(self):
        """
        Opens a new window for querying tags. 
        """
        from TAGQuery_Menu import Ui_TAGQuery_Menu
        self.querytag_window=QtWidgets.QMainWindow()
        self.ui=Ui_TAGQuery_Menu('Comercial')
        self.ui.setupUi(self.querytag_window)
        self.querytag_window.show()

# Function to open menu for export documents
    def export_menu(self):
        """
        Opens a new window for exporting documents. 
        """
        self.exportdocs_menu=QtWidgets.QMainWindow()
        self.ui=Ui_ExportDocs_Menu(self.username)
        self.ui.setupUi(self.exportdocs_menu)
        self.exportdocs_menu.show()

# Function to open window for query documents
    def query_documents(self):
        """
        Opens a new window for querying documents. 
        """
        from DocQuery_Window import Ui_QueryDoc_Window
        self.querydoc_menu=Ui_QueryDoc_Window()
        self.querydoc_menu.show()

# Function to open menu of offer statistics
    def stats_offers(self):
        """
        Opens a new window for viewing offer statistics. 
        """
        from OfferStats_Menu import Ui_StatsOffer_Menu
        self.statswindow=QtWidgets.QMainWindow()
        self.ui=Ui_StatsOffer_Menu()
        self.ui.setupUi(self.statswindow)
        self.statswindow.show()

# Function to open window with clients data resume
    def clients_generalresume(self):
        """
        Opens a new window to display a general resume of client data. 
        """
        from ClientsGeneralResume_Window import Ui_ClientsGeneralResume_Window
        self.clients_general_resume_window=QtWidgets.QMainWindow()
        self.ui=Ui_ClientsGeneralResume_Window()
        self.ui.setupUi(self.clients_general_resume_window)
        self.clients_general_resume_window.show()

# Function to open window for query tasks
    def querytask(self, date=None):
        """
        Opens a new window for querying tasks. 
        
        Args:
            date (QDate, optional): The date to filter tasks. Defaults to None.
        """
        from TaskQuery_Window import Ui_QueryTask_Window
        self.querytaskwindow=Ui_QueryTask_Window(self.name, date)
        self.querytaskwindow.show()
        self.querytaskwindow.Button_Cancel.clicked.connect(self.setup_task_dates)

# Function to open window for create a new task
    def newtask(self, date):
        """
        Opens a new window for creating a new task. 
        
        Args:
            date (QDate): The date associated with the new task.
        """
        from TaskAdd_Window import Ui_AddTask_Window
        self.newtaskwindow=QtWidgets.QMainWindow()
        self.ui=Ui_AddTask_Window(self.name, date)
        self.ui.setupUi(self.newtaskwindow)
        self.newtaskwindow.show()
        self.ui.Button_Cancel.clicked.connect(self.setup_task_dates)

# Function to show menu when profile button is clicked
    def showMenu(self):
        """
        Displays a context menu when the profile button is clicked. 
        Provides options to edit the password.
        """
        menu = QMenu(self.centralwidget)
        menu.setStyleSheet("QMenu { border: 1px solid black; width: 125px; right: -1px; }"
        "QMenu::item:selected { background-color: rgb(3, 174, 236); color: white; }")
        option1 = menu.addAction("Editar contrase침a")
        option1.triggered.connect(lambda: self.editpassword())
        menu.addAction(option1)
        button = self.Button_Profile
        menu.exec(button.mapToGlobal(QtCore.QPoint(-75, 50)))

# Function to open window for password edition
    def editpassword(self):
        """
        Opens a new window for editing the user's password. 
        """
        from PasswordEdit_Window import Ui_EditPasswordWindow
        self.edit_password_window=QtWidgets.QMainWindow()
        self.ui=Ui_EditPasswordWindow(self.username)
        self.ui.setupUi(self.edit_password_window)
        self.edit_password_window.show()

# Function to open window for user edition
    def user_edition(self):
        """
        Opens a new window for editing user details. 
        """
        from UserEdit_Menu import Ui_EditUser_Menu
        self.edit_user_menu=QtWidgets.QMainWindow()
        self.ui=Ui_EditUser_Menu()
        self.ui.setupUi(self.edit_user_menu)
        self.edit_user_menu.show()

# Function to open window to show active notifications
    def notifications(self):
        """
        Opens a new window to show active notifications. 
        """
        from NotificationsHistory_Window import Ui_HistoryNotifications_Window
        self.notification_window=Ui_HistoryNotifications_Window(self.username)
        self.notification_window.show()
        self.notification_window.Button_Cancel.clicked.connect(self.load_notifications)

# Function to update table and graphs at the same time
    def update_principal_screen(self):
        """
        Updates the main screen by reloading the table data and updating the graphs.
        """
        self.load_table()
        self.load_graphs()

# Function to load values on graphs
    def load_graphs(self):
        """
        Loads and displays graphs for the current year's sales data and product type proportions.
        Handles errors with a message box and updates the UI with the graphs.
        """
        try:
            commands_responsible = ("""
                        SELECT *
                        FROM users_data.initials
                        """)

            commands_graph1 = ("""
                        SELECT orders."order_month", CAST(SUM(orders."order_amount") AS numeric)
                        FROM offers
                        INNER JOIN orders ON (offers."num_offer"=orders."num_offer")
                        WHERE (offers."responsible"=%s
                        AND
                        orders."order_year"=%s
                        )
                        GROUP BY orders."order_month"
                        ORDER BY orders."order_month"
                        """)

            commands_graph2 = ("""
                        SELECT COUNT(orders."num_order"), product_type."variable"
                        FROM offers
                        INNER JOIN orders ON (offers."num_offer"=orders."num_offer")
                        INNER JOIN product_type ON (offers."material"=product_type."material")
                        WHERE (offers."responsible"=%s
                        AND
                        "order_year"=%s
                        )
                        GROUP BY product_type."variable"
                        """)

            try:
                with Database_Connection(config()) as conn:
                    with conn.cursor() as cur:
                    # execution of commands
                        cur.execute(commands_responsible)
                        results_responsible=cur.fetchall()

                        match=list(filter(lambda x:self.username in x, results_responsible))
                        responsible=match[0][0]

                        data=(responsible, date.today().year,)
                        cur.execute(commands_graph1, data)
                        results_graph1=cur.fetchall()

                        cur.execute(commands_graph2, data)
                        results_graph2=cur.fetchall()

                    months=[int(x[0]) for x in results_graph1]
                    amounts=[float(x[1]) for x in results_graph1]

                    self.canvas=FigureCanvas(Figure())
                    ax=self.canvas.figure.subplots()
                    ax.bar(months,amounts)
                    ax.set_xticks(range(1,13))
                    axticks_y=ticker.FuncFormatter(self.format_y_ticks)
                    ax.yaxis.set_major_formatter(axticks_y)
                    ax.set_title('Ventas totales a침o actual')
                    ax.set_xlabel('Mes')
                    ax.set_ylabel('Importe ()')

                    self.canvas.setMinimumSize(QtCore.QSize(200, 400))
                    self.canvas.setMaximumSize(QtCore.QSize(585, 400))

                    self.canvas.setObjectName("Graph1")
                    self.BottomLayout.addWidget(self.canvas, 0, 0, 1, 1)

                    count=[x[0] for x in results_graph2]
                    labels=[x[1] for x in results_graph2]

                    self.canvas2=FigureCanvas(Figure())
                    bx=self.canvas2.figure.subplots()
                    bx.pie(count,labels=labels,autopct='%1.1f%%')
                    bx.set_title('Proporci칩n equipos vendidos')

                    self.canvas2.setMinimumSize(QtCore.QSize(200, 400))
                    self.canvas2.setMaximumSize(QtCore.QSize(585, 400))
                    self.canvas2.setObjectName("canvas2")
                    self.BottomLayout.addWidget(self.canvas2, 0, 1, 1, 1)

            except (Exception, psycopg2.DatabaseError) as error:
                MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                            + str(error),'critical')

        except:
            pass

# Function to load values on table
    def load_table(self):
        """
        Loads and displays offer data in a table widget.
        Handles errors with a message box and updates the table widget with the data.
        """
        self.tableOffer.setRowCount(0)

        commands_responsible = ("""
                        SELECT *
                        FROM users_data.initials
                        """)

        commands_appcomercial = ("""
                    SELECT "num_offer","state","client","final_client",TO_CHAR("presentation_date", 'DD-MM-YYYY'),"material","offer_amount","probability",
                    "notes","important","tracking","actions"
                    FROM offers
                    WHERE ("responsible" = %s AND "state" in ('Presentada', 'Registrada', 'En Estudio'))
                    ORDER BY "num_offer"
                    """)
        
        commands_appcomercial_lb = ("""
                    SELECT "num_offer", "responsible", "state","client","final_client",TO_CHAR("presentation_date", 'DD-MM-YYYY'),"material","offer_amount","probability",
                    "notes","important","tracking","actions"
                    FROM offers
                    WHERE ("responsible" in (%s, 'c.crespo') AND "state" in ('Presentada', 'Registrada', 'En Estudio'))
                    ORDER BY "num_offer"
                    """)

        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands
                    cur.execute(commands_responsible)
                    results_responsible=cur.fetchall()
                    match=list(filter(lambda x:self.username in x, results_responsible))
                    responsible=match[0][0]

                    if self.username == 'l.bravo':
                        cur.execute(commands_appcomercial_lb,(responsible,))
                        results=cur.fetchall()
                        number_columns = 13
                        headers = ["N췈 Oferta","Responsable", "Estado","Cliente","Cl. Final / Planta","Fecha Pres.","Material","Importe","Prob. Adj.","Notas","Ptos. Importantes","Seguimiento","Acciones"]
                    else:
                        cur.execute(commands_appcomercial,(responsible,))
                        results=cur.fetchall()
                        number_columns = 12
                        headers = ["N췈 Oferta","Estado","Cliente","Cl. Final / Planta","Fecha Pres.","Material","Importe","Prob. Adj.","Notas","Ptos. Importantes","Seguimiento","Acciones"]

                self.tableOffer.setColumnCount(number_columns)
                self.tableOffer.setRowCount(len(results))
                tablerow=0

            # fill the Qt Table with the query results
                for row in results:
                    for column in range(number_columns):
                        value = row[column]
                        if value is None:
                            value = ''
                        it = QtWidgets.QTableWidgetItem(str(value))
                        it.setFlags(it.flags() & ~QtCore.Qt.ItemFlag.ItemIsEditable)
                        self.tableOffer.setItem(tablerow, column, it)

                    tablerow+=1

                self.tableOffer.setHorizontalHeaderLabels(headers)
                self.tableOffer.horizontalHeader().setStyleSheet("QHeaderView::section {background-color: #33bdef; border: 1px solid black; font-weight: bold; font-size: 10pt;}")
                self.tableOffer.verticalHeader().hide()
                self.tableOffer.setItemDelegate(AlignDelegate(self.tableOffer))

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

        self.tableOffer.setSortingEnabled(False)

# Function to stablish dates with task assigned to put icon on calendar
    def setup_task_dates(self):
        """
        Sets up task dates for the calendar widget.
        Handles errors with a message box and updates the calendar with task dates.
        """
        commands_loaddatestasks = ("""
                    SELECT "task_date","task"
                    FROM tasks
                    WHERE ("responsible" = %s
                    AND
                    "state" = 'Pendiente')
                    ORDER BY "task_date"
                    """)
        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands
                    cur.execute(commands_loaddatestasks,(self.name,))
                    results=cur.fetchall()

                dates_with_tasks_raw=[x[0] for x in results]
                dates_with_tasks=list(set(dates_with_tasks_raw))

                task_dates = dates_with_tasks
                self.Calendar.set_task_dates(task_dates)

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

# Function to show task of the selected date
    def show_selected_date_tasks(self):
        """
        Displays tasks for the selected date in a message box.
        Handles errors with a message box.
        """
        self.click_count = 0
        selected_date = self.Calendar.selectedDate()
        if self.name == 'Carlos Crespo':
            creator=self.name[0] + self.name[self.name.find(' ')+1] + 'H'
        else:
            creator=self.name[0] + self.name[self.name.find(' ')+1]
        returned = self.get_tasks_for_date(creator, selected_date)

        if returned:
            dlg = QtWidgets.QMessageBox()
            new_icon = QtGui.QIcon()
            new_icon.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "icon.ico"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            dlg.setWindowIcon(new_icon)
            dlg.setWindowTitle("ERP EIPSA")
            final_text=''

            for item in returned:
                responsible = item[0]
                tasks = item [1]
                task_text = "<br><br>-".join(tasks)
                final_text += "<br><br>" + f"<b>{responsible}:</b><br>-" + task_text

            dlg.setText(f"<html><body>Tareas para la fecha {selected_date.toString('dd-MM-yyyy')}:{final_text}</body></html>")
            dlg.setIcon(QtWidgets.QMessageBox.Icon.Information)
            dlg.exec()
            del dlg, new_icon

#Function to obtain tasks associated to a date
    def get_tasks_for_date(self, creator, date):
        """
        Retrieves tasks for a specific date.
        
        Args:
            creator (str): The creator or responsible person for the tasks.
            date (QDate): The date for which tasks are being retrieved.
        
        Returns:
            list: A list of tasks for the specified date.
        """
        commands_loaddatestasks = ("""
                    SELECT "responsible","task_date","task","state","creator"
                    FROM tasks
                    WHERE ("responsible" = %s
                    AND
                    "task_date" IS NOT NULL
                    AND
                    "state" = 'Pendiente')
                    ORDER BY "task_date"
                    """)

        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands
                    cur.execute(commands_loaddatestasks,(self.name,))
                    results=cur.fetchall()

                dict_responsibles_tasks={}

                for i in range(len(results)):
                    responsible=results[i][0]
                    key=QtCore.QDate(results[i][1].year, results[i][1].month, results[i][1].day)
                    value="(" + results[i][4]+") " + results[i][2] + " (" + results[i][3] + ")"

                    if responsible not in dict_responsibles_tasks:
                        dict_responsibles_tasks[responsible] = [{key: [value]}]

                    else:
                        for item in dict_responsibles_tasks[responsible]:
                            if key not in item:
                                item[key] = [value]

                            else:
                                item[key].append(value)

                value_to_return = []
                for item in dict_responsibles_tasks.keys():
                    for element in dict_responsibles_tasks[item]:
                        if date in element:
                            value_to_return.append([item,dict_responsibles_tasks[item][dict_responsibles_tasks[item].index(element)][date]])

                return value_to_return

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

#Function to show dialog showing delayed offers
    def alert_offers(self):
        """
        Shows a message box with delayed offers.
        Handles errors with a message box.
        """
        delay_date=QtCore.QDate.currentDate().addDays(-10)

        commands_responsible = ("""
                        SELECT *
                        FROM users_data.initials
                        """)
        commands_offerdelay = ("""
                    SELECT "num_offer"
                    FROM offers
                    WHERE ("responsible" = %s
                    AND
                    "state" = 'Presentada'
                    AND
                    "presentation_date" < %s::date )
                    ORDER BY "num_offer"
                    """)
        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands
                    cur.execute(commands_responsible)
                    results_responsible=cur.fetchall()
                    match=list(filter(lambda x:self.username in x, results_responsible))
                    responsible=match[0][0]

                    cur.execute(commands_offerdelay,(responsible,delay_date.toString(QtCore.Qt.DateFormat.ISODate),))
                    results=cur.fetchall()

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

        offers_delay=[x[0] for x in results]

        if len(offers_delay) != 0:
            offers_delay_text = "\n".join(offers_delay)
            MessageHelper.show_message("Las siguientes ofertas llevan presentadas m치s de 10 d칤as:\n"
                        "\n"
                        + offers_delay_text, 'information')

#Function to formatting y axis of graps
    def format_y_ticks(self, y, pos):
        """
        Formats y-axis ticks for graphs.
        
        Args:
            y (float): The y-axis value to format.
            pos (int): The tick position (not used).
        
        Returns:
            str: The formatted y-axis value.
        """
        if y >= 1e6:
            return '{:.1f}M'.format(y * 1e-6)
        elif y >= 1e3:
            return '{:.1f}k'.format(y * 1e-3)
        else:
            return '{:d}'.format(int(y))

# Function to check if column index of double clicked cell is equal to first column index
    def on_item_double_clicked(self, item):
        """
        Handles double-click events on items in a QTableWidget. Opens different forms based on the column of the clicked item.
        
        Args:
            item (QtWidgets.QTableWidgetItem): The item that was double-clicked.
        """
        if item.column() == 2:
            self.clientresume(item)
        elif item.column() == 0:
            self.editofferform(item)
        elif item.column() in [8, 9, 10, 11]:
            cell_content = item.text()
            dlg = QtWidgets.QMessageBox()
            new_icon = QtGui.QIcon()
            new_icon.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "icon.ico"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            dlg.setWindowIcon(new_icon)
            dlg.setWindowTitle("Ofertas")
            dlg.setText(cell_content)
            dlg.exec()

# Function when double clicked cell is in client column
    def clientresume(self, item):
        """
        Opens the client resume window for the client whose name is displayed in the clicked item.

        Args:
            item (QtWidgets.QTableWidgetItem): The item containing the client name.
        """
        from ClientResume_Window import Ui_ClientResume_Window
        clientname=item.text()
        self.client_resume_window=QtWidgets.QMainWindow()
        self.ui=Ui_ClientResume_Window(clientname)
        self.ui.setupUi(self.client_resume_window)
        self.client_resume_window.show()

# Function when double clicked cell is in client column
    def editofferform(self, item):
        """
        Opens the offer edit form for the offer number displayed in the clicked item.
        
        Args:
            item (QtWidgets.QTableWidgetItem): The item containing the offer number.
        """
        from OfferEdit_Window import Ui_Edit_Offer_Window
        num_offer=item.text()
        self.edit_offer_window=QtWidgets.QMainWindow()
        self.ui=Ui_Edit_Offer_Window(self.username, num_offer)
        self.ui.setupUi(self.edit_offer_window)
        self.edit_offer_window.show()
        self.ui.Button_Cancel.clicked.connect(self.update_principal_screen)

# Function to open reclamation window
    def reclamation_offer(self):
        """
        Opens the reclamation window to handle offers that need reclamation.
        """
        from OfferReclamation_Window import Ui_ReclamationOffer_Window
        self.reclamationoffer_window=QtWidgets.QMainWindow()
        self.ui=Ui_ReclamationOffer_Window(self.name, self.username)
        self.ui.setupUi(self.reclamationoffer_window)
        self.reclamationoffer_window.show()

# Function to show pop-up with offers to reclaim
    def alert_reclamation_offers(self):
        """
        Shows a pop-up alerting the user if there are offers to reclaim that are overdue.
        """

        commands_responsible = ("""
                        SELECT *
                        FROM users_data.initials
                        """)
        commands_queryrecoffer = ("""
                        SELECT offers."num_offer",TO_CHAR(offers."presentation_date", 'DD-MM-YYYY'),TO_CHAR(offers."last_update", 'DD-MM-YYYY'),
                        (offers."last_update" - offers."presentation_date") AS "difference_in_days"
                        FROM offers
                        WHERE (offers."responsible" = %s
                        AND
                        offers."state" = 'Presentada'
                        AND
                        offers."last_update" < (current_date - interval '10 days')
                        )
                        ORDER BY offers."num_offer"
                        """)

        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands one by one
                    cur.execute(commands_responsible)
                    results_responsible=cur.fetchall()
                    match=list(filter(lambda x:self.username in x, results_responsible))
                    responsible=match[0][0]

                    cur.execute(commands_queryrecoffer, (responsible,))
                    results=cur.fetchall()

                offers_rec_delay=[x[0] for x in results]

                if len(offers_rec_delay) != 0:
                    dlg = QtWidgets.QMessageBox()
                    new_icon = QtGui.QIcon()
                    new_icon.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "icon.ico"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
                    dlg.setWindowIcon(new_icon)
                    dlg.setWindowTitle("ERP EIPSA")
                    dlg.setText("Hay " + str(len(offers_rec_delay)) + " ofertas para reclamar\n"
                                "쯈uieres reclamarlas ahora?\n")
                    dlg.setIcon(QtWidgets.QMessageBox.Icon.Information)
                    dlg.setStandardButtons(QtWidgets.QMessageBox.StandardButton.Yes | QtWidgets.QMessageBox.StandardButton.No)
                    result = dlg.exec()
                    if result == QtWidgets.QMessageBox.StandardButton.Yes:
                        self.reclamation_offer()
                    del dlg, new_icon

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

# Function to load number of notifications
    def load_notifications(self):
        """
        Loads and displays notifications for the user from various tables in the 'notifications' schema.
        """
        query_tables_notifications = """SELECT table_name
                                FROM information_schema.tables
                                WHERE table_schema = 'notifications' AND table_type = 'BASE TABLE';"""

        try:
            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:
                # execution of commands
                    cur.execute(query_tables_notifications)
                    results=cur.fetchall()
                    tables_names=[x[0] for x in results]

                    notifications = []

                    for table in tables_names:
                        commands_notifications = f" SELECT * FROM notifications.{table} WHERE username = '{self.username}' and state = 'Pendiente'"
                        cur.execute(commands_notifications)
                        results=cur.fetchall()

                        for x in results:
                            notifications.append(x)

                    if len(notifications) != 0:
                        icon13 = QtGui.QIcon()
                        icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Notif_on.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
                    else:
                        icon13 = QtGui.QIcon()
                        icon13.addPixmap(QtGui.QPixmap(str(get_path("Resources", "Iconos", "Notif_off.png"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
                    self.Button_Notification.setIcon(icon13)

        except (Exception, psycopg2.DatabaseError) as error:
            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                        + str(error), 'critical')

# Function to open window with clock-ins
    def clockin(self):
        """
        Opens the clock-in window where the user can manage their clock-ins.
        """
        from ClockIn_Window import MyCalendarApp
        self.clockin_window = MyCalendarApp(self.username)
        self.clockin_window.showMaximized()

# Function to upload excel file with offer or order information
    def upload_offer_order(self):
        """
        Uploads offer or order information from an Excel file and inserts it into the corresponding database table.
        """
        while True:
            item, ok = QtWidgets.QInputDialog.getItem(self, "Cargar Info", "Selecciona que quieres cargar:", ['Ofertas', 'Pedidos'], 0, False)
            if ok and item:
                item_type = item
                if item_type != '':
                    if item_type == 'Ofertas':
                        table_name = "offers"
                    elif item_type == 'Pedidos':
                        table_name = "orders"

                    fname = askopenfilename(filetypes=[("Archivos de Excel", "*.xlsx")],
                            title="Seleccionar archivo Excel")

                    if fname:
                    #Importing excel file into dataframe
                        df_table = pd.read_excel(fname, na_values=['N/A'], keep_default_na=False)
                        df_table = df_table.astype(str)
                        df_table.replace('nan', 'N/A', inplace=True)

                        try:
                            with Database_Connection(config()) as conn:
                                with conn.cursor() as cur:
                    # Loop through each row of the DataFrame and insert the data into the table
                                    for index, row in df_table.iterrows():
                                        # Create a list of pairs (column_name, column_value) for each column with value
                                            columns_values = [(column, row[column]) for column in df_table.columns if not pd.isnull(row[column])]

                                        # Creating string for columns names
                                            columns = ', '.join([column for column, _ in columns_values])

                                        # Creating string for columns values. For money/amount values, dots are replaced for commas to avoid insertion problems
                                            values = ', '.join([f"'{value.replace('.', ',')}'" if column in ['offer_amount','order_amount']
                                                                else ('NULL' if value == '' and column in ['order_date','expected_date','register_date','recep_date','limit_date',
                                                                'presentation_date', 'items_number']
                                                                else "'{}'".format(value.replace('\'', '\'\''))) for column, value in columns_values])

                                        # Creating insertion query and executing it
                                            sql_insertion = f"INSERT INTO {table_name} ({columns}) VALUES ({values})"
                                            cur.execute(sql_insertion)

                                conn.commit()

                            MessageHelper.show_message(QtWidgets.QMessageBox.Icon.Information, "info")

                        except (Exception, psycopg2.DatabaseError) as error:
                            MessageHelper.show_message("Ha ocurrido el siguiente error:\n"
                                    + str(error), 'critical')

            else:
                break


    def future_projects(self):
        """
        Opens the "Future Projects" window, establishes a database connection and closes the current menu.
        """
        from Future_Projects_Window import Ui_Future_Projects_Window
        dbparam = config()
        user_database = dbparam["user"]
        password_database = dbparam["password"]

        db_tag_com = Create_DBconnection(user_database, password_database)
        if not db_tag_com:
            sys.exit()

        self.future_projects_window = Ui_Future_Projects_Window(db_tag_com)
        self.future_projects_window.showMaximized()


# Function to generate reports
    def generate_report(self):
        """
        Generates a report based on chosen selection
        """
        while True:
            report, ok = QtWidgets.QInputDialog.getItem(None, "Informes", "Selecciona un informe:", ['Ofertas', 'Pedidos'], 0, False)
            if ok and report:
                while True:
                    if report == 'Ofertas':
                        self.report_offers()
                        break
                    elif report == 'Pedidos':
                        self.report_orders()
                        break
                break
            else:
                break


    def report_offers(self):
        start_date, end_date = self.get_date_range()

        if start_date and end_date:
            query_graph_commercial_1 = ("""
                            SELECT offers.num_offer, offers.state, offers.responsible,
                            COALESCE(offers.offer_amount, 0::money) AS offer_amount, COALESCE(orders.order_amount, 0::money) AS order_amount, orders.num_order
                            FROM offers
                            LEFT JOIN orders ON offers.num_offer = orders.num_offer
                            WHERE EXTRACT(YEAR FROM offers.register_date) = EXTRACT(YEAR FROM CURRENT_DATE)
                            """)

            query_graph_commercial_2 = ("""
                                SELECT num_offer, state, responsible, 'offers' AS source_table
                                FROM offers
                                WHERE EXTRACT(YEAR FROM offers.register_date) = EXTRACT(YEAR FROM CURRENT_DATE)

                                UNION ALL

                                SELECT id_offer, state, responsible, 'received_offers' AS source_table
                                FROM received_offers
                                WHERE EXTRACT(YEAR FROM received_offers.register_date) = EXTRACT(YEAR FROM CURRENT_DATE)
                                """)

            query_graph_calculation_1 = ("""
                            SELECT offers.num_offer, offers.state, offers.responsible_calculations,
                            COALESCE(offers.offer_amount, 0::money) AS offer_amount, COALESCE(orders.order_amount, 0::money) AS order_amount
                            FROM offers
                            LEFT JOIN orders ON offers.num_offer = orders.num_offer
                            WHERE EXTRACT(YEAR FROM offers.register_date) = EXTRACT(YEAR FROM CURRENT_DATE) AND (offers.responsible_calculations NOT IN ('N/A', '') AND offers.responsible_calculations IS NOT NULL)
                            """)

            query_graph_calculation_2 = ("""
                                SELECT num_offer, state, responsible_calculations, 'offers' AS source_table
                                FROM offers
                                WHERE EXTRACT(YEAR FROM offers.register_date) = EXTRACT(YEAR FROM CURRENT_DATE) AND (offers.responsible_calculations NOT IN ('N/A', '') AND offers.responsible_calculations IS NOT NULL)
                                """)

            query_last_weekly_summary = ("""
                                SELECT num_offer, state, responsible, responsible_calculations, client, final_client,
                                recep_date, presentation_date, limit_date,
                                probability, priority, material, items_number, offer_amount, actions, source_table
                                FROM (
                                SELECT num_offer, state, responsible, responsible_calculations, client, final_client,
                                TO_CHAR(recep_date, 'DD/MM/YYYY') as recep_date, TO_CHAR(presentation_date, 'DD/MM/YYYY') as presentation_date, TO_CHAR(limit_date, 'DD/MM/YYYY') as limit_date,
                                probability, '' as priority, material, items_number, offer_amount, actions, 'offers' AS source_table
                                FROM offers
                                WHERE register_date >= %s AND register_date <= %s

                                UNION ALL

                                SELECT id_offer as num_offer, state, responsible, '' as responsible_calculations, client, final_client,
                                TO_CHAR(recep_date, 'DD/MM/YYYY') as recep_date, '' as presentation_date, TO_CHAR(limit_date, 'DD/MM/YYYY') as limit_date,
                                '' as probability, '' as priority, material, items_number, '' as offer_amount, '' as actions, 'received_offers' AS source_table
                                FROM received_offers
                                WHERE register_date >= %s AND register_date <= %s) as final_table

                                ORDER BY array_position(
                                ARRAY['No Ofertada', 'Declinada', 'Perdida', 'Recibida', 'Registrada', 'En Estudio', 'Presentada', 'Adjudicada'], state), num_offer
                                """)

            query_active_summary = ("""
                                SELECT * FROM (
                                SELECT num_offer, state, responsible, responsible_calculations, client, final_client,
                                TO_CHAR(recep_date, 'DD/MM/YYYY'), TO_CHAR(presentation_date, 'DD/MM/YYYY'), TO_CHAR(limit_date, 'DD/MM/YYYY'),
                                probability, '' as priority, material, items_number, offer_amount, actions
                                FROM offers
                                WHERE state IN ('Registrada', 'En Estudio', 'Presentada')

                                UNION ALL

                                SELECT id_offer as num_offer, state, responsible, '' as responsible_calculations, client, final_client,
                                TO_CHAR(recep_date, 'DD/MM/YYYY'), '' as presentation_date, TO_CHAR(limit_date, 'DD/MM/YYYY'),
                                '' as probability, '' as priority, material, items_number, '' as offer_amount, '' as actions
                                FROM received_offers
                                WHERE state IN ('Registrada')) as final_table

                                ORDER BY state
                                """)

            with Database_Connection(config()) as conn:
                with conn.cursor() as cur:

                    cur.execute(query_graph_commercial_1)
                    results_graph_commercial_1 = cur.fetchall()
                    df_graph_commercial_1 = pd.DataFrame(results_graph_commercial_1, columns=['N췈 Oferta', 'Estado', 'Responsable', 'Importe Oferta', 'Importe Pedido', 'N췈 Pedido'])

                    df_graph_commercial_1['Importe Oferta'] = df_graph_commercial_1['Importe Oferta']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

                    df_graph_commercial_1['Importe Pedido'] = df_graph_commercial_1['Importe Pedido']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

                    df_graph_commercial_1['Importe Final'] = df_graph_commercial_1.apply(lambda row: row['Importe Pedido'] if row['Estado'] == 'Adjudicada' else row['Importe Oferta'], axis=1)

                    cur.execute(query_graph_commercial_2)
                    results_graph_commercial_2 = cur.fetchall()
                    df_graph_commercial_2 = pd.DataFrame(results_graph_commercial_2, columns=['N췈 Oferta', 'Estado', 'Responsable', 'Tabla'])

                    cur.execute(query_graph_calculation_1)
                    results_graph_calculation_1 = cur.fetchall()
                    df_graph_calculation_1 = pd.DataFrame(results_graph_calculation_1, columns=['N췈 Oferta', 'Estado', 'Responsable', 'Importe Oferta', 'Importe Pedido'])

                    df_graph_calculation_1['Importe Oferta'] = df_graph_calculation_1['Importe Oferta']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

                    df_graph_calculation_1['Importe Pedido'] = df_graph_calculation_1['Importe Pedido']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

                    df_graph_calculation_1['Importe Final'] = df_graph_calculation_1.apply(lambda row: row['Importe Pedido'] if row['Estado'] == 'Adjudicada' else row['Importe Oferta'], axis=1)

                    cur.execute(query_graph_calculation_2)
                    results_graph_calculation_2 = cur.fetchall()
                    df_graph_calculation_2 = pd.DataFrame(results_graph_calculation_2, columns=['N췈 Oferta', 'Estado', 'Responsable', 'Tabla'])

                    df_graph_orders_1 = df_graph_commercial_1.dropna(subset=['N췈 Pedido'])

                    cur.execute(query_last_weekly_summary, (start_date, end_date, start_date, end_date))
                    results_weekly = cur.fetchall()
                    df_weekly = pd.DataFrame(results_weekly,
                    columns=['N췈 Oferta', 'Estado', 'Responsable', 'C치lculos', 'Cliente', 'Cl. Final',
                    'Fecha Rec.', 'Fecha Pres.', 'Fecha Vto.',
                    'Prob.', 'Prior.', 'Material', 'N췈 Eqs.', 'Importe', 'Acciones', 'Tabla']
                    )

                    df_weekly['Importe Euros'] = df_weekly['Importe']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

                    cur.execute(query_active_summary)
                    results_active = cur.fetchall()
                    df_active = pd.DataFrame(results_active, columns=['N췈 Oferta', 'Estado', 'Responsable', 'C치lculos', 'Cliente', 'Cl. Final',
                    'Fecha Rec.', 'Fecha Pres.', 'Fecha Vto.',
                    'Prob.', 'Prior.', 'Material', 'N췈 Eqs.', 'Importe', 'Acciones']
                    )

                    df_active['Importe Euros'] = df_active['Importe']\
                                                .str.replace('', '', regex=False) \
                                                .str.replace('.', '', regex=False) \
                                                .str.replace(',', '.', regex=False) \
                                                .astype(float)

            pdf = self.generate_report_offers(start_date, end_date, df_graph_commercial_1, df_graph_commercial_2, df_graph_calculation_1, df_graph_calculation_2, df_graph_orders_1, df_weekly, df_active)

            output_path = asksaveasfilename(defaultextension=".pdf", filetypes=[("Archivos PDF", "*.pdf")], title="Guardar PDF")
            if output_path:
                pdf.output(output_path)

    def generate_report_offers(self, start_date, end_date, df_graph_commercial_1, df_graph_commercial_2, df_graph_calculation_1, df_graph_calculation_2, df_graph_orders_1, df_weekly, df_active):
        pdf = CustomPDF_A3('P')

        pdf.add_font('DejaVuSansCondensed', '', str(get_path("Resources", "Iconos", "DejaVuSansCondensed.ttf")))
        pdf.add_font('DejaVuSansCondensed-Bold', '', str(get_path("Resources", "Iconos", "DejaVuSansCondensed-Bold.ttf")))

        pdf.set_auto_page_break(auto=True)
        pdf.set_margins(0.5, 0.5)

        pdf.set_fill_color(3, 174, 236)

        pdf.add_page()

        pdf.image(str(get_path("Resources", "Iconos", "Eipsa Logo Blanco.png")), 1, 0.8, 7, 2)
        pdf.ln(3)

        pdf.set_font('Helvetica', 'B', size=6)
        y_position = 0.5
        pdf.set_xy(12.55, y_position)
        pdf.fixed_height_multicell(3.5, 0.6, 'TOTAL IMPORTE REGISTRADO ' + str(datetime.today().year), fill=True)
        pdf.set_xy(16.05, y_position)
        pdf.cell(0.4, 0.6,'')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL IMPORTE OFERTADO ' + str(datetime.today().year), fill=True)
        pdf.set_xy(20.45, y_position)
        pdf.cell(0.4, 0.6,'')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL IMPORTE BUDGETARY ' + str(datetime.today().year), fill=True)
        pdf.set_xy(24.85, y_position)
        pdf.cell(0.4, 0.6, '')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL IMPORTE ADJUDICADO ' + str(datetime.today().year), fill=True)

        received_amount = df_graph_commercial_1['Importe Oferta'].sum()
        offered_amount = df_graph_commercial_1[df_graph_commercial_1['Estado'] != 'Budgetary']['Importe Oferta'].sum()
        budgetary_amount = df_graph_commercial_1[df_graph_commercial_1['Estado'] == 'Budgetary']['Importe Oferta'].sum()
        order_amount = df_graph_commercial_1[df_graph_commercial_1['Estado'] == 'Adjudicada']['Importe Oferta'].sum()

        pdf.set_font('DejaVuSansCondensed-Bold','', size=6)
        y_position = 1.1
        pdf.set_xy(12.55, y_position)
        pdf.fixed_height_multicell(3.5, 0.3, self.euro_format(received_amount), fill=False)
        pdf.set_xy(16.05, y_position)
        pdf.cell(0.4, 0.6,'')
        pdf.fixed_height_multicell(4, 0.3, self.euro_format(offered_amount) + " / " + f"{(offered_amount/received_amount):.1%}", fill=False)
        pdf.set_xy(20.45, y_position)
        pdf.cell(0.4, 0.3, '')
        pdf.fixed_height_multicell(4, 0.3, self.euro_format(budgetary_amount) + " / " + f"{(budgetary_amount/received_amount):.1%}", fill=False)
        pdf.set_xy(24.85, y_position)
        pdf.cell(0.4, 0.3, '')
        pdf.fixed_height_multicell(4, 0.3, self.euro_format(order_amount) + " / " + f"{(order_amount/offered_amount):.1%}", fill=False)

        pdf.set_font('Helvetica', 'B', size=6)
        y_position = 1.6
        pdf.set_xy(12.55, y_position)
        pdf.fixed_height_multicell(3.5, 0.6, 'TOTAL OFERTAS REGISTRADAS ' + str(datetime.today().year), fill=True)
        pdf.set_xy(16.05, y_position)
        pdf.cell(0.4, 0.6, '')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL OFERTAS REALIZADAS ' + str(datetime.today().year), fill=True)
        pdf.set_xy(20.45, y_position)
        pdf.cell(0.4, 0.6, '')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL BUDGETARIES\n' + str(datetime.today().year), fill=True)
        pdf.set_xy(24.85, y_position)
        pdf.cell(0.4, 0.6, '')
        pdf.fixed_height_multicell(4, 0.6, 'TOTAL OFERTAS ADJUDICADAS ' + str(datetime.today().year), fill=True)
        pdf.set_xy(26.4, y_position)

        received_count = df_graph_commercial_2.shape[0]
        offered_count = df_graph_commercial_2[df_graph_commercial_2['Estado'] != 'Budgetary'].shape[0]
        budgetary_count = df_graph_commercial_2[df_graph_commercial_2['Estado'] == 'Budgetary'].shape[0]
        order_count = df_graph_commercial_2[df_graph_commercial_2['Estado'] == 'Adjudicada'].shape[0]
        
        pdf.set_font('DejaVuSansCondensed-Bold','', size=6)
        y_position = 2.2
        pdf.set_xy(12.55, y_position)
        pdf.fixed_height_multicell(3.5, 0.3, str(received_count), fill=False)
        pdf.set_xy(16.05, y_position)
        pdf.cell(0.4, 0.3, '')
        pdf.fixed_height_multicell(4, 0.3, str(offered_count) + " / " + f"{(offered_count/received_count):.1%}", fill=False)
        pdf.set_xy(20.45, y_position)
        pdf.cell(0.4, 0.3, '')
        pdf.fixed_height_multicell(4, 0.3, str(budgetary_count) + " / " + f"{(budgetary_count/received_count):.1%}", fill=False)
        pdf.set_xy(24.85, y_position)
        pdf.cell(0.4, 0.3, '')
        pdf.fixed_height_multicell(4, 0.3, str(order_count) + " / " + f"{(order_count/offered_count):.1%}", fill=False)

        df_graph_commercial_1 = df_graph_commercial_1[df_graph_commercial_1['Estado'] != 'Budgetary']
        img_graph_1, img_graph_2 = self.graphs_commercial_report(df_graph_commercial_1, df_graph_commercial_2)
        img_graph_3, img_graph_4 = self.graphs_calculation_report(df_graph_calculation_1, df_graph_calculation_2)
        img_graph_5, img_graph_6 = self.graphs_orders_report(df_graph_orders_1)

        y_position = 3
        pdf.image(img_graph_1, x=0.5, y=y_position, w=8.5, h=4.5)
        pdf.image(img_graph_3, x=10.6, y=y_position, w=8.5, h=4.5)
        pdf.image(img_graph_5, x=20.7, y=y_position, w=8.5, h=4.5)
        pdf.ln(5)

        y_position = pdf.get_y()
        pdf.image(img_graph_2, x=0.5, y=y_position, w=8.5, h=4.5)
        pdf.image(img_graph_4, x=10.6, y=y_position, w=8.5, h=4.5)
        pdf.image(img_graph_6, x=20.7, y=y_position, w=8.5, h=4.5)
        pdf.ln(5)

        pdf.set_fill_color(255, 255, 64)
        pdf.set_font('Helvetica', 'B', size=7)
        pdf.cell(19.75, 0.5, 'RESUMEN SEMANAL', fill=True)
        pdf.cell(3, 0.5, (start_date.strftime('%d/%m/%Y')), fill=True, align='C')
        pdf.cell(3, 0.5, '-', fill=True, align='C')
        pdf.cell(3, 0.5, (end_date.strftime('%d/%m/%Y')), fill=True, align='C')
        pdf.ln(0.5)

        pdf.set_fill_color(3, 174, 236)
        pdf.cell(3, 0.5, 'REGISTRADAS:')
        pdf.cell(3, 0.5, str(df_weekly.shape[0]), align='L')
        pdf.cell(1.5, 0.5, '')
        pdf.cell(3, 0.5, 'EN ESTUDIO:')
        pdf.cell(3, 0.5, str(df_weekly[df_weekly['Estado'] == 'En Estudio'].shape[0]), align='L')
        pdf.cell(1.5, 0.5, '')
        pdf.cell(3, 0.5, 'REALIZADAS:')
        pdf.cell(3, 0.5, str(df_weekly[~df_weekly['Estado'].isin(['Registrada', 'En Estudio'])].shape[0]), align='L')
        pdf.cell(1.5, 0.5, '')
        pdf.cell(3, 0.5, 'ADJUDICADAS:')
        pdf.cell(3, 0.5, str(df_weekly[df_weekly['Estado'] == 'Adjudicada'].shape[0]), align='L')
        pdf.ln(0.5)

        pdf.cell(1.5, 0.3, 'OFERTA', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'ESTADO', fill=True, border=1, align='C')
        pdf.cell(2, 0.3, 'RESP.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'CALC.', fill=True, border=1, align='C')
        pdf.cell(3, 0.3, 'CLIENTE', fill=True, border=1, align='C')
        pdf.cell(3.5, 0.3, 'CLIENTE FINAL', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. REC.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. PRES.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. VTO.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PROB.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PRIOR.', fill=True, border=1, align='C')
        pdf.cell(2.75, 0.3, 'MATERIAL', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'N췈 EQ.', fill=True, border=1, align='C')
        pdf.cell(2.2, 0.3, 'IMPORTE', fill=True, border=1, align='C')
        pdf.cell(3.25, 0.3, 'ACCIONES', fill=True, border=1, align='C')
        pdf.ln()

        pdf.set_font('DejaVuSansCondensed', size=6)
        for _, row in df_weekly.iterrows():
            # getting the required height of the row
            line_h = pdf.font_size * 1.5
            h_client = pdf.get_multicell_height(2.75, line_h, '' if row['Cliente'] is None else str(row['Cliente']))
            h_clfinal = pdf.get_multicell_height(3.25, line_h, '' if row['Cl. Final'] is None else str(row['Cl. Final']))
            h_material = pdf.get_multicell_height(2.5, line_h, '' if row['Material'] is None else str(row['Material']))
            h_actions = pdf.get_multicell_height(3, line_h, '' if row['Acciones'] is None else str(row['Acciones']))

            row_height = max(h_client, h_clfinal, h_material, h_actions, line_h)

            # Setting values for table
            pdf.cell(1.5, row_height, '' if row['N췈 Oferta'] is None else str(row['N췈 Oferta']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Estado'] is None else str(row['Estado']), border=1, align='C')
            pdf.cell(2, row_height, '' if row['Responsable'] is None else str(row['Responsable']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['C치lculos'] is None else str(row['C치lculos']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3, row_height, '' if row['Cliente'] is None else str(row['Cliente']), border=1)
            pdf.set_xy(x + 3, y)

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.5, row_height, '' if row['Cl. Final'] is None else str(row['Cl. Final']), border=1)
            pdf.set_xy(x + 3.5, y)

            pdf.cell(1.5, row_height, '' if row['Fecha Rec.'] is None else str(row['Fecha Rec.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Pres.'] is None else str(row['Fecha Pres.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Vto.'] is None else str(row['Fecha Vto.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prob.'] is None else str(row['Prob.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prior.'] is None else str(row['Prior.']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(2.75, row_height, '' if row['Material'] is None else str(row['Material']), border=1)
            pdf.set_xy(x + 2.75, y)

            pdf.cell(1, row_height, '' if row['N췈 Eqs.'] is None else str(row['N췈 Eqs.']), border=1, align='C')
            pdf.cell(2.2, row_height, '' if row['Importe'] is None else str(row['Importe']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.25, row_height, '' if row['Acciones'] is None else str(row['Acciones']), border=1)
            pdf.set_xy(x + 2.5, y)

            pdf.ln(row_height)

        pdf.set_font('DejaVuSansCondensed-Bold', size=7)
        pdf.cell(22, 0.3, '')
        pdf.cell(4.25, 0.3, 'TOTAL:', align='R')
        pdf.cell(2.5, 0.3, self.euro_format(df_weekly['Importe Euros'].sum()), align='C')
        pdf.ln(0.5)

        pdf.set_fill_color(255, 255, 64)
        pdf.cell(28.75, 0.5, 'OFERTAS EN ACTIVO', fill=True)
        pdf.ln(0.5)

        pdf.set_fill_color(3, 174, 236)

        df_registered = df_active[df_active['Estado'] == 'Registrada'].sort_values(by=['Responsable', 'N췈 Oferta'])

        if df_registered.shape[0] > 0:
            pdf.cell(3, 0.5, 'REGISTRADAS:')
            pdf.cell(3, 0.5, str(df_registered.shape[0]), align='L')
            pdf.ln(0.5)

            pdf.cell(1.5, 0.3, 'OFERTA', fill=True, border=1, align='C')
            pdf.cell(1.5, 0.3, 'ESTADO', fill=True, border=1, align='C')
            pdf.cell(2, 0.3, 'RESP.', fill=True, border=1, align='C')
            pdf.cell(1.5, 0.3, 'CALC.', fill=True, border=1, align='C')
            pdf.cell(3, 0.3, 'CLIENTE', fill=True, border=1, align='C')
            pdf.cell(3.5, 0.3, 'CLIENTE FINAL', fill=True, border=1, align='C')
            pdf.cell(1.5, 0.3, 'F. REC.', fill=True, border=1, align='C')
            pdf.cell(1.5, 0.3, 'F. PRES.', fill=True, border=1, align='C')
            pdf.cell(1.5, 0.3, 'F. VTO.', fill=True, border=1, align='C')
            pdf.cell(1, 0.3, 'PROB.', fill=True, border=1, align='C')
            pdf.cell(1, 0.3, 'PRIOR.', fill=True, border=1, align='C')
            pdf.cell(2.75, 0.3, 'MATERIAL', fill=True, border=1, align='C')
            pdf.cell(1, 0.3, 'N췈 EQ.', fill=True, border=1, align='C')
            pdf.cell(2.2, 0.3, 'IMPORTE', fill=True, border=1, align='C')
            pdf.cell(3.25, 0.3, 'ACCIONES', fill=True, border=1, align='C')
            pdf.ln()

            pdf.set_font('DejaVuSansCondensed', size=6)
            for _, row in df_registered.iterrows():
                # getting the required height of the row
                line_h = pdf.font_size * 1.5
                h_client = pdf.get_multicell_height(2.75, line_h, '' if row['Cliente'] is None else str(row['Cliente']))
                h_clfinal = pdf.get_multicell_height(3.25, line_h, '' if row['Cl. Final'] is None else str(row['Cl. Final']))
                h_material = pdf.get_multicell_height(2.5, line_h, '' if row['Material'] is None else str(row['Material']))
                h_actions = pdf.get_multicell_height(3, line_h, '' if row['Acciones'] is None else str(row['Acciones']))

                row_height = max(h_client, h_clfinal, h_material, h_actions, line_h)

                # Setting values for table
                pdf.cell(1.5, row_height, '' if row['N췈 Oferta'] is None else str(row['N췈 Oferta']), border=1, align='C')
                pdf.cell(1.5, row_height, '' if row['Estado'] is None else str(row['Estado']), border=1, align='C')
                pdf.cell(2, row_height, '' if row['Responsable'] is None else str(row['Responsable']), border=1, align='C')
                pdf.cell(1.5, row_height, '' if row['C치lculos'] is None else str(row['C치lculos']), border=1, align='C')

                x = pdf.get_x()
                y = pdf.get_y()
                pdf.fixed_height_multicell(3, row_height, '' if row['Cliente'] is None else str(row['Cliente']), border=1)
                pdf.set_xy(x + 3, y)

                x = pdf.get_x()
                y = pdf.get_y()
                pdf.fixed_height_multicell(3.5, row_height, '' if row['Cl. Final'] is None else str(row['Cl. Final']), border=1)
                pdf.set_xy(x + 3.5, y)

                pdf.cell(1.5, row_height, '' if row['Fecha Rec.'] is None else str(row['Fecha Rec.']), border=1, align='C')
                pdf.cell(1.5, row_height, '' if row['Fecha Pres.'] is None else str(row['Fecha Pres.']), border=1, align='C')
                pdf.cell(1.5, row_height, '' if row['Fecha Vto.'] is None else str(row['Fecha Vto.']), border=1, align='C')
                pdf.cell(1, row_height, '' if row['Prob.'] is None else str(row['Prob.']), border=1, align='C')
                pdf.cell(1, row_height, '' if row['Prior.'] is None else str(row['Prior.']), border=1, align='C')

                x = pdf.get_x()
                y = pdf.get_y()
                pdf.fixed_height_multicell(2.75, row_height, '' if row['Material'] is None else str(row['Material']), border=1)
                pdf.set_xy(x + 2.75, y)

                pdf.cell(1, row_height, '' if row['N췈 Eqs.'] is None else str(row['N췈 Eqs.']), border=1, align='C')
                pdf.cell(2.2, row_height, '' if row['Importe'] is None else str(row['Importe']), border=1, align='C')

                x = pdf.get_x()
                y = pdf.get_y()
                pdf.fixed_height_multicell(3.25, row_height, '' if row['Acciones'] is None else str(row['Acciones']), border=1)
                pdf.set_xy(x + 2.5, y)

                pdf.ln(row_height)

            pdf.set_font('DejaVuSansCondensed-Bold', size=7)
            pdf.cell(20.75, 0.3, '')
            pdf.cell(5, 0.3, 'TOTAL:', align='R')
            pdf.cell(3, 0.3, self.euro_format(df_registered['Importe Euros'].sum()), align='C')
            pdf.ln()

        df_study = df_active[df_active['Estado'] == 'En Estudio'].sort_values(by=['Responsable', 'N췈 Oferta'])

        df_study['Fecha Vto.'] = pd.to_datetime(df_study['Fecha Vto.'], format='%d/%m/%Y', errors='coerce')
        df_study['days_diff'] = (pd.Timestamp.today() - df_study['Fecha Vto.']).dt.days
        df_study['Fecha Vto.'] = df_study['Fecha Vto.'].dt.strftime('%d/%m/%Y')

        pdf.set_font('Helvetica', 'B', size=7)
        pdf.cell(3, 0.5, 'EN ESTUDIO:')
        pdf.cell(3, 0.5, str(df_study.shape[0]), align='L')
        pdf.ln(0.5)

        pdf.cell(1.5, 0.3, 'OFERTA', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'ESTADO', fill=True, border=1, align='C')
        pdf.cell(2, 0.3, 'RESP.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'CALC.', fill=True, border=1, align='C')
        pdf.cell(3, 0.3, 'CLIENTE', fill=True, border=1, align='C')
        pdf.cell(3.5, 0.3, 'CLIENTE FINAL', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. REC.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. PRES.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. VTO.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PROB.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PRIOR.', fill=True, border=1, align='C')
        pdf.cell(2.75, 0.3, 'MATERIAL', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'N췈 EQ.', fill=True, border=1, align='C')
        pdf.cell(2.2, 0.3, 'IMPORTE', fill=True, border=1, align='C')
        pdf.cell(3.25, 0.3, 'ACCIONES', fill=True, border=1, align='C')
        pdf.ln()

        pdf.set_fill_color(255, 105, 105)
        pdf.set_font('DejaVuSansCondensed', size=6)
        for _, row in df_study.iterrows():
            # getting the required height of the row
            line_h = pdf.font_size * 1.5
            h_client = pdf.get_multicell_height(2.75, line_h, '' if row['Cliente'] is None else str(row['Cliente']))
            h_clfinal = pdf.get_multicell_height(3.25, line_h, '' if row['Cl. Final'] is None else str(row['Cl. Final']))
            h_material = pdf.get_multicell_height(2.5, line_h, '' if row['Material'] is None else str(row['Material']))
            h_actions = pdf.get_multicell_height(3, line_h, '' if row['Acciones'] is None else str(row['Acciones']))

            row_height = max(h_client, h_clfinal, h_material, h_actions, line_h)

            # Setting values for table
            pdf.cell(1.5, row_height, '' if row['N췈 Oferta'] is None else str(row['N췈 Oferta']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Estado'] is None else str(row['Estado']), border=1, align='C')
            pdf.cell(2, row_height, '' if row['Responsable'] is None else str(row['Responsable']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['C치lculos'] is None else str(row['C치lculos']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3, row_height, '' if row['Cliente'] is None else str(row['Cliente']), border=1)
            pdf.set_xy(x + 3, y)

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.5, row_height, '' if row['Cl. Final'] is None else str(row['Cl. Final']), border=1)
            pdf.set_xy(x + 3.5, y)

            pdf.cell(1.5, row_height, '' if row['Fecha Rec.'] is None else str(row['Fecha Rec.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Pres.'] is None else str(row['Fecha Pres.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Vto.'] is None else str(row['Fecha Vto.']), border=1, align='C', fill=True if row['days_diff'] > 0 else False)
            pdf.cell(1, row_height, '' if row['Prob.'] is None else str(row['Prob.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prior.'] is None else str(row['Prior.']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(2.75, row_height, '' if row['Material'] is None else str(row['Material']), border=1)
            pdf.set_xy(x + 2.75, y)

            pdf.cell(1, row_height, '' if row['N췈 Eqs.'] is None else str(row['N췈 Eqs.']), border=1, align='C')
            pdf.cell(2.2, row_height, '' if row['Importe'] is None else str(row['Importe']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.25, row_height, '' if row['Acciones'] is None else str(row['Acciones']), border=1)
            pdf.set_xy(x + 2.5, y)

            pdf.ln(row_height)

        pdf.set_font('DejaVuSansCondensed-Bold', size=7)
        pdf.cell(20.75, 0.3, '')
        pdf.cell(5, 0.3, 'TOTAL:', align='R')
        pdf.cell(3, 0.3, self.euro_format(df_study['Importe Euros'].sum()), align='C')
        pdf.ln()

        # pdf.add_page()

        df_active['Fecha Pres.'] = pd.to_datetime(df_active['Fecha Pres.'], format='%d/%m/%Y', errors='coerce')
        df_active['days_diff'] = (pd.Timestamp.today() - df_active['Fecha Pres.']).dt.days

        df_presented = df_active[df_active['Estado'] == 'Presentada'].sort_values(by=['Fecha Pres.'])

        df_less_30 = df_presented[df_presented['days_diff'] <= 30].copy()
        df_more_30 = df_presented[df_presented['days_diff'] > 30].copy()

        df_less_30['Fecha Pres.'] = df_less_30['Fecha Pres.'].dt.strftime('%d/%m/%Y')
        df_more_30['Fecha Pres.'] = df_more_30['Fecha Pres.'].dt.strftime('%d/%m/%Y')

        pdf.set_fill_color(3, 174, 236)
        pdf.set_font('Helvetica', 'B', size=7)
        pdf.cell(3, 0.5, 'PRESENTADAS:')
        pdf.cell(3, 0.5, str(df_presented.shape[0]), align='L')
        pdf.ln(0.5)

        df_active['Fecha Pres.'] = pd.to_datetime(df_active['Fecha Pres.'], errors='coerce', dayfirst=True)

        pdf.cell(1.5, 0.3, 'OFERTA', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'ESTADO', fill=True, border=1, align='C')
        pdf.cell(2, 0.3, 'RESP.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'CALC.', fill=True, border=1, align='C')
        pdf.cell(3, 0.3, 'CLIENTE', fill=True, border=1, align='C')
        pdf.cell(3.5, 0.3, 'CLIENTE FINAL', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. REC.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. PRES.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. VTO.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PROB.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PRIOR.', fill=True, border=1, align='C')
        pdf.cell(2.75, 0.3, 'MATERIAL', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'N췈 EQ.', fill=True, border=1, align='C')
        pdf.cell(2.2, 0.3, 'IMPORTE', fill=True, border=1, align='C')
        pdf.cell(3.25, 0.3, 'ACCIONES', fill=True, border=1, align='C')
        pdf.ln()

        pdf.set_font('DejaVuSansCondensed', size=6)
        for _, row in df_less_30.iterrows():
            # getting the required height of the row
            line_h = pdf.font_size * 1.5
            h_client = pdf.get_multicell_height(2.75, line_h, '' if row['Cliente'] is None else str(row['Cliente']))
            h_clfinal = pdf.get_multicell_height(3.25, line_h, '' if row['Cl. Final'] is None else str(row['Cl. Final']))
            h_material = pdf.get_multicell_height(2.5, line_h, '' if row['Material'] is None else str(row['Material']))
            h_actions = pdf.get_multicell_height(3, line_h, '' if row['Acciones'] is None else str(row['Acciones']))

            row_height = max(h_client, h_clfinal, h_material, h_actions, line_h)

            # Setting values for table
            pdf.cell(1.5, row_height, '' if row['N췈 Oferta'] is None else str(row['N췈 Oferta']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Estado'] is None else str(row['Estado']), border=1, align='C')
            pdf.cell(2, row_height, '' if row['Responsable'] is None else str(row['Responsable']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['C치lculos'] is None else str(row['C치lculos']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3, row_height, '' if row['Cliente'] is None else str(row['Cliente']), border=1)
            pdf.set_xy(x + 3, y)

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.5, row_height, '' if row['Cl. Final'] is None else str(row['Cl. Final']), border=1)
            pdf.set_xy(x + 3.5, y)

            pdf.cell(1.5, row_height, '' if row['Fecha Rec.'] is None else str(row['Fecha Rec.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Pres.'] is None else str(row['Fecha Pres.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Vto.'] is None else str(row['Fecha Vto.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prob.'] is None else str(row['Prob.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prior.'] is None else str(row['Prior.']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(2.75, row_height, '' if row['Material'] is None else str(row['Material']), border=1)
            pdf.set_xy(x + 2.75, y)

            pdf.cell(1, row_height, '' if row['N췈 Eqs.'] is None else str(row['N췈 Eqs.']), border=1, align='C')
            pdf.cell(2.2, row_height, '' if row['Importe'] is None else str(row['Importe']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.25, row_height, '' if row['Acciones'] is None else str(row['Acciones']), border=1)
            pdf.set_xy(x + 2.5, y)

            pdf.ln(row_height)

        pdf.set_fill_color(3, 174, 236)
        pdf.set_font('DejaVuSansCondensed-Bold', size=7)
        pdf.cell(20.75, 0.3, '')
        pdf.cell(5, 0.3, 'TOTAL:', align='R')
        pdf.cell(3, 0.3, self.euro_format(df_less_30['Importe Euros'].sum()), align='C')
        pdf.ln()

        pdf.cell(1.5, 0.3, 'OFERTA', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'ESTADO', fill=True, border=1, align='C')
        pdf.cell(2, 0.3, 'RESP.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'CALC.', fill=True, border=1, align='C')
        pdf.cell(3, 0.3, 'CLIENTE', fill=True, border=1, align='C')
        pdf.cell(3.5, 0.3, 'CLIENTE FINAL', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. REC.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. PRES.', fill=True, border=1, align='C')
        pdf.cell(1.5, 0.3, 'F. VTO.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PROB.', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'PRIOR.', fill=True, border=1, align='C')
        pdf.cell(2.75, 0.3, 'MATERIAL', fill=True, border=1, align='C')
        pdf.cell(1, 0.3, 'N췈 EQ.', fill=True, border=1, align='C')
        pdf.cell(2.2, 0.3, 'IMPORTE', fill=True, border=1, align='C')
        pdf.cell(3.25, 0.3, 'ACCIONES', fill=True, border=1, align='C')
        pdf.ln()

        pdf.set_fill_color(255, 105, 105)
        pdf.set_font('DejaVuSansCondensed', size=6)
        for _, row in df_more_30.iterrows():
            # getting the required height of the row
            line_h = pdf.font_size * 1.5
            h_client = pdf.get_multicell_height(2.75, line_h, '' if row['Cliente'] is None else str(row['Cliente']))
            h_clfinal = pdf.get_multicell_height(3.25, line_h, '' if row['Cl. Final'] is None else str(row['Cl. Final']))
            h_material = pdf.get_multicell_height(2.5, line_h, '' if row['Material'] is None else str(row['Material']))
            h_actions = pdf.get_multicell_height(3, line_h, '' if row['Acciones'] is None else str(row['Acciones']))

            row_height = max(h_client, h_clfinal, h_material, h_actions, line_h)

            # Setting values for table
            pdf.cell(1.5, row_height, '' if row['N췈 Oferta'] is None else str(row['N췈 Oferta']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Estado'] is None else str(row['Estado']), border=1, align='C')
            pdf.cell(2, row_height, '' if row['Responsable'] is None else str(row['Responsable']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['C치lculos'] is None else str(row['C치lculos']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3, row_height, '' if row['Cliente'] is None else str(row['Cliente']), border=1)
            pdf.set_xy(x + 3, y)

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.5, row_height, '' if row['Cl. Final'] is None else str(row['Cl. Final']), border=1)
            pdf.set_xy(x + 3.5, y)

            pdf.cell(1.5, row_height, '' if row['Fecha Rec.'] is None else str(row['Fecha Rec.']), border=1, align='C')
            pdf.cell(1.5, row_height, '' if row['Fecha Pres.'] is None else str(row['Fecha Pres.']), border=1, align='C', fill=True)
            pdf.cell(1.5, row_height, '' if row['Fecha Vto.'] is None else str(row['Fecha Vto.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prob.'] is None else str(row['Prob.']), border=1, align='C')
            pdf.cell(1, row_height, '' if row['Prior.'] is None else str(row['Prior.']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(2.75, row_height, '' if row['Material'] is None else str(row['Material']), border=1)
            pdf.set_xy(x + 2.75, y)

            pdf.cell(1, row_height, '' if row['N췈 Eqs.'] is None else str(row['N췈 Eqs.']), border=1, align='C')
            pdf.cell(2.2, row_height, '' if row['Importe'] is None else str(row['Importe']), border=1, align='C')

            x = pdf.get_x()
            y = pdf.get_y()
            pdf.fixed_height_multicell(3.25, row_height, '' if row['Acciones'] is None else str(row['Acciones']), border=1)
            pdf.set_xy(x + 2.5, y)

            pdf.ln(row_height)

        pdf.set_font('DejaVuSansCondensed-Bold', size=7)
        pdf.cell(20.75, 0.3, '')
        pdf.cell(5, 0.3, 'TOTAL:', align='R')
        pdf.cell(3, 0.3, self.euro_format(df_more_30['Importe Euros'].sum()), align='C')
        pdf.ln()

        return pdf

    def euro_format(self, valor):
        return f"{valor:,.2f} ".replace(',', 'X').replace('.', ',').replace('X', '.')

    def euro_format_axis(self, x, pos):
        if x >= 1_000_000:
            return f'{x/1_000_000:.1f}M'.replace('.', ',')
        elif x >= 1_000:
            return f'{x/1_000:.0f}k'.replace('.', ',')
        else:
            return f'{x:.0f}'

    def get_date_range(self):
        """
        Shows input dialogs to enter dates and convert to correct format
        """
        start_date_str, ok1 = QtWidgets.QInputDialog.getText(None, "Fecha inicial", "Introduce la fecha inicial (DD/MM/YYYY):")
        if not ok1 or not start_date_str:
            return None, None

        end_date_str, ok2 = QtWidgets.QInputDialog.getText(None, "Fecha final", "Introduce la fecha final (DD/MM/YYYY):")
        if not ok2 or not end_date_str:
            return None, None

        # Validate and convert date to format yyyy-mm-dd
        try:
            start_date = datetime.strptime(start_date_str, "%d/%m/%Y").date()
            end_date = datetime.strptime(end_date_str, "%d/%m/%Y").date()
        except ValueError:
            MessageHelper.show_message("Formato de fecha inv치lido. Usa DD/MM/YYYY.", "warning")
            return None, None

        return start_date, end_date

    def graphs_commercial_report(self, df_graph_commercial_1, df_graph_commercial_2):
        final_state_mapping = {
            "Registrada": ["Adjudicada", "Declinada", "No Ofertada", "Perdida", "Presentada", "Registrada", "En Estudio"],
            "No Ofertada": ["No Ofertada", "Declinada", "En Estudio"],
            "Ofertada": ["Adjudicada", "Perdida", "Presentada"],
            "No PO": ["Perdida", "Presentada"],
            "PO": ["Adjudicada"]
        }

        state_colors = {
            "Registrada": "#9467bd",
            "No Ofertada": "#ff7f0e",
            "Ofertada": "#ffe70eda",
            "No PO": "#d62728",
            "PO": "#2ca02c",
        }

        pivot_table_commercial_1 = df_graph_commercial_1.pivot_table(index='Responsable', columns='Estado', values='Importe Final', aggfunc='sum', fill_value=0)

        categories = pivot_table_commercial_1.index.tolist()
        final_states = list(final_state_mapping.keys())
        final_values = np.zeros((len(categories), len(final_states)))

        for state in state_colors.keys():
            if state not in pivot_table_commercial_1.columns:
                pivot_table_commercial_1[state] = 0

        for j, final_state in enumerate(final_states):
            original_list = final_state_mapping[final_state]
            # Sumatorio de las columnas originales que forman el estado final
            final_values[:, j] = pivot_table_commercial_1[original_list].sum(axis=1)

        x = np.arange(len(categories))           # Categories position
        width = 0.8 / len(final_states)               # Bar width

        fig, ax = plt.subplots(figsize=(8,5))

        for i, state in enumerate(final_states):
            color = state_colors.get(state, "#119efc")
            ax.bar(x + i*width, final_values[:, i], width=width, label=state, color=color)

        ax.set_xticks(x + width*(len(final_states)-1)/2)  # Center ticks
        ax.set_xticklabels(categories)

        ax.yaxis.set_major_formatter(FuncFormatter(self.euro_format_axis))
        ax.set_ylabel("Importe")
        ax.set_title("Importes por responsable y estado")
        ax.legend()

        img_graph_1 = BytesIO()
        plt.savefig(img_graph_1, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_1.seek(0)

        pivot_table_commercial_2 = df_graph_commercial_2.pivot_table(index='Responsable', columns='Estado', values='N췈 Oferta', aggfunc='count', fill_value=0)

        categories = pivot_table_commercial_2.index.tolist()
        final_states = list(final_state_mapping.keys())
        final_values = np.zeros((len(categories), len(final_states)))

        for state in state_colors.keys():
            if state not in pivot_table_commercial_2.columns:
                pivot_table_commercial_2[state] = 0

        for j, final_state in enumerate(final_states):
            original_list = final_state_mapping[final_state]
            # Sumatorio de las columnas originales que forman el estado final
            final_values[:, j] = pivot_table_commercial_2[original_list].sum(axis=1)

        x = np.arange(len(categories))           # Categories position
        width = 0.8 / len(final_states)               # Bar width

        fig, ax = plt.subplots(figsize=(8,5))

        for i, state in enumerate(final_states):
            color = state_colors.get(state, "#119efc")
            ax.bar(x + i*width, final_values[:, i], width=width, label=state, color=color)

        ax.set_xticks(x + width*(len(final_states)-1)/2)  # Center ticks
        ax.set_xticklabels(categories)

        ax.set_ylabel("Recuento")
        ax.set_title("Recuento de ofertas por estado")
        ax.legend()

        img_graph_2 = BytesIO()
        plt.savefig(img_graph_2, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_2.seek(0)

        return [img_graph_1, img_graph_2]

    def graphs_calculation_report(self, df_graph_calculation_1, df_graph_calculation_2):
        final_state_mapping = {
            "Ofertada": ["Adjudicada", "Perdida", "Presentada", "No Ofertada", "Declinada"],
            "No PO": ["Perdida", "Presentada", "No Ofertada", "Declinada"],
            "PO": ["Adjudicada"]
        }

        state_colors = {
            "Ofertada": "#ffe70eda",
            "No PO": "#d62728",
            "PO": "#2ca02c",
        }

        pivot_table_calculation_1 = df_graph_calculation_1.pivot_table(index='Responsable', columns='Estado', values='Importe Final', aggfunc='sum', fill_value=0)

        categories = pivot_table_calculation_1.index.tolist()
        final_states = list(final_state_mapping.keys())
        final_values = np.zeros((len(categories), len(final_states)))

        for state in state_colors.keys():
            if state not in pivot_table_calculation_1.columns:
                pivot_table_calculation_1[state] = 0

        for j, final_state in enumerate(final_states):
            original_list = final_state_mapping[final_state]
            # Filter columns in pivot only
            existing_columns = [col for col in original_list if col in pivot_table_calculation_1.columns]
            if existing_columns:
                final_values[:, j] = pivot_table_calculation_1[existing_columns].sum(axis=1)
            else:
                final_values[:, j] = 0

        x = np.arange(len(categories))           # Categories position
        width = 0.8 / len(final_states)               # Bar width

        fig, ax = plt.subplots(figsize=(8,5))

        for i, state in enumerate(final_states):
            color = state_colors.get(state, "#119efc")
            ax.bar(x + i*width, final_values[:, i], width=width, label=state, color=color)

        ax.set_xticks(x + width*(len(final_states)-1)/2)  # Center ticks
        ax.set_xticklabels(categories)

        ax.yaxis.set_major_formatter(FuncFormatter(self.euro_format_axis))
        ax.set_ylabel("Importe")
        ax.set_title("Importes por responsable y estado")
        ax.legend()

        img_graph_3 = BytesIO()
        plt.savefig(img_graph_3, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_3.seek(0)

        pivot_table_calculation_2 = df_graph_calculation_2.pivot_table(index='Responsable', columns='Estado', values='N췈 Oferta', aggfunc='count', fill_value=0)

        categories = pivot_table_calculation_2.index.tolist()
        final_states = list(final_state_mapping.keys())
        final_values = np.zeros((len(categories), len(final_states)))

        for state in state_colors.keys():
            if state not in pivot_table_calculation_2.columns:
                pivot_table_calculation_2[state] = 0

        for j, final_state in enumerate(final_states):
            original_list = final_state_mapping[final_state]
            # Filter columns in pivot only
            existing_columns = [col for col in original_list if col in pivot_table_calculation_2.columns]
            if existing_columns:
                final_values[:, j] = pivot_table_calculation_2[existing_columns].sum(axis=1)
            else:
                final_values[:, j] = 0

        fig, ax = plt.subplots(figsize=(8,5))

        for i, state in enumerate(final_states):
            color = state_colors.get(state, "#119efc")
            ax.bar(x + i*width, final_values[:, i], width=width, label=state, color=color)

        ax.set_xticks(x + width*(len(final_states)-1)/2)  # Center ticks
        ax.set_xticklabels(categories)

        ax.set_ylabel("Recuento")
        ax.set_title("Recuento de ofertas por estado")
        ax.legend()

        img_graph_4 = BytesIO()
        plt.savefig(img_graph_4, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_4.seek(0)

        return [img_graph_3, img_graph_4]

    def graphs_orders_report(self, df_graph_orders_1):
        df_p = df_graph_orders_1[df_graph_orders_1['N췈 Pedido'].str.startswith('P-')]
        df_pa = df_graph_orders_1[df_graph_orders_1['N췈 Pedido'].str.startswith('PA-')]

        sum_amount = pd.Series({
            'P': df_p['Importe Pedido'].sum(),
            'PA': df_pa['Importe Pedido'].sum()
        })

        count = pd.Series({
            'P': df_p.shape[0],
            'PA': df_pa.shape[0]
        })

        fig, ax = plt.subplots(figsize=(8,5))
        sum_amount.plot(kind='bar', color=['green', 'yellow'])
        ax.yaxis.set_major_formatter(FuncFormatter(self.euro_format_axis))
        ax.set_xticklabels(sum_amount.index, rotation=0)
        ax.set_title('Suma de Importe por Tipo de Pedido')
        ax.set_ylabel('Suma Importe')
        ax.set_xlabel('Tipo Pedido')

        img_graph_5 = BytesIO()
        plt.savefig(img_graph_5, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_5.seek(0)

        fig, ax = plt.subplots(figsize=(8,5))
        count.plot(kind='bar', color=['green', 'yellow'])
        ax.set_xticklabels(count.index, rotation=0)
        ax.set_title('Recuento por Tipo de Pedido')
        ax.set_ylabel('Recuento')
        ax.set_xlabel('Tipo Pedido')

        img_graph_6 = BytesIO()
        plt.savefig(img_graph_6, format='PNG', bbox_inches='tight')
        plt.close()
        img_graph_6.seek(0)

        return [img_graph_5, img_graph_6]

    def report_orders(self):
        query_orders = (r"""
                    SELECT p.num_order, o.responsible, o.client, o.final_client, o.material, p.items_number, p.order_date, p.expected_date,
                    p.material_available, p.recep_date_workshop, p.porc_workshop, p.expected_date_workshop, p.expected_date_assembly, p.percent_sent_workshop,
                    COALESCE(
                        CAST(
                            NULLIF(
                                REGEXP_REPLACE(o.delivery_time, '.*?(\d+)[^\d]+(\d+).*', '\2'), -- take second number
                                ''
                            ) AS INTEGER
                        ),
                        0
                    ) AS deliv_time_num,
                    p.porc_deliveries, p.last_date_deliveries, p.regularisation, p.notes, p.notes_technical, p.order_amount, p.closed,
                    pt.variable, p.total_charged
                    FROM orders as p
                    LEFT JOIN offers as o ON p.num_offer = o.num_offer
                    LEFT JOIN product_type as pt ON o.material = pt.material
                    WHERE p.num_order NOT LIKE 'PA%' AND p.total_charged IS NULL""")

        query_order_amount = ("""
                SELECT num_order, SUM(amount) AS total_amount_tags FROM (
                SELECT num_order, amount FROM tags_data.tags_flow

                UNION ALL

                SELECT num_order, amount FROM tags_data.tags_temp

                UNION ALL

                SELECT num_order, amount FROM tags_data.tags_level

                UNION ALL

                SELECT num_order, amount FROM tags_data.tags_others
                ) AS combined
                GROUP BY num_order
                """)

        query_docs = ("""
                    SELECT 
                    num_order,
                    COUNT(num_doc_eipsa) AS total_docs,
                    SUM(CASE WHEN state IS NULL OR state = '' THEN 1 ELSE 0 END) AS count_no_sent,
                    SUM(CASE WHEN state = 'Enviado' THEN 1 ELSE 0 END) AS count_sent,
                    SUM(CASE WHEN state LIKE 'Com%' THEN 1 ELSE 0 END) AS count_comment,
                    SUM(CASE WHEN state LIKE 'Eli%' THEN 1 ELSE 0 END) AS count_deleted,
                    SUM(CASE WHEN state LIKE 'Ap%' THEN 1 ELSE 0 END) AS count_approved,
                    COALESCE(
                        TO_CHAR(MIN(CASE WHEN doc_type_id IN (1, 16) THEN TO_DATE(date_first_rev, 'DD/MM/YYYY') END), 'DD/MM/YYYY'),
                        ''
                    ) AS min_date_sent_drawings,
                    COALESCE(
                        TO_CHAR(MAX(CASE WHEN state = 'Aprobado' AND doc_type_id IN (1, 16) THEN TO_DATE(state_date, 'DD/MM/YYYY') END), 'DD/MM/YYYY'),
                        ''
                    ) AS max_date_approved_drawings,
                    COALESCE(
                        TO_CHAR(MIN(CASE WHEN doc_type_id = 6 THEN TO_DATE(date_first_rev, 'DD/MM/YYYY') END), 'DD/MM/YYYY'),
                        ''
                    ) AS min_date_sent_dossier,
                    COALESCE(
                        TO_CHAR(MAX(CASE WHEN state = 'Aprobado' AND doc_type_id = 6 THEN TO_DATE(state_date, 'DD/MM/YYYY') END), 'DD/MM/YYYY'),
                        ''
                    ) AS max_date_approved_dossier
                FROM documentation
                GROUP BY num_order
                """)

        query_tags_fab = ("""
                SELECT num_order, MAX(date_final_fab) AS max_date_fab FROM (
                SELECT num_order, final_verif_dim_date AS date_final_fab FROM tags_data.tags_flow
                UNION ALL
                SELECT num_order, final_verif_of_eq_date AS date_final_fab FROM tags_data.tags_flow

                UNION ALL

                SELECT num_order, final_verif_dim_date AS date_final_fab FROM tags_data.tags_temp
                UNION ALL
                SELECT num_order, final_verif_of_eq_date AS date_final_fab FROM tags_data.tags_temp
                UNION ALL
                SELECT num_order, final_verif_of_sensor_date AS date_final_fab FROM tags_data.tags_temp

                UNION ALL

                SELECT num_order, final_verif_dim_date AS date_final_fab FROM tags_data.tags_level
                UNION ALL
                SELECT num_order, final_verif_of_eq_date AS date_final_fab FROM tags_data.tags_level

                UNION ALL

                SELECT num_order, final_verif_dim_date AS date_final_fab FROM tags_data.tags_others
                UNION ALL
                SELECT num_order, final_verif_of_eq_date AS date_final_fab FROM tags_data.tags_others
                ) AS combined
                GROUP BY num_order
                """)

        query_tags_insp = ("""
                SELECT num_order, SUM(items_inspected) AS items_inspected_count FROM (
                SELECT num_order, SUM(CASE WHEN inspection IS NOT NULL THEN 1 ELSE 0 END) AS items_inspected FROM tags_data.tags_flow
                GROUP BY num_order

                UNION ALL

                SELECT num_order, SUM(CASE WHEN inspection IS NOT NULL THEN 1 ELSE 0 END) AS items_inspected FROM tags_data.tags_temp
                GROUP BY num_order

                UNION ALL

                SELECT num_order, SUM(CASE WHEN inspection IS NOT NULL THEN 1 ELSE 0 END) AS items_inspected FROM tags_data.tags_level
                GROUP BY num_order

                UNION ALL

                SELECT num_order, SUM(CASE WHEN inspection IS NOT NULL THEN 1 ELSE 0 END) AS items_inspected FROM tags_data.tags_others
                GROUP BY num_order
                ) AS combined
                GROUP BY num_order
                """)

        query_tags_fact = ("""
                SELECT num_order, SUM(percent_amount_fact) AS percent_fact, SUM(amount_fact) AS total_fact FROM (
                SELECT num_order, (amount_fact::numeric * COALESCE(percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact FROM tags_data.tags_flow

                UNION ALL

                SELECT num_order, (amount_fact::numeric * COALESCE(percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact FROM tags_data.tags_temp

                UNION ALL

                SELECT num_order, (amount_fact::numeric * COALESCE(percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact FROM tags_data.tags_level

                UNION ALL

                SELECT num_order, (amount_fact::numeric * COALESCE(percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact FROM tags_data.tags_others
                ) AS combined
                GROUP BY num_order
                """)

        query_tags_charged = ("""
                SELECT combined.num_order, SUM(combined.percent_amount_fact) AS percent_charged, SUM(combined.amount_fact) AS total_charged
                FROM (
                    SELECT t.num_order, (t.amount_fact::numeric * COALESCE(t.percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact
                    FROM tags_data.tags_flow AS t
                    JOIN purch_fact.invoice_header AS i
                    ON t.invoice_number = i.num_invoice
                    WHERE t.invoice_number IS NOT NULL and i.pay_date IS NOT NULL

                    UNION ALL

                    SELECT t.num_order, (t.amount_fact::numeric * COALESCE(t.percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact
                    FROM tags_data.tags_temp AS t
                    JOIN purch_fact.invoice_header AS i
                    ON t.invoice_number = i.num_invoice
                    WHERE t.invoice_number IS NOT NULL and i.pay_date IS NOT NULL

                    UNION ALL

                    SELECT t.num_order, (t.amount_fact::numeric * COALESCE(t.percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact
                    FROM tags_data.tags_level AS t
                    JOIN purch_fact.invoice_header AS i
                    ON t.invoice_number = i.num_invoice
                    WHERE t.invoice_number IS NOT NULL and i.pay_date IS NOT NULL

                    UNION ALL

                    SELECT t.num_order, (t.amount_fact::numeric * COALESCE(t.percent_invoiced, 0) / 100.0) AS percent_amount_fact, amount_fact
                    FROM tags_data.tags_others AS t
                    JOIN purch_fact.invoice_header AS i
                    ON t.invoice_number = i.num_invoice
                    WHERE t.invoice_number IS NOT NULL and i.pay_date IS NOT NULL
                ) AS combined
                GROUP BY combined.num_order
                """)

        final_query_1 = (f"""
                        SELECT query1."num_order", query1."responsible", query1."client", query1."final_client", query1."material", query1."items_number",
                        TO_CHAR(query1."order_date", 'DD/MM/YYYY') AS order_date, TO_CHAR(query1."expected_date", 'DD/MM/YYYY') AS expected_date,
                        query3."total_docs", query3."count_no_sent", query3."count_sent", query3."count_comment", query3."count_deleted", query3."count_approved",
                        query3."min_date_sent_drawings",
                        query3."max_date_approved_drawings",
                        query1."recep_date_workshop", query1."percent_sent_workshop",
                        
                        CASE 
                            WHEN query3."max_date_approved_drawings" IS NULL OR query3."max_date_approved_drawings" = '' THEN
                                TO_CHAR(query1."expected_date", 'DD/MM/YYYY')
                            ELSE 
                                TO_CHAR((
                                WITH fechas_validas AS (
                                    SELECT d::date
                                    FROM generate_series(
                                        TO_DATE(query3."max_date_approved_drawings", 'DD/MM/YYYY'),
                                        TO_DATE(query3."max_date_approved_drawings", 'DD/MM/YYYY') + INTERVAL '1 year',
                                        INTERVAL '1 day'
                                    ) AS d
                                    WHERE EXTRACT(MONTH FROM d) <> 8  -- excluir agosto
                                    ORDER BY d
                                )
                                SELECT d
                                FROM fechas_validas
                                OFFSET GREATEST(COALESCE(query1."deliv_time_num", 0) * 7 - 1, 0)
                                LIMIT 1
                            ), 'DD/MM/YYYY')
                        END AS new_contractual_date,
                        
                        query1."material_available", 
                        query1."porc_workshop", query1."expected_date_workshop", query1."expected_date_assembly",
                        TO_CHAR(query4."max_date_fab", 'DD/MM/YYYY') AS max_date_fab,
                        query5."items_inspected_count",
                        query3."min_date_sent_dossier",
                        query3."max_date_approved_dossier",
                        query1. "porc_deliveries", query1."last_date_deliveries",
                        (query6.percent_fact::numeric / NULLIF(query6.total_fact::numeric, 0) * 100)::numeric(10,2) AS fact_percent,
                        (query7.percent_charged::numeric / NULLIF(query7.total_charged::numeric, 0) * 100)::numeric(10,2) AS charged_percent,
                        query1."regularisation", query1."notes", query1."notes_technical",
                        query6."total_fact", query2."total_amount_tags", query1."order_amount", query1."variable"
                        FROM ({query_orders}) AS query1
                        
                        LEFT JOIN ({query_order_amount}) AS query2 ON query1."num_order" = query2."num_order"
                        LEFT JOIN ({query_docs}) AS query3 ON query1."num_order" = query3."num_order"
                        LEFT JOIN ({query_tags_fab}) AS query4 ON query1."num_order" = query4."num_order"
                        LEFT JOIN ({query_tags_insp}) AS query5 ON query1."num_order" = query5."num_order"
                        LEFT JOIN ({query_tags_fact}) AS query6 ON query1."num_order" = query6."num_order"
                        LEFT JOIN ({query_tags_charged}) AS query7 ON query1."num_order" = query7."num_order"
                        WHERE query1.closed IS NULL AND query1.num_order NOT LIKE '%R%'
                        ORDER BY query1."num_order" ASC
                        """)

        final_query_2 = (f"""
                        SELECT query1."variable", COUNT(query1."num_order"),
                        SUM(query2."total_amount_tags"::numeric) AS total_order_amount,
                        ROUND((SUM(query3."total_fact"::numeric) / SUM(query2."total_amount_tags"::numeric) * 100), 2) AS fact_percent,
                        ROUND((SUM(query4."total_charged"::numeric) / SUM(query2."total_amount_tags"::numeric) * 100), 2) AS charged_percent,
                        (SUM(query2."total_amount_tags"::numeric) - SUM(query3."total_fact"::numeric)) AS pending
                        FROM ({query_orders}) AS query1
                        LEFT JOIN ({query_order_amount}) AS query2 ON query1."num_order" = query2."num_order"
                        LEFT JOIN ({query_tags_fact}) AS query3 ON query1."num_order" = query3."num_order"
                        LEFT JOIN ({query_tags_charged}) AS query4 ON query1."num_order" = query4."num_order"
                        GROUP BY query1."variable"
                        ORDER BY query1."variable" ASC
                        """)

        columns_1 = ['PEDIDO', 'RESPONSABLE', 'CLIENTE', 'CLIENTE FINAL', 'MATERIAL', 'N췈 EQUIPOS',
                    'FECHA PO', 'FECHA CONT.',
                    'DOCS TOTALES', 'DOCS NO ENV.', 'DOCS ENV.', 'DOCS COM.', 'DOCS ELIM.', 'DOCS AP.', 
                    'FECHA ENV PLANOS', 'FECHA AP PLANOS',
                    'FECHA ENV FAB.', '% ENV FAB',
                    'NUEVA FECHA CONT.',
                    'MAT. DISP.', '% FAB', 'PREV. FAB', 'PREV. MONT.',
                    'FECHA FINAL FAB.',
                    'EQS INSPEC.',
                    'FECHA ENV DOSSIER', 'FECHA AP DOSSIER',
                    '% ENV.', 'FECHA ENV칈O',
                    '% FACT.',
                    '% COBRADO',
                    'ORDENES CAMBIO', 'NOTAS', 'NOTAS T칄CNICAS', 'IMPORTE', 'IMPORTE PO TAGS', 'IMPORTE PO', 'VARIABLE']

        columns_2 = ['VARIABLE', 'N췈 PEDIDOS', 'IMPORTE TOTAL', '% FACT.', '% COBRADO', 'PTE FACTURAR']

        with Database_Connection(config()) as conn:
            with conn.cursor() as cur:
                cur.execute(final_query_1)
                results_1 = cur.fetchall()

                cur.execute(final_query_2)
                results_2 = cur.fetchall()

            df_1 = pd.DataFrame(results_1, columns=columns_1)
            df_1 = df_1.fillna('')
            df_1.replace('None', '')

            df_1['IMPORTE'] = (
                df_1['IMPORTE']
                .str.replace('', '', regex=False)
                .str.replace('.', '', regex=False)
                .str.replace(',', '.', regex=False)
            )

            df_1['IMPORTE PO TAGS'] = (
                df_1['IMPORTE PO TAGS']
                .str.replace('', '', regex=False)
                .str.replace('.', '', regex=False)
                .str.replace(',', '.', regex=False)
            )

            df_1['IMPORTE PO'] = (
                df_1['IMPORTE PO']
                .str.replace('', '', regex=False)
                .str.replace('.', '', regex=False)
                .str.replace(',', '.', regex=False)
            )

            df_1['IMPORTE'] = df_1.apply(
                lambda row: float(row['IMPORTE'].strip()) if row['IMPORTE'].strip() != '' else
                (float(row['IMPORTE PO TAGS']) if row['IMPORTE PO TAGS'].strip() != '' else
                (float(row['IMPORTE PO']) if row['IMPORTE PO'].strip() != '' else '')),
                axis=1)

            df_2 = df_1.copy()

            df_2['% FACT.'] = pd.to_numeric(df_2['% FACT.'], errors='coerce').fillna(0)
            df_2['% COBRADO'] = pd.to_numeric(df_2['% COBRADO'], errors='coerce').fillna(0)

            df_2['IMPORTE FACTURADO'] = df_2['IMPORTE'] * (df_2['% FACT.'] / 100)
            df_2['IMPORTE COBRADO'] = df_2['IMPORTE'] * (df_2['% COBRADO'] / 100)

            summary = df_2.groupby('VARIABLE').agg(
                **{
                    'N췈 PEDIDOS': ('PEDIDO', 'count'),
                    'IMPORTE TOTAL': ('IMPORTE', 'sum'),
                    'IMPORTE FACTURADO': ('IMPORTE FACTURADO', 'sum'),
                    'IMPORTE COBRADO': ('IMPORTE COBRADO', 'sum'),
                }
            ).reset_index()

            summary['% FACT.'] = (summary['IMPORTE FACTURADO'] / summary['IMPORTE TOTAL'] * 100).round(2)
            summary['% COBRADO'] = (summary['IMPORTE COBRADO'] / summary['IMPORTE TOTAL'] * 100).round(2)
            summary['PTE FACTURAR'] = (summary['IMPORTE TOTAL'] - summary['IMPORTE FACTURADO']).round(2)

            summary = summary[columns_2]

            df_3 = pd.read_excel(r'\\nas01\DATOS\Comunes\Ana\CP\informe_estructurado.xlsx')

            order_reports(df_1, summary, df_3)



# if __name__ == "__main__":
#     import sys
#     app = QtWidgets.QApplication(sys.argv)
#     App_Comercial = QtWidgets.QMainWindow()
#     ui = Ui_App_Comercial()
#     ui.setupUi(App_Comercial)
#     App_Comercial.showMaximized()
#     sys.exit(app.exec())