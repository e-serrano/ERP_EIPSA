# Form implementation generated from reading ui file 'ImportTAG_Window.ui'
#
# Created by: PySide6 UI code generator 6.4.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic6 is
# run again.  Do not edit this file unless you know what you are doing.

import sys
from PySide6 import QtCore, QtGui, QtWidgets
import pandas as pd
import psycopg2
from config import config
import os
from openpyxl import load_workbook
from openpyxl.worksheet.datavalidation import DataValidation
from utils.Show_Message import MessageHelper
from utils.Database_Manager import Database_Connection

basedir = r"\\ERP-EIPSA-DATOS\Comunes\EIPSA-ERP"


class Ui_ImportTAG_Window(object):
    """
    UI class for the Import tag window.
    """
    def setupUi(self, ImportTAG_Window):
        """
        Sets up the user interface for the ImportTAG_Window.

        Args:
            ImportTAG_Window (QtWidgets.QMainWindow): The main window for the UI setup.
        """
        ImportTAG_Window.setObjectName("ImportTAG_Window")
        ImportTAG_Window.resize(640, 330)
        ImportTAG_Window.setMinimumSize(QtCore.QSize(640, 330))
        ImportTAG_Window.setMaximumSize(QtCore.QSize(640, 330))
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap(os.path.abspath(os.path.join(basedir, "Resources/Iconos/icon.ico"))), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        ImportTAG_Window.setWindowIcon(icon)
        ImportTAG_Window.setStyleSheet(
"QPushButton {\n"
"background-color: #33bdef;\n"
"  border: 1px solid transparent;\n"
"  border-radius: 3px;\n"
"  color: #fff;\n"
"  font-family: -apple-system,system-ui,\"Segoe UI\",\"Liberation Sans\",sans-serif;\n"
"  font-size: 15px;\n"
"  font-weight: 800;\n"
"  line-height: 1.15385;\n"
"  margin: 0;\n"
"  outline: none;\n"
"  padding: 8px .8em;\n"
"  text-align: center;\n"
"  text-decoration: none;\n"
"  vertical-align: baseline;\n"
"  white-space: nowrap;\n"
"}\n"
"\n"
"QPushButton:hover {\n"
"    background-color: #019ad2;\n"
"    border-color: rgb(0, 0, 0);\n"
"}\n"
"\n"
"QPushButton:pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border-color: rgb(255, 255, 255);\n"
"}")
        self.centralwidget = QtWidgets.QWidget(parent=ImportTAG_Window)
        self.centralwidget.setObjectName("centralwidget")
        self.gridLayout = QtWidgets.QGridLayout(self.centralwidget)
        self.gridLayout.setObjectName("gridLayout")
        self.frame = QtWidgets.QFrame(parent=self.centralwidget)
        self.frame.setFrameShape(QtWidgets.QFrame.Shape.StyledPanel)
        self.frame.setFrameShadow(QtWidgets.QFrame.Shadow.Raised)
        self.frame.setObjectName("frame")
        self.verticalLayout = QtWidgets.QVBoxLayout(self.frame)
        self.verticalLayout.setObjectName("verticalLayout")
        self.hLayout = QtWidgets.QHBoxLayout()
        self.hLayout.setObjectName("hLayout")
        self.label_SelectFile = QtWidgets.QLabel(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.label_SelectFile.setFont(font)
        self.label_SelectFile.setObjectName("label_SelectFile")
        self.hLayout.addWidget(self.label_SelectFile)
        self.Button_Select = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Select.setMinimumSize(QtCore.QSize(250, 35))
        self.Button_Select.setMaximumSize(QtCore.QSize(250, 35))
        self.Button_Select.setObjectName("Button_Select")
        self.hLayout.addWidget(self.Button_Select)
        self.verticalLayout.addLayout(self.hLayout)
        self.label_name_file = QtWidgets.QLabel(parent=self.frame)
        self.label_name_file.setMinimumSize(QtCore.QSize(0, 25))
        self.label_name_file.setMaximumSize(QtCore.QSize(16777215, 25))
        self.label_name_file.setObjectName("label_name_file")
        self.verticalLayout.addWidget(self.label_name_file)
        self.hLayout1 = QtWidgets.QHBoxLayout()
        self.hLayout1.setObjectName("hLayout1")
        self.label_ItemType = QtWidgets.QLabel(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.label_ItemType.setFont(font)
        self.label_ItemType.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeading|QtCore.Qt.AlignmentFlag.AlignLeft|QtCore.Qt.AlignmentFlag.AlignTop)
        self.label_ItemType.setObjectName("label_ItemType")
        self.hLayout1.addWidget(self.label_ItemType)
        self.vLayout = QtWidgets.QVBoxLayout()
        self.vLayout.setObjectName("vLayout")
        self.radioFlow = QtWidgets.QRadioButton(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.radioFlow.setFont(font)
        self.radioFlow.setObjectName("radioFlow")
        self.vLayout.addWidget(self.radioFlow)
        self.radioTemp = QtWidgets.QRadioButton(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.radioTemp.setFont(font)
        self.radioTemp.setObjectName("radioTemp")
        self.vLayout.addWidget(self.radioTemp)
        self.radioLevel = QtWidgets.QRadioButton(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.radioLevel.setFont(font)
        self.radioLevel.setObjectName("radioLevel")
        self.vLayout.addWidget(self.radioLevel)
        self.radioOthers = QtWidgets.QRadioButton(parent=self.frame)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.radioOthers.setFont(font)
        self.radioOthers.setObjectName("radioOthers")
        self.vLayout.addWidget(self.radioOthers)
        self.hLayout1.addLayout(self.vLayout)
        self.verticalLayout.addLayout(self.hLayout1)
        spacerItem = QtWidgets.QSpacerItem(20, 20, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
        self.verticalLayout.addItem(spacerItem)
        self.hLayout2 = QtWidgets.QHBoxLayout()
        self.hLayout2.setObjectName("hLayout2")
        self.Button_Import = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Import.setMinimumSize(QtCore.QSize(250, 35))
        self.Button_Import.setMaximumSize(QtCore.QSize(250, 35))
        self.Button_Import.setObjectName("Button_Import")
        self.hLayout2.addWidget(self.Button_Import)
        self.Button_Cancel = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Cancel.setMinimumSize(QtCore.QSize(250, 35))
        self.Button_Cancel.setMaximumSize(QtCore.QSize(250, 35))
        self.Button_Cancel.setObjectName("Button_Cancel")
        self.hLayout2.addWidget(self.Button_Cancel)
        self.verticalLayout.addLayout(self.hLayout2)
        self.gridLayout.addWidget(self.frame, 0, 0, 1, 1)
        ImportTAG_Window.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(parent=ImportTAG_Window)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 640, 22))
        self.menubar.setObjectName("menubar")
        ImportTAG_Window.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(parent=ImportTAG_Window)
        self.statusbar.setObjectName("statusbar")
        ImportTAG_Window.setStatusBar(self.statusbar)

        self.retranslateUi(ImportTAG_Window)
        self.Button_Cancel.clicked.connect(ImportTAG_Window.close)
        self.Button_Select.clicked.connect(self.browsefiles) # type: ignore
        self.Button_Import.clicked.connect(self.importtag)

        QtCore.QMetaObject.connectSlotsByName(ImportTAG_Window)


# Function to translate and updates the text of various UI elements
    def retranslateUi(self, ImportTAG_Window):
        """
        Translates and updates the text of various UI elements.
        """
        _translate = QtCore.QCoreApplication.translate
        ImportTAG_Window.setWindowTitle(_translate("ImportTAG_Window", "Importar TAG"))
        self.label_SelectFile.setText(_translate("ImportTAG_Window", "Seleccionar archivo:"))
        self.Button_Select.setText(_translate("ImportTAG_Window", "Seleccionar"))
        self.label_name_file.setText(_translate("ImportTAG_Window", ""))
        self.label_ItemType.setText(_translate("ImportTAG_Window", "Tipo de equipo:"))
        self.radioFlow.setText(_translate("ImportTAG_Window", "Caudal"))
        self.radioTemp.setText(_translate("ImportTAG_Window", "Temperatura"))
        self.radioLevel.setText(_translate("ImportTAG_Window", "Nivel"))
        self.radioOthers.setText(_translate("ImportTAG_Window", "Otros"))
        self.Button_Import.setText(_translate("ImportTAG_Window", "Importar"))
        self.Button_Cancel.setText(_translate("ImportTAG_Window", "Cancelar"))


    def browsefiles(self):
        """
        Opens a file dialog for the user to select an Excel file.
        """
        self.fname, _ = QtWidgets.QFileDialog.getOpenFileName(None, "Seleccionar archivo Excel", "", "Archivos de Excel (*.xlsx)")
        if self.fname:
            self.label_name_file.setText("Archivo: " + self.fname)


    def importtag(self):
        """
        Imports excel file and insert tags data.
        """
        if self.label_name_file.text()=='':
            MessageHelper.show_message("Selecciona un archivo para importar", "warning")

        else:
            excel_file = self.label_name_file.text().split("Archivo: ")[1]
    
            # Verify if excel file is closed
            try:
                with open(excel_file, 'r+') as f:
                    pass
            except PermissionError:
                MessageHelper.show_message(
                    "El archivo Excel está abierto. Por favor, ciérralo antes de importar.", 
                    "warning"
                )
                return

        # Set config
            tag_configs = {
            'radioFlow': {
                'table_name': 'tags_data.tags_flow',
                'seq_id': 'tags_flow_id_tag_flow_seq',
                'columns_range': (1, 37),
                'required_columns': ["tag", "tag_state", "num_offer", "item_type", "line_size",
                                "rating", "facing", "schedule", "flange_material", "flange_type",
                                "tube_material", "tapping_size", "element_material", "plate_type", 
                                "plate_thk", "plate_std", "gasket_material", "bolts_material", "nuts_material", "nace"],
                'decimal_columns': ['amount', 'plate_thk'],
                'null_columns': ['num_order', 'contractual_date'],
                'validation_map': {'C':'S', 'I':'A', 'J':'B', 'K':'C', 'L':'D', 'M':'E', 'N':'F', 
                                'O':'N', 'P':'Q', 'Q':'G', 'T':'H', 'U':'I', 'V':'J', 'W':'M', 
                                'X':'K', 'Y':'T', 'Z':'U', 'AG': 'O'}
            },
            'radioTemp': {
                'table_name': 'tags_data.tags_temp',
                'seq_id': 'tags_temp_id_tag_temp_seq',
                'columns_range': (1, 39),
                'required_columns': ["tag", "tag_state", "num_offer", "item_type", "tw_type", "size", 
                                "rating", "facing", "material_tw", "root_diam", "tip_diam", 
                                "sensor_element", "sheath_stem_material", "sheath_stem_diam", 
                                "insulation", "temp_inf", "temp_sup", "nipple_ext_material", 
                                "nipple_ext_length", "head_case_material", "elec_conn_case_diam", 
                                "tt_cerblock", "material_flange_lj", "gasket_material", "puntal", 
                                "tube_t", "nace"],
                'int_columns': ['rating', 'sheath_stem_diam', 'nipple_ext_length', 'temp_inf', 
                            'temp_sup', 'root_diam', 'tip_diam'],
                'decimal_columns': ['amount', 'root_diam', 'tip_diam', 'sheath_stem_diam'],
                'null_columns': ['num_order', 'contractual_date'],
                'na_null_columns': ['std_length', 'ins_length'],
                'validation_map': {'C':'AB', 'I':'A', 'J':'B', 'K':'C', 'L':'D', 'M':'E', 'O':'F', 
                                'R':'I', 'S':'J', 'T':'L', 'U':'M', 'V':'N', 'W':'O', 'X':'P', 
                                'Y':'Q', 'Z':'R', 'AA':'S', 'AB':'T', 'AC':'U', 'AD':'V', 'AE':'W', 
                                'AF':'X', 'AG':'Z', 'AH':'AA', 'AI':'K'}
            },
            'radioLevel': {
                'table_name': 'tags_data.tags_level',
                'seq_id': 'tags_level_id_tag_level_seq',
                'columns_range': (1, 40),
                'required_columns': ["tag", "tag_state", "num_offer", "item_type", "model_num",
                                "body_material", "proc_conn_type", "proc_conn_size", "proc_conn_rating", 
                                "proc_conn_facing", "conn_type", "valve_type", "dv_conn", "dv_size", 
                                "dv_rating", "dv_facing", "gasket_mica", "stud_nuts_material", 
                                "illuminator", "float_material", "case_cover_material", "scale_type", 
                                "flags", "ip_code", "flange_type", "nipple_hex", "nipple_tub", 
                                "antifrost", "nace"],
                'int_columns': ['proc_conn_rating', 'dv_rating'],
                'decimal_columns': ['amount'],
                'null_columns': ['num_order', 'contractual_date'],
                'na_null_columns': ['visibility', 'cc_length'],
                'validation_map': {'C':'AD', 'I':'A', 'J':'B', 'K':'C', 'L':'E', 'M':'F', 'N':'G', 
                                'O':'H', 'P':'I', 'S':'J', 'T':'K', 'U':'L', 'V':'M', 'W':'N', 
                                'X':'O', 'Y':'P', 'Z':'Q', 'AA':'R', 'AB':'S', 'AC':'T', 'AD':'U', 
                                'AE':'V', 'AF':'W', 'AG':'X', 'AH':'X', 'AI':'Y', 'AJ':'D'}
            },
            'radioOthers': {
                'table_name': 'tags_data.tags_others',
                'seq_id': 'tags_others_id_tag_others_seq',
                'columns_range': (1, 15),
                'required_columns': ["tag", "tag_state", "num_offer", "description", "nace"],
                'decimal_columns': ['amount'],
                'null_columns': ['num_order', 'contractual_date'],
                'validation_map': {'C':'A', 'K':'B'}
            }
        }

        # Select active config
        config_key = next((key for key in tag_configs.keys() if getattr(self, key).isChecked()), None)
        if not config_key:
            MessageHelper.show_message("Selecciona un tipo de tag", "warning")
            return

        config_tags = tag_configs[config_key]
        wb = None

        try:
        # Load Excel data
            df_table = pd.read_excel(
                excel_file, 
                na_values=['N/A'], 
                keep_default_na=False, 
                skiprows=7, 
                dtype={'plate_thk': str}
            )
            df_table = df_table.astype(str).replace('nan', 'N/A')
            df_final = df_table.iloc[:, config_tags['columns_range'][0]:config_tags['columns_range'][1]]

        # Validate required columns
            empty_columns = [col for col in config_tags['required_columns'] if df_table[col].eq('').sum() > 0]
            if empty_columns:
                MessageHelper.show_message(
                    f"Las siguientes columnas no pueden tener celdas vacías:\n{', '.join(empty_columns)}\n\n"
                    "El Excel no se importará", 
                    "warning"
                )
                return

        # Load workbook
            wb = load_workbook(self.fname)
            ws = wb["Import"]

            with Database_Connection(config()) as conn:
                with conn.cursor() as cursor:
                    # Obtain next ID
                    sql_query_id = (
                        f"SELECT last_value FROM pg_sequences "
                        f"WHERE schemaname = 'tags_data' AND sequencename = '{config_tags['seq_id']}'"
                    )
                    cursor.execute(sql_query_id)
                    id_tag = int(cursor.fetchone()[0]) + 1

                    # Procesar cada fila
                    for index, row in df_final.iterrows():
                        cell_value = ws[f'A{index+9}'].value

                        # Solo procesar filas sin ID
                        if cell_value is None or str(cell_value).strip() == '':
                            # Preparar datos para inserción
                            columns_values = [
                                (column, row[column]) 
                                for column in df_final.columns 
                                if not pd.isnull(row[column])
                            ]

                            columns = ', '.join([column for column, _ in columns_values])

                            # Format values according to config_tags
                            formatted_values = []
                            for column, value in columns_values:
                                # Replace float to integer
                                if config_tags.get('int_columns') and column in config_tags['int_columns'] and value.endswith('.0'):
                                    formatted_values.append(f"'{int(float(value))}'")
                                # Replace decimal point
                                elif config_tags.get('decimal_columns') and column in config_tags['decimal_columns']:
                                    formatted_values.append(f"'{value.replace('.', ',')}'")
                                # Replace nan to Null
                                elif config_tags.get('na_null_columns') and column in config_tags['na_null_columns'] and value == 'N/A':
                                    formatted_values.append('NULL')
                                # Replace blank fot NULL
                                elif config_tags.get('null_columns') and column in config_tags['null_columns'] and value == '':
                                    formatted_values.append('NULL')
                                # Standard value
                                else:
                                    formatted_values.append(f"'{value}'")

                            values = ', '.join(formatted_values)

                            # Insert data into DataBase
                            sql_insertion = f"INSERT INTO {config_tags['table_name']} ({columns}) VALUES ({values})"
                            cursor.execute(sql_insertion)
                            
                            # Update Excel file with new IDs
                            ws[f'A{index+9}'] = id_tag
                            id_tag += 1
                    
                    # Apply data validation
                    for key, value in config_tags['validation_map'].items():
                        formula = f'=OFFSET(Validatos!${value}$1, 1, 0, COUNTA(Validatos!${value}:${value})-1, 1)'
                        dv = DataValidation(type="list", formula1=formula, allow_blank=False)
                        ws.add_data_validation(dv)
                        dv.add(f'{key}9:{key}2000')

                    conn.commit()

            wb.save(self.fname)
            MessageHelper.show_message("Datos importados con éxito", "info")
            
        except (Exception, psycopg2.DatabaseError) as error:
            error_msg = str(error).splitlines()
            tag_name = df_final.iloc[0, 0] if not df_final.empty else "desconocido"
            MessageHelper.show_message(
                f"<html><body>Error con el tag <b>{tag_name}:</b><br><br>"
                f"{error_msg[1] if len(error_msg) > 1 else error_msg[0]}<br><br>"
                "<b><u>NO SE REALIZARÁ LA IMPORTACIÓN</u></b></body></html>", 
                "critical"
            )
        finally:
            if wb is not None:
                del wb



if __name__ == "__main__":
    app = QtWidgets.QApplication(sys.argv)
    ImportTAG_Window = QtWidgets.QMainWindow()
    ui = Ui_ImportTAG_Window()
    ui.setupUi(ImportTAG_Window)
    ImportTAG_Window.show()
    sys.exit(app.exec())
