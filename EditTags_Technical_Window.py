# Form implementation generated from reading ui file 'EditTags_Commercial_Window.ui'
#
# Created by: PyQt6 UI code generator 6.4.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic6 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt6 import QtCore, QtGui, QtWidgets
from PyQt6 import QtSql
from PyQt6.QtWidgets import QApplication
import re
import configparser
from Database_Connection import createConnection
from config import config
import psycopg2
from PyQt6.QtCore import Qt
from PyQt6.QtGui import QKeySequence, QTextDocument, QTextCursor
import locale
from Excel_Export_Templates import material_order
import pandas as pd
from openpyxl import load_workbook
from copy import deepcopy
from tkinter.filedialog import asksaveasfilename
from tkinter import Tk
from datetime import *


def imagen_to_base64(imagen):
    buffer = QtCore.QBuffer()
    buffer.open(QtCore.QIODevice.OpenModeFlag.WriteOnly)
    imagen.save(buffer, "PNG")
    base64_data = buffer.data().toBase64().data().decode()
    return base64_data


class CheckboxWidget(QtWidgets.QWidget):
    def __init__(self, text):
        super().__init__()
        layout = QtWidgets.QHBoxLayout(self)
        self.checkbox = QtWidgets.QCheckBox(text)
        layout.addWidget(self.checkbox)


class AlignDelegate(QtWidgets.QStyledItemDelegate):
    def initStyleOption(self, option, index):
        super(AlignDelegate, self).initStyleOption(option, index)
        option.displayAlignment = QtCore.Qt.AlignmentFlag.AlignCenter


class EditableComboBoxDelegate(QtWidgets.QStyledItemDelegate):
    def __init__(self, parent=None, options=None):
        super().__init__(parent)
        self.options = options

    def createEditor(self, parent, option, index):
        editor = QtWidgets.QComboBox(parent)
        editor.setEditable(True)
        return editor

    def setEditorData(self, editor, index):
        text = index.data(Qt.ItemDataRole.DisplayRole)
        editor.addItems(self.options)
        editor.setEditText(text)

    def setModelData(self, editor, model, index):
        model.setData(index, editor.currentText(), Qt.ItemDataRole.EditRole)


class CustomProxyModel(QtCore.QSortFilterProxyModel):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._filters = dict()
        self.header_names = {}

    @property
    def filters(self):
        return self._filters

    def setFilter(self, expresion, column, action_name=None):
        if expresion or expresion == '':
            if column in self.filters:
                if action_name or action_name == '':
                    self.filters[column].remove(expresion)
                else:
                    self.filters[column].append(expresion)
            else:
                self.filters[column] = [expresion]
        elif column in self.filters:
            if action_name or action_name == '':
                self.filters[column].remove(expresion)
                if not self.filters[column]:
                    del self.filters[column]
            else:
                del self.filters[column]
        self.invalidateFilter()


    def filterAcceptsRow(self, source_row, source_parent):
        for column, expresions in self.filters.items():
            text = self.sourceModel().index(source_row, column, source_parent).data()

            if isinstance(text, QtCore.QDate): #Check if filters are QDate. If True, convert to text
                text = text.toString("yyyy-MM-dd")

            for expresion in expresions:
                if expresion == '':  # Si la expresión es vacía, coincidir con celdas vacías
                    if text == '':
                        break

                elif re.fullmatch(r'^(?:3[01]|[12][0-9]|0?[1-9])([\-/.])(0?[1-9]|1[1-2])\1\d{4}$', expresion):
                    expresion = QtCore.QDate.fromString(expresion, "dd/MM/yyyy")
                    expresion = expresion.toString("yyyy-MM-dd")
                    regex = QtCore.QRegularExpression(f".*{re.escape(expresion)}.*", QtCore.QRegularExpression.PatternOption.CaseInsensitiveOption)
                    if regex.match(str(text)).hasMatch():
                        break

                else:
                    regex = QtCore.QRegularExpression(f".*{re.escape(expresion)}.*", QtCore.QRegularExpression.PatternOption.CaseInsensitiveOption)
                    if regex.match(str(text)).hasMatch():
                        break
            else:
                return False
        return True


class EditableTableModel(QtSql.QSqlTableModel):
    updateFailed = QtCore.pyqtSignal(str)

    def __init__(self, parent=None):
        super().__init__(parent)
        # self.originalData = {}
        # self.modifiedCells = []

    def setAllColumnHeaders(self, headers):
        for column, header in enumerate(headers):
            self.setHeaderData(column, Qt.Orientation.Horizontal, header, Qt.ItemDataRole.DisplayRole)

    def setIndividualColumnHeader(self, column, header):
        self.setHeaderData(column, Qt.Orientation.Horizontal, header, Qt.ItemDataRole.DisplayRole)

    def setIconColumnHeader(self, column, icon):
        self.setHeaderData(column, QtCore.Qt.Orientation.Horizontal, icon, Qt.ItemDataRole.DecorationRole)

    def headerData(self, section, orientation, role=Qt.ItemDataRole.DisplayRole):
        if role == Qt.ItemDataRole.DisplayRole and orientation == Qt.Orientation.Horizontal:
            return super().headerData(section, orientation, role)
        return super().headerData(section, orientation, role)

    def flags(self, index):
        flags = super().flags(index)
        if index.column() in range (0,8):
            flags &= ~Qt.ItemFlag.ItemIsEditable
            return flags | Qt.ItemFlag.ItemIsSelectable | Qt.ItemFlag.ItemIsEnabled
        else:
            return flags | Qt.ItemFlag.ItemIsSelectable | Qt.ItemFlag.ItemIsEnabled | Qt.ItemFlag.ItemIsEditable 

    # def setOriginalData(self, index, value, role=Qt.ItemDataRole.EditRole):
    #     if index.isValid() and role == Qt.ItemDataRole.EditRole:
    #         row = index.row()
    #         column = index.column()
    #         self.originalData[(row, column)] = self.data(index)  # Saving the original data before edition
    #     return super().setData(index, value, role)

    # def getOriginalValue(self, index):
    #     row = index.row()
    #     column = index.column()
    #     return self.originalData.get(column)

    # def update_record(self, record, index):
    #     query = QSqlQuery(self.database())
    #     primary_key = self.primaryKey()
    #     id_column = primary_key.fieldName(0)

    #     column_index = index.column() # Obtaining modified column index from modified cell index
    #     column_name = self.record().fieldName(column_index) # Obtaining modified column name
    #     new_value = index.data(Qt.ItemDataRole.EditRole) #Obtaining new value
    #     old_value = self.originalData.get(column_index, "") # Obtaining old value

    #     # Verify if values are NULL
    #     if new_value is None:
    #         new_value = ""
    #     if old_value is None:
    #         old_value = ""

    #     query.prepare(f"UPDATE {self.tableName()} SET {column_name} = :newValue WHERE {id_column} = :id")
    #     query.bindValue(":newValue", new_value)
    #     query.bindValue(":id", record.value(id_column))

    #     query.exec()
    #     query_text = query.executedQuery()
    #     # print("SQL Query:", query_text)

    #     if query.lastError().isValid():
    #         dlg = QtWidgets.QMessageBox()
    #         new_icon = QtGui.QIcon()
    #         new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
    #         dlg.setWindowIcon(new_icon)
    #         dlg.setWindowTitle("Editar Tags")
    #         dlg.setText("Ha habido un error al actualizar los datos. No serán guardados")
    #         dlg.setIcon(QtWidgets.QMessageBox.Icon.Critical)
    #         dlg.exec()

    #         print("Error en la consulta:", query.lastError().nativeErrorCode())
    #         print("Mensaje de error:", query.lastError().text())
    #         return None
    #     else:
    #         return query_text


class EditableComboBoxDelegate(QtWidgets.QStyledItemDelegate):
    def __init__(self, parent=None, options=None):
        super().__init__(parent)
        self.options = options

    def createEditor(self, parent, option, index):
        editor = QtWidgets.QComboBox(parent)
        editor.setEditable(True)
        return editor

    def setEditorData(self, editor, index):
        text = index.data(Qt.ItemDataRole.DisplayRole)
        editor.addItems(self.options)
        editor.setEditText(text)

    def setModelData(self, editor, model, index):
        model.setData(index, editor.currentText(), Qt.ItemDataRole.EditRole)


class Ui_EditTags_Window(QtWidgets.QMainWindow):
    def __init__(self,name):
        super().__init__()
        self.model = EditableTableModel()
        self.proxy = CustomProxyModel()
        self.checkbox_states = {}
        self.dict_valuesuniques = {}
        self.dict_ordersort = {}
        self.hiddencolumns = []
        self.setupUi(self)
        self.model.dataChanged.connect(self.saveChanges)
        self.name = name
        self.variable = ''

    def setupUi(self, EditTags_Window):
        EditTags_Window.setObjectName("EditTags_Window")
        EditTags_Window.resize(790, 595)
        EditTags_Window.setMinimumSize(QtCore.QSize(790, 595))
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        EditTags_Window.setWindowIcon(icon)
        EditTags_Window.setStyleSheet(
".QFrame {\n"
"    border: 2px solid black;\n"
"}")
        self.centralwidget = QtWidgets.QWidget(parent=EditTags_Window)
        self.centralwidget.setStyleSheet("background-color: rgb(255, 255, 255);")
        self.centralwidget.setObjectName("centralwidget")
        self.gridLayout = QtWidgets.QGridLayout(self.centralwidget)
        self.gridLayout.setObjectName("gridLayout")
        self.frame = QtWidgets.QFrame(parent=self.centralwidget)
        self.frame.setFrameShape(QtWidgets.QFrame.Shape.StyledPanel)
        self.frame.setFrameShadow(QtWidgets.QFrame.Shadow.Raised)
        self.frame.setObjectName("frame")
        self.gridLayout_2 = QtWidgets.QGridLayout(self.frame)
        self.gridLayout_2.setVerticalSpacing(10)
        self.gridLayout_2.setObjectName("gridLayout_2")
        self.hcab=QtWidgets.QHBoxLayout()
        self.hcab.setObjectName("hcab")
        # self.toolSave = QtWidgets.QToolButton(self.frame)
        # self.toolSave.setObjectName("Save_Button")
        # self.hcab.addWidget(self.toolSave)
        # icon = QtGui.QIcon()
        # icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Save.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        # self.toolSave.setIcon(icon)
        # self.hcabspacer1=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        # self.hcab.addItem(self.hcabspacer1)
        self.toolDeleteFilter = QtWidgets.QToolButton(self.frame)
        self.toolDeleteFilter.setObjectName("Save_Button")
        self.hcab.addWidget(self.toolDeleteFilter)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Filter_Delete.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolDeleteFilter.setIcon(icon)
        self.toolDeleteFilter.setIconSize(QtCore.QSize(25, 25))
        self.hcabspacer1=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer1)
        self.toolShow = QtWidgets.QToolButton(self.frame)
        self.toolShow.setObjectName("Show_Button")
        self.toolShow.setToolTip("Mostrar columnas")
        self.hcab.addWidget(self.toolShow)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Eye.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolShow.setIcon(icon)
        self.toolShow.setIconSize(QtCore.QSize(25, 25))
        self.hcabspacer2=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer2)
        self.toolMatOrder = QtWidgets.QToolButton(self.frame)
        self.toolMatOrder.setObjectName("MatOrder_Button")
        self.toolMatOrder.setToolTip("Pedido Materiales")
        self.hcab.addWidget(self.toolMatOrder)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Purchase_Order.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolMatOrder.setIcon(icon)
        self.toolMatOrder.setIconSize(QtCore.QSize(25, 25))
        self.hcabspacer3=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer3)
        self.toolFabOrder = QtWidgets.QToolButton(self.frame)
        self.toolFabOrder.setObjectName("FabOrder_Button")
        self.toolFabOrder.setToolTip("Orden Fabricación")
        self.hcab.addWidget(self.toolFabOrder)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Fab_Order.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolFabOrder.setIcon(icon)
        self.toolFabOrder.setIconSize(QtCore.QSize(25, 25))
        self.hcabspacer4=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer4)
        self.toolInspection = QtWidgets.QToolButton(self.frame)
        self.toolInspection.setObjectName("Inspection_Button")
        self.toolInspection.setToolTip("Inspeccion")
        self.hcab.addWidget(self.toolInspection)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Inspection.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolInspection.setIcon(icon)
        self.toolInspection.setIconSize(QtCore.QSize(25, 25))
        self.hcabspacer5=QtWidgets.QSpacerItem(10, 20, QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer5)
        self.toolExpExcel = QtWidgets.QToolButton(self.frame)
        self.toolExpExcel.setObjectName("ExpExcel_Button")
        self.toolExpExcel.setToolTip("Exportar a Excel")
        self.hcab.addWidget(self.toolExpExcel)
        icon = QtGui.QIcon()
        icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Excel.png"),QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        self.toolExpExcel.setIcon(icon)
        self.toolExpExcel.setIconSize(QtCore.QSize(25, 25))

        self.hcabspacer=QtWidgets.QSpacerItem(40, 20, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hcab.addItem(self.hcabspacer)
        self.gridLayout_2.addLayout(self.hcab, 0, 0, 1, 1)
        self.hLayout1 = QtWidgets.QHBoxLayout()
        self.hLayout1.setObjectName("hLayout1")
        self.label_NumOrder = QtWidgets.QLabel(parent=self.frame)
        self.label_NumOrder.setMinimumSize(QtCore.QSize(80, 25))
        self.label_NumOrder.setMaximumSize(QtCore.QSize(80, 25))
        font = QtGui.QFont()
        font.setPointSize(11)
        font.setBold(True)
        self.label_NumOrder.setFont(font)
        self.label_NumOrder.setObjectName("label_NumOrder")
        self.hLayout1.addWidget(self.label_NumOrder)
        self.Numorder_EditTags = QtWidgets.QLineEdit(parent=self.frame)
        self.Numorder_EditTags.setMinimumSize(QtCore.QSize(250, 25))
        self.Numorder_EditTags.setMaximumSize(QtCore.QSize(250, 25))
        font = QtGui.QFont()
        font.setPointSize(10)
        self.Numorder_EditTags.setFont(font)
        self.Numorder_EditTags.setObjectName("Numorder_EditTags")
        self.hLayout1.addWidget(self.Numorder_EditTags)
        self.Button_Clean = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Clean.setMinimumSize(QtCore.QSize(150, 35))
        self.Button_Clean.setMaximumSize(QtCore.QSize(150, 35))
        self.Button_Clean.setFocusPolicy(QtCore.Qt.FocusPolicy.NoFocus)
        self.Button_Clean.setStyleSheet("QPushButton {\n"
"background-color: #33bdef;\n"
"  border: 1px solid transparent;\n"
"  border-radius: 3px;\n"
"  color: #fff;\n"
"  font-family: -apple-system,system-ui,\"Segoe UI\",\"Liberation Sans\",sans-serif;\n"
"  font-size: 15px;\n"
"  font-weight: 800;\n"
"  line-height: 1.15385;\n"
"  margin: 0;\n"
"  outline: none;\n"
"  padding: 8px .8em;\n"
"  text-align: center;\n"
"  text-decoration: none;\n"
"  vertical-align: baseline;\n"
"  white-space: nowrap;\n"
"}\n"
"\n"
"QPushButton:hover {\n"
"    background-color: #019ad2;\n"
"    border-color: rgb(0, 0, 0);\n"
"}\n"
"\n"
"QPushButton:focus {\n"
"    background-color: #019ad2;\n"
"    border-color: rgb(0, 0, 0);\n"
"}\n"
"\n"
"QPushButton:pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border-color: rgb(255, 255, 255)\n"
"}\n"
"\n"
"QPushButton:focus:pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border-color: rgb(255, 255, 255);\n"
"}")
        self.Button_Clean.setObjectName("Button_Clean")
        self.gridLayout_2.addLayout(self.hLayout1, 1, 0, 1, 1)
        self.Button_Query = QtWidgets.QPushButton(parent=self.frame)
        self.Button_Query.setMinimumSize(QtCore.QSize(150, 35))
        self.Button_Query.setMaximumSize(QtCore.QSize(150, 35))
        self.Button_Query.setFocusPolicy(QtCore.Qt.FocusPolicy.NoFocus)
        self.Button_Query.setStyleSheet("QPushButton {\n"
"background-color: #33bdef;\n"
"  border: 1px solid transparent;\n"
"  border-radius: 3px;\n"
"  color: #fff;\n"
"  font-family: -apple-system,system-ui,\"Segoe UI\",\"Liberation Sans\",sans-serif;\n"
"  font-size: 15px;\n"
"  font-weight: 800;\n"
"  line-height: 1.15385;\n"
"  margin: 0;\n"
"  outline: none;\n"
"  padding: 8px .8em;\n"
"  text-align: center;\n"
"  text-decoration: none;\n"
"  vertical-align: baseline;\n"
"  white-space: nowrap;\n"
"}\n"
"\n"
"QPushButton:hover {\n"
"    background-color: #019ad2;\n"
"    border-color: rgb(0, 0, 0);\n"
"}\n"
"\n"
"QPushButton:focus {\n"
"    background-color: #019ad2;\n"
"    border-color: rgb(0, 0, 0);\n"
"}\n"
"\n"
"QPushButton:pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border-color: rgb(255, 255, 255)\n"
"}\n"
"\n"
"QPushButton:focus:pressed {\n"
"    background-color: rgb(1, 140, 190);\n"
"    border-color: rgb(255, 255, 255);\n"
"}")
        self.Button_Query.setObjectName("Button_Query")
        self.hLayout1.addWidget(self.Button_Query)
        self.hLayout1.addWidget(self.Button_Clean)
        spacerItem = QtWidgets.QSpacerItem(20, 10, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
        self.gridLayout_2.addItem(spacerItem, 3, 0, 1, 1)
        self.tableEditTags=QtWidgets.QTableView(parent=self.frame)
        self.model = EditableTableModel()
        self.tableEditTags.setObjectName("tableEditTags")
        self.gridLayout_2.addWidget(self.tableEditTags, 4, 0, 1, 1)
        self.hLayout3 = QtWidgets.QHBoxLayout()
        self.hLayout3.setObjectName("hLayout3")
        spacerItem2 = QtWidgets.QSpacerItem(20, 10, QtWidgets.QSizePolicy.Policy.Expanding, QtWidgets.QSizePolicy.Policy.Minimum)
        self.hLayout3.addItem(spacerItem2)
        self.label_SumItems = QtWidgets.QLabel(parent=self.frame)
        self.label_SumItems.setMinimumSize(QtCore.QSize(40, 10))
        self.label_SumItems.setMaximumSize(QtCore.QSize(40, 10))
        self.label_SumItems.setText("")
        self.label_SumItems.setObjectName("label_SumItems")
        self.hLayout3.addWidget(self.label_SumItems)
        self.label_SumValue = QtWidgets.QLabel(parent=self.frame)
        self.label_SumValue.setMinimumSize(QtCore.QSize(80, 20))
        self.label_SumValue.setMaximumSize(QtCore.QSize(80, 20))
        self.label_SumValue.setText("")
        self.label_SumValue.setObjectName("label_SumValue")
        self.hLayout3.addWidget(self.label_SumValue)
        self.label_CountItems = QtWidgets.QLabel(parent=self.frame)
        self.label_CountItems.setMinimumSize(QtCore.QSize(60, 10))
        self.label_CountItems.setMaximumSize(QtCore.QSize(60, 10))
        self.label_CountItems.setText("")
        self.label_CountItems.setObjectName("label_CountItems")
        self.hLayout3.addWidget(self.label_CountItems)
        self.label_CountValue = QtWidgets.QLabel(parent=self.frame)
        self.label_CountValue.setMinimumSize(QtCore.QSize(80, 10))
        self.label_CountValue.setMaximumSize(QtCore.QSize(80, 10))
        self.label_CountValue.setText("")
        self.label_CountValue.setObjectName("label_CountValue")
        self.hLayout3.addWidget(self.label_CountValue)
        self.gridLayout_2.addLayout(self.hLayout3, 5, 0, 1, 1)
        spacerItem = QtWidgets.QSpacerItem(20, 10, QtWidgets.QSizePolicy.Policy.Minimum, QtWidgets.QSizePolicy.Policy.Fixed)
        self.gridLayout_2.addItem(spacerItem, 0, 0, 1, 1)
        self.gridLayout.addWidget(self.frame, 0, 0, 1, 1)
        EditTags_Window.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(parent=EditTags_Window)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 790, 22))
        self.menubar.setObjectName("menubar")
        EditTags_Window.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(parent=EditTags_Window)
        self.statusbar.setObjectName("statusbar")
        EditTags_Window.setStatusBar(self.statusbar)

        self.retranslateUi(EditTags_Window)
        QtCore.QMetaObject.connectSlotsByName(EditTags_Window)
        self.Button_Clean.clicked.connect(self.clean_boxes)
        self.Button_Query.clicked.connect(self.query_tags)
        # self.toolSave.clicked.connect(self.submit_all)
        self.toolDeleteFilter.clicked.connect(self.delete_allFilters)
        self.toolShow.clicked.connect(self.show_columns)
        self.toolMatOrder.clicked.connect(lambda: self.materialorder(self.variable))
        self.toolFabOrder.clicked.connect(self.faborder)
        self.Numorder_EditTags.returnPressed.connect(self.query_tags)
        self.model.dataChanged.connect(self.saveChanges)
        self.createContextMenu()

        commands_comboboxes_flow = [
            "SELECT item_type FROM validation_data.flow_item_type",
            "SELECT line_size FROM validation_data.flow_line_size",
            "SELECT rating FROM validation_data.flow_rating",
            "SELECT facing FROM validation_data.flow_facing",
            "SELECT schedule FROM validation_data.flow_schedule",
            "SELECT flange_material FROM validation_data.flow_flange_material",
            "SELECT flange_type FROM validation_data.flow_flange_type",
            "SELECT element_material FROM validation_data.flow_element_material",
            "SELECT tapping FROM validation_data.flow_tapping",
            "SELECT element_material FROM validation_data.flow_element_material",
            "SELECT plate_type FROM validation_data.flow_plate_type",
            "SELECT plate_thk FROM validation_data.flow_plate_thk",
            "SELECT plate_std FROM validation_data.flow_plate_std",
            "SELECT gasket_material FROM validation_data.flow_gasket_material",
            "SELECT bolts_nuts_material FROM validation_data.flow_bolts_nuts_material",
            "SELECT nace FROM validation_data.flow_nace"
            ]
        
        commands_comboboxes_temp = [
            "SELECT item_type FROM validation_data.temp_item_type",
            "SELECT tw_type FROM validation_data.temp_tw_type",
            "SELECT flange_size FROM validation_data.temp_flange_size",
            "SELECT flange_rating FROM validation_data.temp_flange_rating",
            "SELECT flange_facing FROM validation_data.temp_flange_facing",
            "SELECT tw_material FROM validation_data.temp_tw_material",
            "SELECT root_diam FROM validation_data.temp_root_diam",
            "SELECT tip_diam FROM validation_data.temp_tip_diam",
            "SELECT sensor_element FROM validation_data.temp_sensor_element",
            "SELECT sheath_stem_material FROM validation_data.temp_sheath_stem_material",
            "SELECT sheath_stem_diam FROM validation_data.temp_sheath_stem_diam",
            "SELECT insulation FROM validation_data.temp_insulation",
            "SELECT temp_inf FROM validation_data.temp_temp_inf",
            "SELECT temp_sup FROM validation_data.temp_temp_sup",
            "SELECT nipple_ext_material FROM validation_data.temp_nipple_ext_material",
            "SELECT nipple_ext_length FROM validation_data.temp_nipple_ext_length",
            "SELECT head_case_material FROM validation_data.temp_head_case_material",
            "SELECT head_conn_case_diam FROM validation_data.temp_head_conn_case_diam",
            "SELECT tttb FROM validation_data.temp_tttb",
            "SELECT flange_material_lapjoint FROM validation_data.temp_flange_material_lapjoint",
            "SELECT gasket_material FROM validation_data.temp_gasket_material",
            "SELECT puntal FROM validation_data.temp_puntal",
            "SELECT tube_t FROM validation_data.temp_tube_t",
            "SELECT nace FROM validation_data.temp_nace",
            "SELECT plug FROM validation_data.temp_plug"
            ]

        self.all_results_flow = []
        self.all_results_temp = []

        conn = None
        try:
        # read the connection parameters
            params = config()
        # connect to the PostgreSQL server
            conn = psycopg2.connect(**params)
            cur = conn.cursor()
        # execution of commands
            for query in commands_comboboxes_flow:
                cur.execute(query)
                results_flow=cur.fetchall()
                self.all_results_flow.append(results_flow)
            for query in commands_comboboxes_temp:
                cur.execute(query)
                results_temp=cur.fetchall()
                self.all_results_temp.append(results_temp)
        # close communication with the PostgreSQL database server
            cur.close()
        # commit the changes
            conn.commit()
        except (Exception, psycopg2.DatabaseError) as error:
            print(error)
        finally:
            if conn is not None:
                conn.close()

    def retranslateUi(self, EditTags_Window):
        _translate = QtCore.QCoreApplication.translate
        EditTags_Window.setWindowTitle(_translate("EditTags_Window", "Editar Tags"))
        self.tableEditTags.setSortingEnabled(True)
        self.Button_Query.setText(_translate("EditTags_Window", "Buscar"))
        self.label_NumOrder.setText(_translate("EditTags_Window", "Nº Pedido:"))
        self.Button_Clean.setText(_translate("EditTags_Window", "Vaciar Cuadros"))

# Function to clear the text boxes
    def clean_boxes(self):
        self.Numorder_EditTags.setText("")

# Function when delete all filters button is clicked
    def delete_allFilters(self):
        columns_number=self.model.columnCount()
        for index in range(columns_number):
            if index in self.proxy.filters:
                del self.proxy.filters[index]
            self.model.setIconColumnHeader(index, '')

        self.checkbox_states = {}
        self.dict_valuesuniques = {}
        self.dict_ordersort = {}

        self.proxy.invalidateFilter()
        self.tableEditTags.setModel(None)
        self.tableEditTags.setModel(self.proxy)

        # Getting the unique values for each column of the model
        for column in range(self.model.columnCount()):
            list_valuesUnique = []
            if column not in self.checkbox_states:
                self.checkbox_states[column] = {}
                self.checkbox_states[column]['Seleccionar todo'] = True
                for row in range(self.model.rowCount()):
                    value = self.model.record(row).value(column)
                    if value not in list_valuesUnique:
                        if isinstance(value, QtCore.QDate):
                            value=value.toString("dd/MM/yyyy")
                        list_valuesUnique.append(str(value))
                        self.checkbox_states[column][value] = True
                self.dict_valuesuniques[column] = list_valuesUnique

# Function to upload changes in database when field change
    def saveChanges(self):
        self.model.submitAll()

        for column in range(self.model.columnCount()):
            list_valuesUnique = []
            for row in range(self.model.rowCount()):
                value = self.model.record(row).value(column)
                if value not in list_valuesUnique:
                    if isinstance(value, QtCore.QDate):
                        value=value.toString("dd/MM/yyyy")
                    list_valuesUnique.append(str(value))
                    if value not in self.checkbox_states[column]:
                        self.checkbox_states[column][value] = True
            self.dict_valuesuniques[column] = list_valuesUnique

# Function to upload changes when save button is pressed
    # def submit_all(self):
    #     columns_number=self.model.columnCount()
    #     if self.model.database().isOpen():
    #         self.model.database().transaction()
    #         success = True

    #         for index in range(columns_number):
    #             self.proxy.setFilter("", index)
    #             self.model.setIconColumnHeader(index, '')

    #         for row in range(self.model.rowCount()):
    #             for column in range(self.model.columnCount()):
    #                 index = self.model.index(row, column)
    #                 current_value = index.data(Qt.ItemDataRole.DisplayRole)
    #                 original_value = self.model.getOriginalValue(index)
    #                 if current_value != original_value:
    #                     record = self.model.record(row)
    #                     query = self.model.update_record(record, index)
    #                     if not query:
    #                         success = False
    #                         break

    #         if success:
    #             self.model.database().commit()
    #             dlg = QtWidgets.QMessageBox()
    #             new_icon = QtGui.QIcon()
    #             new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
    #             dlg.setWindowIcon(new_icon)
    #             dlg.setWindowTitle("Editar Tags")
    #             dlg.setText("Datos guardados con éxito")
    #             dlg.setIcon(QtWidgets.QMessageBox.Icon.Information)
    #             dlg.exec()
    #         else:
    #             self.model.database().rollback()
    #             dlg = QtWidgets.QMessageBox()
    #             new_icon = QtGui.QIcon()
    #             new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
    #             dlg.setWindowIcon(new_icon)
    #             dlg.setWindowTitle("Editar Tags")
    #             dlg.setText("Ha habido un problema al guardar los datos")
    #             dlg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
    #             dlg.exec()

    #     else:
    #         dlg = QtWidgets.QMessageBox()
    #         new_icon = QtGui.QIcon()
    #         new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
    #         dlg.setWindowIcon(new_icon)
    #         dlg.setWindowTitle("Editar Tags")
    #         dlg.setText("No ha sido posible conectar con la base de datos. Contacte con su administrador")
    #         dlg.setIcon(QtWidgets.QMessageBox.Icon.Critical)
    #         dlg.exec()

# Function to load table and setting in the window
    def query_tags(self):
        self.checkbox_states = {}
        self.dict_valuesuniques = {}
        self.dict_ordersort = {}
        self.hiddencolumns = []

        self.model.dataChanged.disconnect(self.saveChanges)
        self.numorder = self.Numorder_EditTags.text()

        if self.numorder=="":
            dlg = QtWidgets.QMessageBox()
            new_icon = QtGui.QIcon()
            new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
            dlg.setWindowIcon(new_icon)
            dlg.setWindowTitle("ERP EIPSA")
            dlg.setText("Rellena alguno de los campos")
            dlg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
            dlg.exec()
            del dlg, new_icon
            self.model.dataChanged.connect(self.saveChanges)

        else:
            if not re.match(r'^(P|PA)-\d{2}/\d{3}.*$', self.numorder):
                dlg = QtWidgets.QMessageBox()
                new_icon = QtGui.QIcon()
                new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
                dlg.setWindowIcon(new_icon)
                dlg.setWindowTitle("ERP EIPSA")
                dlg.setText("El número de pedido debe tener formato P-XX/YYY o PA-XX/YYY")
                dlg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
                dlg.exec()
                del dlg, new_icon
                self.model.dataChanged.connect(self.saveChanges)

            else:
                query = ('''
                        SELECT num_order, product_type."variable"
                        FROM orders
                        INNER JOIN offers ON (offers."num_offer" = orders."num_offer")
                        INNER JOIN product_type ON (product_type."material" = offers."material")
                        WHERE
                        UPPER (orders."num_order") LIKE UPPER('%%'||%s||'%%')
                        ''')
                conn = None
                try:
                # read the connection parameters
                    params = config()
                # connect to the PostgreSQL server
                    conn = psycopg2.connect(**params)
                    cur = conn.cursor()
                # execution of commands
                    cur.execute(query,(self.numorder,))
                    results_variable=cur.fetchone()
                    self.variable = results_variable[1] if results_variable != None else ''
                # close communication with the PostgreSQL database server
                    cur.close()
                # commit the changes
                    conn.commit()
                except (Exception, psycopg2.DatabaseError) as error:
                    print(error)
                finally:
                    if conn is not None:
                        conn.close()

                if results_variable == None:
                    dlg = QtWidgets.QMessageBox()
                    new_icon = QtGui.QIcon()
                    new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
                    dlg.setWindowIcon(new_icon)
                    dlg.setWindowTitle("ERP EIPSA")
                    dlg.setText("EL número de pedido no existe")
                    dlg.setIcon(QtWidgets.QMessageBox.Icon.Warning)
                    dlg.exec()
                    del dlg, new_icon
                    self.model.dataChanged.connect(self.saveChanges)

                else:
                    if self.variable == 'Caudal':
                        self.model.setTable("tags_data.tags_flow_prueba")
                    elif self.variable == 'Temperatura':
                        self.model.setTable("tags_data.tags_temp_prueba")
                    elif self.variable == 'Nivel':
                        self.model.setTable("tags_data.tags_level")
                    # else:
                        # self.model.setTable("tags_data.tags_temp_prueba")
                    self.model.setFilter(f"num_order <>'' AND UPPER(num_order) LIKE '%{self.numorder.upper()}%'")

        if self.variable != '':
            self.model.select()
            # self.model.setEditStrategy(QtSql.QSqlTableModel.EditStrategy.OnManualSubmit)

            self.proxy.setSourceModel(self.model)
            self.tableEditTags.setModel(self.proxy)

            columns_number=self.model.columnCount()
            # if self.variable == 'Caudal':
            #     for i in range(66,columns_number):
            #         self.tableEditTags.hideColumn(i)
            # elif self.variable == 'Temperatura':
            #     for i in range(73,columns_number):
            #         self.tableEditTags.hideColumn(i)
            # elif self.variable == 'Nivel':
            #     for i in range(54,columns_number):
            #         self.tableEditTags.hideColumn(i)

            if self.name != 'Jesús Martínez':
                if self.variable == 'Caudal':
                    self.tableEditTags.hideColumn(28)
                elif self.variable == 'Temperatura':
                    self.tableEditTags.hideColumn(35)
                elif self.variable == 'Nivel':
                    self.tableEditTags.hideColumn(36)

            # self.tableEditTags.verticalHeader().hide()
            self.tableEditTags.setItemDelegate(AlignDelegate(self.tableEditTags))
            self.tableEditTags.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeMode.ResizeToContents)
            self.tableEditTags.horizontalHeader().setSectionResizeMode(QtWidgets.QHeaderView.ResizeMode.Interactive)
            self.tableEditTags.horizontalHeader().setStyleSheet("::section{font: 800 10pt; background-color: #33bdef; border: 1px solid black;}")
            self.tableEditTags.setObjectName("tableEditTags")
            self.gridLayout_2.addWidget(self.tableEditTags, 3, 0, 1, 1)
            self.tableEditTags.setSortingEnabled(False)
            self.tableEditTags.horizontalHeader().sectionDoubleClicked.connect(self.on_view_horizontalHeader_sectionClicked)
            self.tableEditTags.horizontalHeader().customContextMenuRequested.connect(self.showColumnContextMenu)
            self.tableEditTags.horizontalHeader().setContextMenuPolicy(Qt.ContextMenuPolicy.CustomContextMenu)

        # Change all column names
            headers_flow = ["ID", "TAG", "Estado", "Nº Oferta", "Nº Pedido", "PO", "Posición", "Subposición",
                        "Tipo", "Tamaño Línea", "Rating", "Facing", "Schedule", "Material Brida", "Tipo Brida",
                        "Material Tubo", "Tamaño Tomas (Nº)", "Material Elemento", "Tipo Placa", "Espesor Placa",
                        "Estándar Placa", "Material Junta", "Material Tornillería", "NACE", "Nº Saltos",
                        "Pipe Spec.", "Peso Aprox. (kg)", "Long. Aprox. (mm)", "Precio (€)", "Notas Oferta",
                        "Cambios Comercial", "Fecha Contractual", "Ø Orif. (mm)", "Ø D/V (mm)", "Cambios Técnicos",
                        "Notas Técnicas", "Nº Doc. EIPSA Cálculo", "Estado Cálculo", "Fecha Estado Cálculo", "Nº Doc. EIPSA Plano",
                        "Estado Plano", "Fecha Estado Plano", "Orden de Compra", "Fecha Orden Compra", "Notas Orden Compra",
                        "Fecha OF Placa", "Plano OF Placa", "Colada Placa", "Fecha OF Brida", "Plano OF Brida",
                        "Colada Brida", "Nº Tapones", "Tamaño Tomas", "Nº Tomas", "RTJ Porta Material",
                        "RTJ Espesor", "RTJ Dim", "Ø Ext. Placa (mm)", "Mango", "Tamaño Espárragos",
                        "Cantidad Espárragos", "Tamaño Extractor", "Cantidad Extractor", "Estado Fabricación", "Inspección",
                        "Envío RN"]

            headers_temp = ["ID", "TAG", "Estado", "Nº Oferta", "Nº Pedido", "PO", "Posición", "Subposición",
                        "Tipo", "Tipo TW", "Tamaño Brida", "Rating Brida", "Facing Brida", "Standard TW",
                        "Material TW", "Long. STD (mm)", "Long. Ins. (mm)", "Ø Raíz (mm)", "Ø Punta (mm)",
                        "Sensor", "Material Sheath/Stem", "Ø Sheath/Stem (mm)", "Insulation", "Temp Inf (ºC)",
                        "Temp Sup ºC", "Material Nipple Ext.", "Long. Nipple Ext. (mm)", "Material Head/Case", "Con. Elec./Diam. Case",
                        "TT/Terminal Insulation", "Material Brida LapJoint", "Material Junta", "Puntal", "Tubo",
                        "NACE", "Precio (€)", "Notas Oferta", "Cambio Comercial", "Fecha Contractual",
                        "Stress", "Geometría", "Long. Cónica (mm)", "Long. Recta (mm)", "Ø Picaje (mm)",
                        "Notas Cálculo", "Cambios Técnicos", "Notas Técnicas", "Nº Doc. EIPSA Cálculo", "Estado Cálculo",
                        "Fecha Estado Cálculo", "Nº Doc. EIPSA Plano", "Estado Plano", "Fecha Estado Plano", "Notas Planos",
                        "Fecha OF Sensor", "Plano OF Sensor", "Notas Sensor", "Estado Fabricación Sensor", "Fecha OF TW",
                        "Plano OF TW", "Notas TW", "Estado Fabricación TW", "Orden de Compra", "Fecha Orden Compra",
                        "Notas Orden Compra", "Long. Corte TW (mm)", "Cota A Sensor (mm)", "Cota B Sensor (mm)", "Cota L Sensor (mm)",
                        "Tapón", "Estado Fabricación", "Inspección", "Envío RN"]

            headers_level = ["ID", "TAG", "Estado", "Nº Oferta", "Nº Pedido", "PO", "Posición", "Subposición",
                            "Tipo", "Modelo", "Material Cuerpo", "Tipo Conex. Proc.", "Tamaño Conex. Proc.", "Rating Conex. Proc.", "Facing Conex. Proc.",
                            "Tipo Conex.", "Visibilidad (mm)", "Long. C-C (mm)", "Tipo Válv.", "Tipo Conex. Ext.", "Tamaño Conex. Ext.", "Rating Conex. Ext.", "Facing Conex. Ext.",
                            "Junta", "Tornillería", "Iluminador", "Mat. Flotador", "Mat. Cubierta", "Escala", "Cod. IP", "Tipo Brida", "Niplo Hex.", "Niplo Tubo", "Antifrost",
                            "NACE", "Precio (€)", "Notas Oferta", "Cambio Comercial", "Fecha Contractual", "Dim. Flotador", "Junta Bridas", "Cambios Técnicos", "Notas Técnicas",
                            "Nº Doc. EIPSA Plano", "Estado Plano", "Fecha Estado Plano", "Orden de Compra", "Fecha Orden Compra", "Notas Orden Compra", "Estado Fabricación", "Inspección", "Envío RN"]

            if self.variable == 'Caudal':
                self.model.setAllColumnHeaders(headers_flow)
            elif self.variable == 'Temperatura':
                self.model.setAllColumnHeaders(headers_temp)
            elif self.variable == 'Nivel':
                self.model.setAllColumnHeaders(headers_level)

        # Getting the unique values for each column of the model
            for column in range(self.model.columnCount()):
                list_valuesUnique = []
                if column not in self.checkbox_states:
                    self.checkbox_states[column] = {}
                    self.checkbox_states[column]['Seleccionar todo'] = True
                    for row in range(self.model.rowCount()):
                        value = self.model.record(row).value(column)
                        if value not in list_valuesUnique:
                            if isinstance(value, QtCore.QDate):
                                value=value.toString("dd/MM/yyyy")
                            list_valuesUnique.append(str(value))
                            self.checkbox_states[column][value] = True
                    self.dict_valuesuniques[column] = list_valuesUnique

        # Setting cells with comboboxes
            list_fab_state = ['','PTE.APROBACIÓN','EN FABRICACIÓN','INSPECCIÓN','ENVIADO']
            if self.variable == 'Caudal':
                for i in range(16):
                    self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_flow[i]]))
                    self.tableEditTags.setItemDelegateForColumn(i+8, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, list_fab_state)
                self.tableEditTags.setItemDelegateForColumn(63, self.combo_itemtype)
            elif self.variable == 'Temperatura':
                for i in range(5):
                    self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_temp[i]]))
                    self.tableEditTags.setItemDelegateForColumn(i+8, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_temp[5]]))
                self.tableEditTags.setItemDelegateForColumn(14, self.combo_itemtype)
                for i in range(6,25):
                    self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_temp[i]]))
                    self.tableEditTags.setItemDelegateForColumn(i+11, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, list_fab_state)
                self.tableEditTags.setItemDelegateForColumn(56, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, list_fab_state)
                self.tableEditTags.setItemDelegateForColumn(60, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_temp[24]]))
                self.tableEditTags.setItemDelegateForColumn(68, self.combo_itemtype)
                self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, list_fab_state)
                self.tableEditTags.setItemDelegateForColumn(69, self.combo_itemtype)
            # elif self.variable == 'Nivel':
            #     for i in range(16):
            #         self.combo_itemtype = EditableComboBoxDelegate(self.tableEditTags, sorted([x[0] for x in self.all_results_level[i]]))
            #         self.tableEditTags.setItemDelegateForColumn(i+8, self.combo_itemtype)

            self.model.dataChanged.connect(self.saveChanges)
            self.selection_model = self.tableEditTags.selectionModel()
            self.selection_model.selectionChanged.connect(self.countSelectedCells)

# Function when clicking on header
    def on_view_horizontalHeader_sectionClicked(self, logicalIndex):
        self.logicalIndex = logicalIndex
        self.menuValues = QtWidgets.QMenu(self.tableEditTags)
        self.signalMapper = QtCore.QSignalMapper(self.tableEditTags)

        valuesUnique_view = []
        for row in range(self.tableEditTags.model().rowCount()):
            index = self.tableEditTags.model().index(row, self.logicalIndex)
            value = index.data(Qt.ItemDataRole.DisplayRole)
            if value not in valuesUnique_view:
                if isinstance(value, QtCore.QDate):
                    value=value.toString("dd/MM/yyyy")
                valuesUnique_view.append(value)
                if self.logicalIndex in self.proxy.filters and str(value) in self.proxy.filters[self.logicalIndex]:
                    pass
                else:
                    if self.logicalIndex not in self.proxy.filters:
                        self.proxy.filters[self.logicalIndex] = []
                    self.proxy.filters[self.logicalIndex].append(str(value))

        # actionHideColumn = QtGui.QAction("Ocultar Columna", self.tableEditTags)
        # actionHideColumn.triggered.connect(self.hide_column)
        # self.menuValues.addAction(actionHideColumn)
        # self.menuValues.addSeparator()

        actionSortAscending = QtGui.QAction("Ordenar Ascendente", self.tableEditTags)
        actionSortAscending.triggered.connect(self.on_actionSortAscending_triggered)
        self.menuValues.addAction(actionSortAscending)
        actionSortDescending = QtGui.QAction("Ordenar Descendente", self.tableEditTags)
        actionSortDescending.triggered.connect(self.on_actionSortDescending_triggered)
        self.menuValues.addAction(actionSortDescending)
        self.menuValues.addSeparator()

        actionDeleteFilterColumn = QtGui.QAction("Quitar Filtro", self.tableEditTags)
        actionDeleteFilterColumn.triggered.connect(self.on_actionDeleteFilterColumn_triggered)
        self.menuValues.addAction(actionDeleteFilterColumn)
        self.menuValues.addSeparator()

        actionTextFilter = QtGui.QAction("Buscar...", self.tableEditTags)
        actionTextFilter.triggered.connect(self.on_actionTextFilter_triggered)
        self.menuValues.addAction(actionTextFilter)
        self.menuValues.addSeparator()

        self.moreMenu = self.menuValues.addMenu("Más")

        if len(self.dict_ordersort) != 0 and self.logicalIndex in self.dict_ordersort:
            list_uniquevalues = sorted(list(set(self.dict_valuesuniques[self.logicalIndex])))
        else:
            list_uniquevalues = sorted(list(set(valuesUnique_view)))

        for actionNumber, actionName in enumerate(['Seleccionar todo'] + list_uniquevalues):
            checkbox_widget = CheckboxWidget(str(actionName))
            action = QtWidgets.QWidgetAction(self.moreMenu)
            action.setDefaultWidget(checkbox_widget)
            self.moreMenu.addAction(action)

            if not self.checkbox_states[self.logicalIndex][actionName] == True:
                checkbox_widget.checkbox.setChecked(False)
            else:
                checkbox_widget.checkbox.setChecked(True)

            checkbox_widget.checkbox.toggled.connect(lambda checked, name=actionName: self.on_checkbox_toggled(checked, name))

        self.moreMenu.setStyleSheet("QMenu { menu-scrollable: True; }")

        self.menuValues.setStyleSheet("QMenu { color: black; }"
                                        "QMenu::item:selected { background-color: #33bdef; }"
                                        "QMenu::item:pressed { background-color: rgb(1, 140, 190); }")

        headerPos = self.tableEditTags.mapToGlobal(self.tableEditTags.horizontalHeader().pos())        

        posY = headerPos.y() + self.tableEditTags.horizontalHeader().height()
        scrollX = self.tableEditTags.horizontalScrollBar().value()
        xInView = self.tableEditTags.horizontalHeader().sectionViewportPosition(logicalIndex)
        posX = headerPos.x() + xInView - scrollX

        self.menuValues.exec(QtCore.QPoint(posX, posY))

# Function when checkbox of header menu is clicked
    def on_checkbox_toggled(self, checked, action_name):
        filterColumn = self.logicalIndex
        imagen_path = "//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Filter_Active.png"
        icono = QtGui.QIcon(QtGui.QPixmap.fromImage(QtGui.QImage(imagen_path)))

        if len(self.dict_ordersort) == 0:
            self.dict_ordersort[self.logicalIndex] = 1

        if action_name == "Seleccionar todo":
            if checked:
                for action in self.moreMenu.actions()[0:]:
                    checkbox_widget = action.defaultWidget().checkbox
                    checkbox_widget.setChecked(checked)
                    self.checkbox_states[self.logicalIndex][checkbox_widget.text()] = True

            else:
                for action in self.moreMenu.actions()[0:]:
                    checkbox_widget = action.defaultWidget().checkbox
                    checkbox_widget.setChecked(checked)
                    self.checkbox_states[self.logicalIndex][checkbox_widget.text()] = False

        else:
            if checked:
                self.proxy.setFilter(str(action_name), filterColumn)
                self.checkbox_states[self.logicalIndex][action_name] = True
                self.model.setIconColumnHeader(filterColumn, icono)

                # select_all_checkbox = self.moreMenu.actions()[0].defaultWidget().checkbox
                # if all(action.defaultWidget().checkbox.isChecked() for action in self.moreMenu.actions()[1:]):
                #     select_all_checkbox.setChecked(True)

            else:
                if action_name in self.checkbox_states[self.logicalIndex]:
                    self.checkbox_states[self.logicalIndex][action_name] = False
                    self.proxy.setFilter(str(action_name), filterColumn, str(action_name))
                    self.model.setIconColumnHeader(filterColumn, icono)

                    # select_all_checkbox = self.moreMenu.actions()[0].defaultWidget().checkbox
                    # select_all_checkbox.setCheckState(QtCore.Qt.CheckState.PartiallyChecked)

            if all(action.defaultWidget().checkbox.isChecked() for action in self.moreMenu.actions()[1:]):
                self.model.setIconColumnHeader(filterColumn, '')

# Function when delete filter action in header is clicked
    def on_actionDeleteFilterColumn_triggered(self):
        filterColumn = self.logicalIndex
        if filterColumn in self.proxy.filters:
                del self.proxy.filters[filterColumn]
        self.model.setIconColumnHeader(filterColumn, '')
        self.proxy.invalidateFilter()

        self.tableEditTags.setModel(None)  # Delete actual model of the view
        self.tableEditTags.setModel(self.proxy)

        self.checkbox_states[self.logicalIndex].clear()
        self.checkbox_states[self.logicalIndex]['Seleccionar todo'] = True
        for row in range(self.tableEditTags.model().rowCount()):
            value = self.model.record(row).value(filterColumn)
            if isinstance(value, QtCore.QDate):
                    value=value.toString("dd/MM/yyyy")
            self.checkbox_states[self.logicalIndex][value] = True

# Function when sort ascending action in header is clicked
    def on_actionSortAscending_triggered(self):
        sortColumn = self.logicalIndex
        sortOrder = Qt.SortOrder.AscendingOrder
        self.tableEditTags.sortByColumn(sortColumn, sortOrder)

# Function when sort descending action in header is clicked
    def on_actionSortDescending_triggered(self):
        sortColumn = self.logicalIndex
        sortOrder = Qt.SortOrder.DescendingOrder
        self.tableEditTags.sortByColumn(sortColumn, sortOrder)

# Function when text filter action in header is used
    def on_actionTextFilter_triggered(self):
        filterColumn = self.logicalIndex
        dlg = QtWidgets.QInputDialog()
        new_icon = QtGui.QIcon()
        new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        dlg.setWindowIcon(new_icon)
        dlg.setWindowTitle('Buscar')
        clickedButton=dlg.exec()

        if clickedButton == 1:
            stringAction = dlg.textValue()
            if re.fullmatch(r'^(?:3[01]|[12][0-9]|0?[1-9])([\-/.])(0?[1-9]|1[1-2])\1\d{4}$', stringAction):
                stringAction=QtCore.QDate.fromString(stringAction,"dd/MM/yyyy")
                stringAction=stringAction.toString("yyyy-MM-dd")

            filterString = QtCore.QRegularExpression(stringAction, QtCore.QRegularExpression.PatternOption(0))

            self.proxy.setFilter(filterString, filterColumn)

# Function when delete filter action in header is clicked
    def on_signalMapper_mapped(self, i):
        stringAction = self.signalMapper.mapping(i).text()
        filterColumn = self.logicalIndex
        self.proxy.setFilter(stringAction, filterColumn)

        imagen_path = "//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/Filter_Active.png"
        icono = QtGui.QIcon(QtGui.QPixmap.fromImage(QtGui.QImage(imagen_path)))
        self.model.setIconColumnHeader(filterColumn, icono)

# Function to hide column when action clicked
    def hide_column(self):
        filterColumn = self.logicalIndex 
        self.tableEditTags.setColumnHidden(filterColumn, True)
        self.hiddencolumns.append(filterColumn)

# Function to show all hidden columns
    def show_columns(self):
        for column in self.hiddencolumns:
            self.tableEditTags.setColumnHidden(column, False)
        self.hiddencolumns.clear()

# Function to create material order for flow elements
    def materialorder_flow(self):
        id_list=[]
        orifice_flange_list = []
        line_flange_list = []
        gasket_list = []
        bolts_list = []
        plugs_list = []
        extractor_list = []
        plate_list = []
        nipple_list = []
        handle_list = []
        chring_list = []
        tube_list = []
        piece2_list = []

        for row in range(self.proxy.rowCount()):
            first_column_value = self.proxy.data(self.proxy.index(row, 0))
            id_list.append(first_column_value)

        for element in id_list:
            for row in range(self.model.rowCount()):
                if self.model.data(self.model.index(row, 0)) == element:
                    target_row = row
                    break
            if target_row is not None:
                code_orifice_flange = self.model.data(self.model.index(target_row, 69))
                code_line_flange = self.model.data(self.model.index(target_row, 72))
                code_gasket = self.model.data(self.model.index(target_row, 75))
                code_bolts = self.model.data(self.model.index(target_row, 78))
                code_plugs = self.model.data(self.model.index(target_row, 81))
                code_extractor = self.model.data(self.model.index(target_row, 84))
                code_plate = self.model.data(self.model.index(target_row, 87))
                code_nipple = self.model.data(self.model.index(target_row, 90))
                code_handle = self.model.data(self.model.index(target_row, 93))
                code_chring = self.model.data(self.model.index(target_row, 96))
                code_tube = self.model.data(self.model.index(target_row, 99))
                code_piece2 = self.model.data(self.model.index(target_row, 102))

                if code_orifice_flange != '':
                    tradcodbror = ("BRIDA DE ORIFICIO " + 
                                    ("WN" if self.model.data(self.model.index(target_row, 14)) == "SW/WN" else self.model.data(self.model.index(target_row, 14))) + " " + 
                                    self.model.data(self.model.index(target_row, 9)) + " " + 
                                    (self.model.data(self.model.index(target_row, 10)) if self.model.data(self.model.index(target_row, 10)) != "150/300" else self.model.data(self.model.index(target_row, 10))[4:4+4]) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    schbror = self.model.data(self.model.index(target_row, 12))
                    designbror = self.model.data(self.model.index(target_row, 105)).replace('.',',')
                    processbror = self.model.data(self.model.index(target_row, 35))
                    materialbror = self.model.data(self.model.index(target_row, 13))
                    qtybror = 2
                    orifice_flange_list.append([tradcodbror,schbror,designbror,processbror,materialbror,qtybror])

                if code_line_flange != '':
                    tradcodbrline = ("BRIDA DE LÍNEA " + 
                                    ("SW" if self.model.data(self.model.index(target_row, 14)) == "SW/WN" else self.model.data(self.model.index(target_row, 14))) + " " + 
                                    self.model.data(self.model.index(target_row, 9)) + " " + 
                                    (self.model.data(self.model.index(target_row, 10)) if self.model.data(self.model.index(target_row, 10)) != "150/300" else self.model.data(self.model.index(target_row, 10))[0:3]) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    schbrline = self.model.data(self.model.index(target_row, 12))
                    designbrline = self.model.data(self.model.index(target_row, 105)).replace('.',',')
                    processbrline = self.model.data(self.model.index(target_row, 35))
                    materialbrline = self.model.data(self.model.index(target_row, 13))
                    qtybrline = 2
                    line_flange_list.append([tradcodbrline,schbrline,designbrline,processbrline,materialbrline,qtybrline])

                if code_gasket != '':
                    tradcodgasket = self.model.data(self.model.index(target_row, 21))
                    schgasket = (self.model.data(self.model.index(target_row, 9)) + " " + 
                                    self.model.data(self.model.index(target_row, 10)) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    designgasket = ''
                    processgasket = ''
                    materialgasket = ''
                    qtygasket = 2
                    gasket_list.append([tradcodgasket,schgasket,designgasket,processgasket,materialgasket,qtygasket])

                if code_bolts != '':
                    tradcodbolts = ('ESPÁRRAGO '+ self.model.data(self.model.index(target_row, 59)))
                    modelbolts = (self.model.data(self.model.index(target_row, 9)) + " " + 
                                    self.model.data(self.model.index(target_row, 10)) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    designbolts = ('esp. placa ' + self.model.data(self.model.index(target_row, 19)))
                    processbolts = ''
                    materialbolts = self.model.data(self.model.index(target_row, 22))
                    qtybolts = self.model.data(self.model.index(target_row, 60))
                    bolts_list.append([tradcodbolts,modelbolts,designbolts,processbolts,materialbolts,qtybolts])

                if code_extractor != '':
                    tradcodextractor = ('Extractor ' + self.model.data(self.model.index(target_row, 61)))
                    sizebrida = (self.model.data(self.model.index(target_row, 9)) + " " + 
                                    self.model.data(self.model.index(target_row, 10)) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    designextractor = ('esp. placa ' + self.model.data(self.model.index(target_row, 19)))
                    processextractor = ''
                    materialextractor = self.model.data(self.model.index(target_row, 22))
                    qtyextractor = self.model.data(self.model.index(target_row, 62))
                    extractor_list.append([tradcodextractor,sizebrida,designextractor,processextractor,materialextractor,qtyextractor])

                if code_plate != '':
                    tradcodplate = (('ORIFICIO DE RESTRICCIÓN ' + self.model.data(self.model.index(target_row, 9)) + " " + 
                                    self.model.data(self.model.index(target_row, 10)) + " " + 
                                    self.model.data(self.model.index(target_row, 11))) if self.model.data(self.model.index(target_row, 18)) =='RO' else 
                                    ('PLACA DE ORIFICIO ' + self.model.data(self.model.index(target_row, 9)) + " " + 
                                    self.model.data(self.model.index(target_row, 10)) + " " + 
                                    self.model.data(self.model.index(target_row, 11))))
                    modelplate = ('ESP ' + self.model.data(self.model.index(target_row, 19)) + 'mm')
                    diamextplate = self.model.data(self.model.index(target_row, 57))
                    processplate = 'ARAMCO' if self.model.data(self.model.index(target_row, 20)) =='ARA' else ''
                    materialplate = self.model.data(self.model.index(target_row, 17))
                    qtyplate = self.model.data(self.model.index(target_row, 24)) if self.model.data(self.model.index(target_row, 8)) == "MULTISTAGE RO" else 1
                    plate_list.append([tradcodplate,modelplate,diamextplate,processplate,materialplate,qtyplate])

                if code_nipple != '':
                    tradcodnipple = ('NIPLO ' + self.model.data(self.model.index(target_row, 52)))
                    modelnipple = ''
                    designnipple = ''
                    processnipple = ''
                    materialnipple = self.model.data(self.model.index(target_row, 13))
                    qtynipple = self.model.data(self.model.index(target_row, 53))
                    nipple_list.append([tradcodnipple,modelnipple,designnipple,processnipple,materialnipple,qtynipple])

                if code_handle != '':
                    tradcodhandle = ('MANGO ' + self.model.data(self.model.index(target_row, 58)))
                    modelhandle = (self.model.data(self.model.index(target_row, 58)) + 'mm')
                    designhandle = self.model.data(self.model.index(target_row, 20))
                    processhandle = ''
                    materialhandle = '316SS'
                    qtyhandle = 1
                    handle_list.append([tradcodhandle,modelhandle,designhandle,processhandle,materialhandle,qtyhandle])

                if code_chring != '':
                    tradcodchring = ('CÁMARA ANULAR ' + self.model.data(self.model.index(target_row, 9)) + " " + 
                                    (self.model.data(self.model.index(target_row, 10)) if self.model.data(self.model.index(target_row, 10)) != "150/300" else self.model.data(self.model.index(target_row, 10))[0:3]) + " " + 
                                    self.model.data(self.model.index(target_row, 11)))
                    schchring = 'ESP ' if self.model.data(self.model.index(target_row, 11)) != "RTJ" else 'ESP 38,1MM'
                    designchring = self.model.data(self.model.index(target_row, 57))
                    processchring = self.model.data(self.model.index(target_row, 35))
                    materialchring = self.model.data(self.model.index(target_row, 13))
                    qtychring = 1
                    chring_list.append([tradcodchring,schchring,designchring,processchring,materialchring,qtychring])

                if code_plugs != '':
                    tradcodplug = ('TAPÓN ' + self.model.data(self.model.index(target_row, 81))[2:2 + self.model.data(self.model.index(target_row, 81)).find('-') - 4] + 'M')
                    modelplug = ''
                    designplug = ''
                    processplug = ''
                    materialplug = 'ASTM A105' if self.model.data(self.model.index(target_row, 81))[-2:] == 'C1' else self.model.data(self.model.index(target_row, 13))
                    qtyplug = self.model.data(self.model.index(target_row, 51))
                    plugs_list.append([tradcodplug,modelplug,designplug,processplug,materialplug,qtyplug])

                if code_tube != '':
                    tradcodtube = ('TUBO ' + self.model.data(self.model.index(target_row, 9)) + " sch " + self.model.data(self.model.index(target_row, 12)))
                    schtube = self.model.data(self.model.index(target_row, 12))
                    designtube = self.model.data(self.model.index(target_row, 105)).replace('.',',')
                    processtube = ''
                    commands_flangecode = ("""
                        SELECT code
                        FROM validation_data.flow_flange_material
                        WHERE flange_material = %s
                        """)
                    commands_tubematerial = ("""
                        SELECT tube_material
                        FROM validation_data.flow_tube_material
                        WHERE code = %s
                        """)
                    conn = None
                    try:
                    # read the connection parameters
                        params = config()
                    # connect to the PostgreSQL server
                        conn = psycopg2.connect(**params)
                        cur = conn.cursor()
                    # execution of commands one by one
                        cur.execute(commands_flangecode,(self.model.data(self.model.index(target_row, 13)),))
                        results=cur.fetchone()
                        code=results[0]
                        cur.execute(commands_tubematerial,(code,))
                        results=cur.fetchall()
                        materialtube = results[0]
                    # close communication with the PostgreSQL database server
                        cur.close()
                    # commit the changes
                        conn.commit()
                    except (Exception, psycopg2.DatabaseError) as error:
                        print(error)
                    finally:
                        if conn is not None:
                            conn.close()
                    qtytube = self.model.data(self.model.index(target_row, 101))
                    tube_list.append([tradcodtube,schtube,designtube,processtube,materialtube,qtytube])

                if code_piece2 != '':
                    tradcodpiece2 = ('CUÑA PARA WEDGE DE ' + self.model.data(self.model.index(target_row, 9)))
                    commands_thk = ("""
                        SELECT wall_thk
                        FROM validation_data.pipe_diam
                        WHERE (line_size = %s
                        AND
                        sch = %s)
                        """)
                    conn = None
                    try:
                    # read the connection parameters
                        params = config()
                    # connect to the PostgreSQL server
                        conn = psycopg2.connect(**params)
                        cur = conn.cursor()
                    # execution of commands one by one
                        cur.execute(commands_thk,(self.model.data(self.model.index(target_row, 9)),self.model.data(self.model.index(target_row, 12)),))
                        results=cur.fetchone()
                        thkmin=results[0]
                    # close communication with the PostgreSQL database server
                        cur.close()
                    # commit the changes
                        conn.commit()
                    except (Exception, psycopg2.DatabaseError) as error:
                        print(error)
                    finally:
                        if conn is not None:
                            conn.close()
                    modelpiece2 = ('Th mín ' + thkmin + 'mm')
                    designpiece2 = ''
                    processpiece2 = ''
                    commands_flangecode = ("""
                        SELECT code
                        FROM validation_data.flow_flange_material
                        WHERE flange_material = %s
                        """)
                    commands_sheetmaterial = ("""
                        SELECT sheet_material
                        FROM validation_data.flow_sheet_material
                        WHERE code = %s
                        """)
                    conn = None
                    try:
                    # read the connection parameters
                        params = config()
                    # connect to the PostgreSQL server
                        conn = psycopg2.connect(**params)
                        cur = conn.cursor()
                    # execution of commands one by one
                        cur.execute(commands_flangecode,(self.model.data(self.model.index(target_row, 13)),))
                        results=cur.fetchone()
                        code=results[0]
                        cur.execute(commands_sheetmaterial,(code,))
                        results=cur.fetchall()
                        materialpiece2 = results[0]
                    # close communication with the PostgreSQL database server
                        cur.close()
                    # commit the changes
                        conn.commit()
                    except (Exception, psycopg2.DatabaseError) as error:
                        print(error)
                    finally:
                        if conn is not None:
                            conn.close()
                    qtypiece2 = 1
                    piece2_list.append([tradcodpiece2,modelpiece2,designpiece2,processpiece2,materialpiece2,qtypiece2])

    # Turn all lists in dataframe and grouped in order to sum same items
        data_lists = [
        (orifice_flange_list, "df_orifice_flange"),
        (line_flange_list, "df_line_flange"),
        (gasket_list, "df_gasket"),
        (bolts_list, "df_bolts"),
        (plugs_list, "df_plugs"),
        (extractor_list, "df_extractor"),
        (plate_list, "df_plate"),
        (nipple_list, "df_nipple"),
        (handle_list, "df_handle"),
        (chring_list, "df_chring"),
        (tube_list, "df_tube"),
        (piece2_list, "df_piece2")]

        data_frames_with_data = []

        for data_list, df_name in data_lists:
            if data_list:
                df = pd.DataFrame(data_list)
                df = df.groupby([0, 1, 2, 3, 4])[5].sum().reset_index()
                data_frames_with_data.append(df)

        if data_frames_with_data:
            df_combined = pd.concat(data_frames_with_data, ignore_index=True)

        dlg = QtWidgets.QInputDialog()
        new_icon = QtGui.QIcon()
        new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        dlg.setWindowIcon(new_icon)
        dlg.setWindowTitle('Pedido Materiales')
        dlg.setLabelText('Introduce el pedido:')
        clickedButton=dlg.exec()

        if clickedButton == 1:
            numorder_pedmat = dlg.textValue()
            commands_client = ("""
                        SELECT orders."num_order",orders."num_offer",offers."client"
                        FROM offers
                        INNER JOIN orders ON (offers."num_offer"=orders."num_offer")
                        WHERE UPPER(orders."num_order") LIKE UPPER('%%'||%s||'%%')
                        """)
            conn = None
            try:
            # read the connection parameters
                params = config()
            # connect to the PostgreSQL server
                conn = psycopg2.connect(**params)
                cur = conn.cursor()
            # execution of commands one by one
                cur.execute(commands_client,(self.numorder,))
                results=cur.fetchone()
                client=results[2]
            # close communication with the PostgreSQL database server
                cur.close()
            # commit the changes
                conn.commit()
            except (Exception, psycopg2.DatabaseError) as error:
                print(error)
            finally:
                if conn is not None:
                    conn.close()
            excel_mat_order = material_order(df_combined,numorder_pedmat,client,self.variable)
            excel_mat_order.save_excel()

# Function to create material order for temperature elements
    def materialorder_temp(self):
        id_list=[]
        bar_list = []
        tube_list = []
        flange_list = []
        sensor_list = []
        head_list = []
        btb_list = []
        nipple_list = []
        spring_list = []
        plug_list = []
        puntal_list = []
        tw_list = []
        extcable_list = []

        for row in range(self.proxy.rowCount()):
            first_column_value = self.proxy.data(self.proxy.index(row, 0))
            id_list.append(first_column_value)

        for element in id_list:
            for row in range(self.model.rowCount()):
                if self.model.data(self.model.index(row, 0)) == element:
                    target_row = row
                    break
            if target_row is not None:
                code_bar = self.model.data(self.model.index(target_row, 76))
                code_tube = self.model.data(self.model.index(target_row, 79))
                code_flange = self.model.data(self.model.index(target_row, 82))
                code_sensor = self.model.data(self.model.index(target_row, 85))
                code_head = self.model.data(self.model.index(target_row, 88))
                code_btb = self.model.data(self.model.index(target_row, 91))
                code_nipple = self.model.data(self.model.index(target_row, 94))
                code_spring = self.model.data(self.model.index(target_row, 97))
                code_puntal = self.model.data(self.model.index(target_row, 100))
                code_plug = self.model.data(self.model.index(target_row, 103))
                code_tw = self.model.data(self.model.index(target_row, 106))
                code_extcable = self.model.data(self.model.index(target_row, 109))

                if code_bar != '':
                    tradcodbar =('VAN STONE ' + self.model.data(self.model.index(target_row, 10)) + " " + self.model.data(self.model.index(target_row, 11)) + " " + 
                                self.model.data(self.model.index(target_row, 12)) + ' ø=' if self.model.data(self.model.index(target_row, 9)) == 'Van-Stone TW'
                                else 'BARRA VAINA PARA RAIZ ø=' + self.model.data(self.model.index(target_row, 17)))
                    modelbar = ('U=' + self.model.data(self.model.index(target_row, 16)) + ' /L=' + self.model.data(self.model.index(target_row, 15)) if self.model.data(self.model.index(target_row, 9)) == 'Van-Stone TW'
                                else 'Barra ø=' + '35' if float(self.model.data(self.model.index(target_row, 17)))<=33.5 else self.model.data(self.model.index(target_row, 17)))
                    notesbar = ('RAÍZ ø=' + self.model.data(self.model.index(target_row, 17)) if self.model.data(self.model.index(target_row, 9)) == 'Van-Stone TW'
                                else '')
                    processbar = ''
                    materialbar = self.model.data(self.model.index(target_row, 14))
                    qtybar = self.model.data(self.model.index(target_row, 78))
                    bar_list.append([tradcodbar,modelbar,notesbar,processbar,materialbar,qtybar])

                if code_tube != '':
                    tradcodtube = 'TUBO VAINA'
                    schtube = self.model.data(self.model.index(target_row, 33))
                    notestube = ''
                    processtube = ''
                    materialtube = self.model.data(self.model.index(target_row, 14))
                    qtytube = self.model.data(self.model.index(target_row, 81))
                    tube_list.append([tradcodtube,schtube,notestube,processtube,materialtube,qtytube])

                if code_flange != '':
                    tradcodflange = ('BRIDA VAINA ' + self.model.data(self.model.index(target_row, 10)) + self.model.data(self.model.index(target_row, 11)) + " " + 
                                    self.model.data(self.model.index(target_row, 12)))
                    modelflange = ''
                    notesflange = ''
                    processflange = ''
                    materialflange = (self.model.data(self.model.index(target_row, 30)) if self.model.data(self.model.index(target_row, 9)) == 'Van-Stone TW'
                                        else self.model.data(self.model.index(target_row, 14)))
                    qtyflange = 1
                    flange_list.append([tradcodflange,modelflange,notesflange,processflange,materialflange,qtyflange])

                if code_sensor != '':
                    tradcodsensor = (self.model.data(self.model.index(target_row, 19)) + ' Sheat/Stem ø=' + self.model.data(self.model.index(target_row, 21)) + 'mm')
                    modelsensor = (self.model.data(self.model.index(target_row, 28)) + '-' + self.model.data(self.model.index(target_row, 27)) if code_sensor[:4] == 'BIME'
                                    else '')
                    notesensor = (self.model.data(self.model.index(target_row, 23)) + '-' + self.model.data(self.model.index(target_row, 24)) if code_sensor[:4] == 'BIME'
                                    else '')
                    processsensor = ''
                    materialsensor = ('PT100' if tradcodsensor[:5] == 'PT100'
                                    else self.model.data(self.model.index(target_row, 20)))
                    qtysensor = (1 if tradcodsensor[:5] == 'PT100' or code_sensor[:4] == 'BIME'
                                    else (float(self.model.data(self.model.index(target_row, 68)))/1000) if self.model.data(self.model.index(target_row, 68)) != '' else '')
                    sensor_list.append([tradcodsensor,modelsensor,notesensor,processsensor,materialsensor,qtysensor])

                if code_head != '':
                    tradcodhead = ('CABEZA DE CONEXIONES ' + self.model.data(self.model.index(target_row, 27)))
                    modelhead = self.model.data(self.model.index(target_row, 27))
                    noteshead = ''
                    processhead = self.model.data(self.model.index(target_row, 28))
                    materialhead = ('ALUMINIO' if modelhead[-2:] == 'Al' 
                                    else ('AC.CARBONO' if modelhead[-2:] == 'CS' 
                                    else ('AC.INOXIDABLE' if modelhead[-2:] == 'SS' 
                                    else 'MATERIAL CABEZA NO DEFINIDO')))
                    qtyhead = 1
                    head_list.append([tradcodhead,modelhead,noteshead,processhead,materialhead,qtyhead])

                if code_btb != '':
                    tradcodbtb = ('BIMETÁLICO-' + self.model.data(self.model.index(target_row, 28)) + '-' + self.model.data(self.model.index(target_row, 27)) if code_btb[:2] == 'BI' 
                                else ('TRANSMISOR-' + self.model.data(self.model.index(target_row, 29)) if code_btb[:2] == 'TR' 
                                else ('BLOQUE CERÁMICO-' + self.model.data(self.model.index(target_row, 29)) if code_btb[-7] == 'CE' 
                                else 'NO PREPARADO')))
                    modelbtb = (self.model.data(self.model.index(target_row, 23)) + '-' + self.model.data(self.model.index(target_row, 24)) if code_btb[:2] == 'BI' 
                                else '')
                    notesbtb = ''
                    processbtb = ''
                    materialbtb = (self.model.data(self.model.index(target_row, 20)) + '-' + self.model.data(self.model.index(target_row, 21)) if code_btb[:2] == 'BI' 
                                else ('CERÁMICO' if code_btb[:2] == 'CE' else ''))
                    qtybtb = self.model.data(self.model.index(target_row, 93))
                    btb_list.append([tradcodbtb,modelbtb,notesbtb,processbtb,materialbtb,qtybtb])

                if code_nipple != '':
                    tradcodnipple = self.model.data(self.model.index(target_row, 25))
                    modelnipple = ('' if self.model.data(self.model.index(target_row, 26)) == 'N/A' or self.model.data(self.model.index(target_row, 26))=='' else self.model.data(self.model.index(target_row, 26)))
                    notesnipple = ''
                    processnipple = ''
                    materialnipple = tradcodnipple[tradcodnipple.find('('):tradcodnipple.find('(')+9]
                    qtynipple = 1
                    nipple_list.append([tradcodnipple,modelnipple,notesnipple,processnipple,materialnipple,qtynipple])

                if code_spring != '':
                    tradcodspring = 'MUELLE SPRING LOADER'
                    modelspring = ''
                    notesspring = ''
                    processspring = ''
                    materialspring = 'AC.INOX'
                    qtyspring = 1
                    spring_list.append([tradcodspring,modelspring,notesspring,processspring,materialspring,qtyspring])

                if code_plug != '':
                    tradcodplug = ('TAPÓN Y CADENA-' + self.model.data(self.model.index(target_row, 69)))
                    modelplug = ''
                    notesplug = ''
                    processplug = ''
                    materialplug = tradcodplug[tradcodplug.find('('):tradcodplug.find('(')+9]
                    qtyplug = 1
                    plug_list.append([tradcodplug,modelplug,notesplug,processplug,materialplug,qtyplug])

                if code_puntal != '':
                    tradcodpuntal = ('PUNTAL SOLDADO ' + self.model.data(self.model.index(target_row, 32)))
                    modelpuntal = ''
                    notespuntal = ''
                    processpuntal = ''
                    materialpuntal = self.model.data(self.model.index(target_row, 14))
                    qtypuntal = float(code_puntal[1:8])/1000
                    puntal_list.append([tradcodpuntal,modelpuntal,notespuntal,processpuntal,materialpuntal,qtypuntal])

                if code_tw != '':
                    tradcodtw = 'VAINA ' + self.model.data(self.model.index(target_row, 77)) + tradcodflange
                    modelexttw = ''
                    notesexttw = ''
                    processexttw = ''
                    materialexttw = ''
                    qtyexttw = self.model.data(self.model.index(target_row, 108))
                    tw_list.append([tradcodtw,modelexttw,notesexttw,processexttw,materialexttw,qtyexttw])

                if code_extcable != '':
                    tradcodextcable = 'CABLE DE PROLONGACIÓN ' + tradcodsensor
                    modelextcable = ''
                    notesextcable = ''
                    processextcable = ''
                    materialextcable = self.model.data(self.model.index(target_row, 20))
                    qtyextcable = float(self.model.data(self.model.index(target_row, 68)))/1000 if self.model.data(self.model.index(target_row, 68)) != '' else ''
                    extcable_list.append([tradcodextcable,modelextcable,notesextcable,processextcable,materialextcable,qtyextcable])

    # Turn all lists in dataframe and grouped in order to sum same items
        data_lists = [
        (bar_list, "df_bar"),
        (tube_list, "df_tube"),
        (flange_list, "df_flange"),
        (sensor_list, "df_sensor"),
        (head_list, "df_head"),
        (btb_list, "df_btb"),
        (nipple_list, "df_nipple"),
        (spring_list, "df_spring"),
        (plug_list, "df_plug"),
        (puntal_list, "df_puntal"),
        (extcable_list, "df_extcable")]

        data_frames_with_data = []

        for data_list, df_name in data_lists:
            if data_list:
                df = pd.DataFrame(data_list)
                df = df.groupby([0, 1, 2, 3, 4])[5].sum().reset_index()
                data_frames_with_data.append(df)

        if data_frames_with_data:
            df_combined = pd.concat(data_frames_with_data, ignore_index=True)

        dlg = QtWidgets.QInputDialog()
        new_icon = QtGui.QIcon()
        new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        dlg.setWindowIcon(new_icon)
        dlg.setWindowTitle('Pedido Materiales')
        dlg.setLabelText('Introduce el pedido:')
        clickedButton=dlg.exec()

        if clickedButton == 1:
            numorder_pedmat = dlg.textValue()
            commands_client = ("""
                        SELECT orders."num_order",orders."num_offer",offers."client"
                        FROM offers
                        INNER JOIN orders ON (offers."num_offer"=orders."num_offer")
                        WHERE UPPER(orders."num_order") LIKE UPPER('%%'||%s||'%%')
                        """)
            conn = None
            try:
            # read the connection parameters
                params = config()
            # connect to the PostgreSQL server
                conn = psycopg2.connect(**params)
                cur = conn.cursor()
            # execution of commands one by one
                cur.execute(commands_client,(self.numorder,))
                results=cur.fetchone()
                client=results[2]
            # close communication with the PostgreSQL database server
                cur.close()
            # commit the changes
                conn.commit()
            except (Exception, psycopg2.DatabaseError) as error:
                print(error)
            finally:
                if conn is not None:
                    conn.close()
            excel_mat_order = material_order(df_combined,numorder_pedmat,client,self.variable)
            excel_mat_order.save_excel()


# Function to create material order for level elements
    def materialorder_level(self):
        id_list = []
        body_list = []
        cover_list = []
        glass_list = []
        gasket_list = []
        mica_list = []
        bolts_list = []
        nipplehex_list = []
        valve_list = []
        flangevalve_list = []
        nippletube_list = []
        dv_list = []
        plug_list = []
        antifrost_list = []
        illuminator_list = []

        for row in range(self.proxy.rowCount()):
            first_column_value = self.proxy.data(self.proxy.index(row, 0))
            id_list.append(first_column_value)

        for element in id_list:
            for row in range(self.model.rowCount()):
                if self.model.data(self.model.index(row, 0)) == element:
                    target_row = row
                    break
            if target_row is not None:
                code_body = self.model.data(self.model.index(target_row, 57))
                code_cover = self.model.data(self.model.index(target_row, 60))
                code_glass = self.model.data(self.model.index(target_row, 87))
                code_gasket = self.model.data(self.model.index(target_row, 84))
                code_mica = self.model.data(self.model.index(target_row, 93))
                code_bolts = self.model.data(self.model.index(target_row, 63))
                code_nipplehex = self.model.data(self.model.index(target_row, 66))
                code_valve = self.model.data(self.model.index(target_row, 69))
                code_flangevalve = self.model.data(self.model.index(target_row, 72))
                code_nippletube = self.model.data(self.model.index(target_row, 102))
                code_dv = self.model.data(self.model.index(target_row, 75))
                code_antifrost = self.model.data(self.model.index(target_row, 105))
                code_illuminator = self.model.data(self.model.index(target_row, 81))

                model_num = self.model.data(self.model.index(target_row, 9))[5:]
                conn_type = self.model.data(self.model.index(target_row, 15))
                nipplehexdim = self.model.data(self.model.index(target_row, 32))[8:]
                nippletubedim = self.model.data(self.model.index(target_row, 33))[8:]
                cc_length = int(self.model.data(self.model.index(target_row, 17)))

                commands_topbottom = ("""
                        SELECT *
                        FROM validation_data.level_topbottom_dim
                        WHERE model_num = %s
                        """)
                commands_sideside = ("""
                        SELECT *
                        FROM validation_data.level_sideside_dim
                        WHERE model_num = %s
                        """)
                conn = None
                try:
                # read the connection parameters
                    params = config()
                # connect to the PostgreSQL server
                    conn = psycopg2.connect(**params)
                    cur = conn.cursor()
                # execution of commands one by one
                    if conn_type == 'Top-Bottom':
                        cur.execute(commands_topbottom,(model_num,))
                        results=cur.fetchone()
                        if nipplehexdim == '1/2" NPT':
                            body_length=results[1]
                        else:
                            body_length=results[2]
                    elif conn_type == 'Side-Side':
                        cur.execute(commands_sideside,(model_num,))
                        results=cur.fetchone()
                        h_dim=int(results[1])
                        if cc_length < h_dim + 32:
                            body_length = cc_length + 32 + 100
                        else:
                            body_length = cc_length - 32 + 100
                # close communication with the PostgreSQL database server
                    cur.close()
                # commit the changes
                    conn.commit()
                except (Exception, psycopg2.DatabaseError) as error:
                    print(error)
                finally:
                    if conn is not None:
                        conn.close()

                if code_body != '':
                    tradcodbody = ('CUERPO DE NIVEL 1S-' + code_body + 'LONGITUD ' + body_length + 'MM')
                    modelbody = nipplehexdim
                    designbody = '40x40'
                    processbody = (nipplehexdim + '-M')
                    materialbody = self.model.data(self.model.index(target_row, 10))
                    qtybody = self.model.data(self.model.index(target_row, 59))
                    body_list.append([tradcodbody,modelbody,designbody,processbody,materialbody,qtybody])

                if code_cover != '':
                    commands_coverdim = ("""
                        SELECT *
                        FROM validation_data.level_cover_dim
                        WHERE cover = %s
                        """)
                    conn = None
                    try:
                    # read the connection parameters
                        params = config()
                    # connect to the PostgreSQL server
                        conn = psycopg2.connect(**params)
                        cur = conn.cursor()
                    # execution of commands one by one
                        cur.execute(commands_coverdim,(model_num[2:6],))
                        results=cur.fetchone()
                        length=results[1]
                        bores=results[2]
                    # close communication with the PostgreSQL database server
                        cur.close()
                    # commit the changes
                        conn.commit()
                    except (Exception, psycopg2.DatabaseError) as error:
                        print(error)
                    finally:
                        if conn is not None:
                            conn.close()

                    tradcodcover = ('CUBIERTA DE NIVEL MODELO 1S-' + model_num[5:6])
                    modelcover = ('L=' + length)
                    designcover = '80x30'
                    processcover = (bores + 'taladros')
                    materialcover = self.model.data(self.model.index(target_row, 10))
                    qtycover = self.model.data(self.model.index(target_row, 62))
                    cover_list.append([tradcodcover,modelcover,designcover,processcover,materialcover,qtycover])

                if code_glass != '':
                    tradcodglass = ('VIDRIO DE NIVEL MODELO 1S-' + model_num[5:6])
                    modelglass = 'TRANSPARENCIA' if model_num[6:7] == 'T' else 'REFLEXIÓN'
                    designglass = ''
                    processglass = ''
                    materialglass ='BOROSILICATO'
                    qtyglass = self.model.data(self.model.index(target_row, 89))
                    glass_list.append([tradcodglass,modelglass,designglass,processglass,materialglass,qtyglass])

                if code_gasket != '':
                    tradcodgasket = ('JUNTAS NORMALES MODELO 1S-' + model_num[5:6])
                    modelgasket = 'TRANSPARENCIA' if model_num[6:7] == 'T' else 'REFLEXIÓN'
                    designgasket = ''
                    processgasket = ''
                    materialgasket ='GRAFOIL'
                    qtygasket = self.model.data(self.model.index(target_row, 86))
                    gasket_list.append([tradcodgasket,modelgasket,designgasket,processgasket,materialgasket,qtygasket])

                if code_mica != '':
                    tradcodmica = ('JUNTAS NORMALES MODELO 1S-' + model_num[5:6])
                    modelmica = 'TRANSPARENCIA'
                    designmica = ''
                    processmica = ''
                    materialmica ='MICA'
                    qtymica = self.model.data(self.model.index(target_row, 95))
                    mica_list.append([tradcodmica,modelmica,designmica,processmica,materialmica,qtymica])

                if code_bolts != '':
                    tradcodbolts = 'TIRANTE RECTO M10 (CON UNA TUERCA M10)' if model_num[6:7] == 'T' else 'ESPÁRRAGO EN "U" M10 (CON DOS TUERCAS M10)'
                    modelbolts = 'TRANSPARENCIA' if model_num[6:7] == 'T' else 'REFLEXIÓN'
                    designbolts = 'M10x132 mm' if model_num[6:7] == 'T' else ''
                    processbolts = 'cabeza exag 17 e/c' if model_num[6:7] == 'T' else ''
                    materialbolts = 'B7/2H' if model_num[6:7] in ['T','R'] else self.model.data(self.model.index(target_row, 24))
                    qtybolts = self.model.data(self.model.index(target_row, 65))
                    bolts_list.append([tradcodbolts,modelbolts,designbolts,processbolts,materialbolts,qtybolts])

                if code_nipplehex != '':
                    tradcodnipplehex = 'NIPLO HEXAGONAL ' + nipplehexdim + 'LONG ' + (cc_length-length-72+20) + ' mm'
                    modelnipplehex = (cc_length-length-72+20) + ' mm'
                    designnipplehex = ''
                    processnipplehex = ''
                    materialnipplehex = self.model.data(self.model.index(target_row, 10))
                    qtynipplehex = self.model.data(self.model.index(target_row, 68))
                    nipplehex_list.append([tradcodnipplehex,modelnipplehex,designnipplehex,processnipplehex,materialnipplehex,qtynipplehex])

                if code_valve != '':
                    tradcodvalve = 'VÁLVULA DE NIVEL DESPLAZADO ' + self.model.data(self.model.index(target_row, 18))
                    modelvalve = nipplehexdim[:4] + ' x ' + nipplehexdim[:4]
                    designvalve = nipplehexdim[-3:] + '-H'
                    processvalve = ''
                    materialvalve = 'A-105' if self.model.data(self.model.index(target_row, 18))[-2:] == 'NB' else '316 SS'
                    qtyvalve = self.model.data(self.model.index(target_row, 71))
                    valve_list.append([tradcodvalve,modelvalve,designvalve,processvalve,materialvalve,qtyvalve])

                if code_flangevalve != '':
                    tradcodflangevalve = 'BRIDA VÁLVULA ' + self.model.data(self.model.index(target_row, 12)) + self.model.data(self.model.index(target_row, 13)) + self.model.data(self.model.index(target_row, 14))
                    modelflangevalve = ''
                    designflangevalve = ''
                    processflangevalve = ''
                    materialflangevalve = self.model.data(self.model.index(target_row, 10))
                    qtyflangevalve = self.model.data(self.model.index(target_row, 74))
                    flangevalve_list.append([tradcodflangevalve,modelflangevalve,designflangevalve,processflangevalve,materialflangevalve,qtyflangevalve])

                if code_dv != '':
                    tradcoddv = ('TAPÓN PURGADOR ' + self.model.data(self.model.index(target_row, 20)) + self.model.data(self.model.index(target_row, 21)) + '-M' if code_dv[:2] == 'PL' 
                                else ('VÁLVULA TMGV ' + nipplehexdim + ' x ' + self.model.data(self.model.index(target_row, 20)) + self.model.data(self.model.index(target_row, 21)) if code_dv[:2] == 'VL'
                                else ('BRIDA ' + self.model.data(self.model.index(target_row, 20)) + self.model.data(self.model.index(target_row, 21)) + self.model.data(self.model.index(target_row, 22)) if code_dv[:2] == 'FL' else '')))
                    modeldv = ''
                    designdv = ''
                    processdv = ''
                    materialdv = self.model.data(self.model.index(target_row, 10))
                    qtydv = self.model.data(self.model.index(target_row, 77))
                    dv_list.append([tradcoddv,modeldv,designdv,processdv,materialdv,qtydv])

                if tradcoddv[:3] == 'VÁL':
                    tradcodplug = 'TAPÓN NORMAL ' + self.model.data(self.model.index(target_row, 20)) + self.model.data(self.model.index(target_row, 21))
                    modelplug = ''
                    designplug = ''
                    processplug = ''
                    materialplug = self.model.data(self.model.index(target_row, 10))
                    qtyplug = 2
                    plug_list.append([tradcodplug,modelplug,designplug,processplug,materialplug,qtyplug])

                if code_nippletube != '':
                    tradcodnippletube = 'NIPLO TUBO ' + nippletubedim
                    modelnippletube = '80 mm'
                    designnippletube = ''
                    processnippletube = ''
                    materialnippletube = 'A-106' if self.model.data(self.model.index(target_row, 10)) in ['Carbon Steel','ASTM A350 LF2 CL2'] else self.model.data(self.model.index(target_row, 10))
                    qtynippletube = self.model.data(self.model.index(target_row, 104))
                    nippletube_list.append([tradcodnippletube,modelnippletube,designnippletube,processnippletube,materialnippletube,qtynippletube])

                if code_illuminator != '':
                    tradcodilluminator = 'ILUMINADOR ' + model_num[3:7]
                    modelilluminator = model_num[:6].replace('S','I')
                    designilluminator = ''
                    processilluminator = ''
                    materialilluminator = 'HIERRO'
                    qtyilluminator = self.model.data(self.model.index(target_row, 74))
                    illuminator_list.append([tradcodilluminator,modelilluminator,designilluminator,processilluminator,materialilluminator,qtyilluminator])

                if code_antifrost != '':
                    tradcodantifrost = 'ANTIHIELO TAMAÑO ' + model_num[3:7]
                    modelantifrost = ''
                    designantifrost = ''
                    processantifrost = ''
                    materialantifrost = 'METACRILATO'
                    qtyantifrost = self.model.data(self.model.index(target_row, 107))
                    antifrost_list.append([tradcodantifrost,modelantifrost,designantifrost,processantifrost,materialantifrost,qtyantifrost])

    # Turn all lists in dataframe and grouped in order to sum same items
        data_lists = [
        (body_list, "df_body"),
        (cover_list, "df_cover"),
        (glass_list, "df_glass"),
        (gasket_list, "df_gasket"),
        (mica_list, "df_mica"),
        (bolts_list, "df_bolts"),
        (nipplehex_list, "df_nipplehex"),
        (valve_list, "df_valve"),
        (flangevalve_list, "df_flangevalve"),
        (nippletube_list, "df_nippletube"),
        (dv_list, "df_list"),
        (antifrost_list, "df_antifrost"),
        (illuminator_list, "df_illuminator")]

        data_frames_with_data = []

        for data_list, df_name in data_lists:
            if data_list:
                df = pd.DataFrame(data_list)
                df = df.groupby([0, 1, 2, 3, 4])[5].sum().reset_index()
                data_frames_with_data.append(df)

        if data_frames_with_data:
            df_combined = pd.concat(data_frames_with_data, ignore_index=True)

        dlg = QtWidgets.QInputDialog()
        new_icon = QtGui.QIcon()
        new_icon.addPixmap(QtGui.QPixmap("//nas01/DATOS/Comunes/EIPSA-ERP/Recursos/Iconos/icon.ico"), QtGui.QIcon.Mode.Normal, QtGui.QIcon.State.Off)
        dlg.setWindowIcon(new_icon)
        dlg.setWindowTitle('Pedido Materiales')
        dlg.setLabelText('Introduce el pedido:')
        clickedButton=dlg.exec()

        if clickedButton == 1:
            numorder_pedmat = dlg.textValue()
            commands_client = ("""
                        SELECT orders."num_order",orders."num_offer",offers."client"
                        FROM offers
                        INNER JOIN orders ON (offers."num_offer"=orders."num_offer")
                        WHERE UPPER(orders."num_order") LIKE UPPER('%%'||%s||'%%')
                        """)
            conn = None
            try:
            # read the connection parameters
                params = config()
            # connect to the PostgreSQL server
                conn = psycopg2.connect(**params)
                cur = conn.cursor()
            # execution of commands one by one
                cur.execute(commands_client,(self.numorder,))
                results=cur.fetchone()
                client=results[2]
            # close communication with the PostgreSQL database server
                cur.close()
            # commit the changes
                conn.commit()
            except (Exception, psycopg2.DatabaseError) as error:
                print(error)
            finally:
                if conn is not None:
                    conn.close()
            excel_mat_order = material_order(df_combined,numorder_pedmat,client,self.variable)
            excel_mat_order.save_excel()


# Function to create fabrication order
    def faborder(self):
        print('b')

# Function to enable copy and paste cells
    def keyPressEvent(self, event):
        if event.matches(QKeySequence.StandardKey.Copy):
            selected_indexes = self.tableEditTags.selectionModel().selectedIndexes()
            if selected_indexes:
                clipboard = QApplication.clipboard()
                text = self.get_selected_text(selected_indexes)
                clipboard.setText(text)

        elif event.matches(QKeySequence.StandardKey.Paste):
            selected_indexes = self.tableEditTags.selectionModel().selectedIndexes()
            if selected_indexes:
                clipboard = QApplication.clipboard()
                text = clipboard.text()
                for index in selected_indexes:
                    current_row = index.row()
                    current_column = index.column()
                    first_column_value = self.proxy.data(self.proxy.index(current_row, 0))
                    target_row = None
                    for row in range(self.model.rowCount()):
                        if self.model.data(self.model.index(row, 0)) == first_column_value:
                            target_row = row
                            break
                    if target_row is not None:
                        target_index = self.model.index(target_row, current_column)
                        self.model.setData(target_index, text, Qt.ItemDataRole.EditRole)  # Pegar el valor en todas las celdas seleccionadas
                self.model.submitAll()

        super().keyPressEvent(event)

# Function to get the text of the selected cells
    def get_selected_text(self, indexes):
        if len(indexes) == 1:  # Si solo hay una celda seleccionada
            index = indexes[0]
            cell_data = index.data(Qt.ItemDataRole.DisplayRole)
            return cell_data
        else:
            rows = set()
            cols = set()
            for index in indexes:
                rows.add(index.row())
                cols.add(index.column())

            text_doc = QTextDocument()
            cursor = QTextCursor(text_doc)

            for row in sorted(rows):
                for col in sorted(cols):
                    index = self.model.index(row, col)  # Obtener el índice correspondiente
                    cell_data = index.data(Qt.ItemDataRole.DisplayRole)
                    cursor.insertText(str(cell_data))
                    cursor.insertText('\t')  # Tab separador de columnas
                cursor.insertText('\n')  # Salto de línea al final de la fila

            return text_doc.toPlainText()

# Function to count selected cells and sum its values
    def countSelectedCells(self):
        if len(self.tableEditTags.selectedIndexes()) > 1:
            locale.setlocale(locale.LC_ALL, 'es_ES.UTF-8')
            self.label_SumItems.setText("")
            self.label_SumValue.setText("")
            self.label_CountItems.setText("")
            self.label_CountValue.setText("")

            sum_value = sum([self.euro_string_to_float(str(ix.data())) if re.match(r'^[\d.,]+\sÇ$', str(ix.data())) else float(str(ix.data()).replace(',', '.')) if str(ix.data()).replace(',', '.').replace('.', '', 1).isdigit() else 0 for ix in self.tableEditTags.selectedIndexes()])

            count_value = len([ix for ix in self.tableEditTags.selectedIndexes() if ix.data() != ""])
            if sum_value > 0:
                self.label_SumItems.setText("Suma:")
                self.label_SumValue.setText(locale.format_string("%.2f", sum_value, grouping=True))
            if count_value > 0:
                self.label_CountItems.setText("Recuento:")
                self.label_CountValue.setText(str(count_value))
        else:
            self.label_SumItems.setText("")
            self.label_SumValue.setText("")
            self.label_CountItems.setText("")
            self.label_CountValue.setText("")

# Function to format money string values
    def euro_string_to_float(self, euro_str):
        match = re.match(r'^([\d.,]+)\s€$', euro_str)
        if match:
            number_str = match.group(1)
            number_str = number_str.replace('.', '').replace(',', '.')
            return float(number_str)
        else:
            return 0.0

# Function to select which material order has to be created
    def materialorder(self, variable):
        if self.variable == 'Caudal':
            self.materialorder_flow()
        elif self.variable == 'Temperatura':
            self.materialorder_temp()
        elif self.variable == 'Nivel':
            self.materialorder_level()

    def createContextMenu(self):
        self.context_menu = QtWidgets.QMenu(self)
        hide_columns_action = self.context_menu.addAction("Ocultar Columnas")
        hide_columns_action.triggered.connect(self.hideSelectedColumns)

    def showColumnContextMenu(self, pos):
        header = self.tableEditTags.horizontalHeader()
        column = header.logicalIndexAt(pos)
        self.context_menu.exec(self.tableEditTags.mapToGlobal(pos))

    def hideSelectedColumns(self):
        selected_columns = set()
        header = self.tableEditTags.horizontalHeader()
        for index in header.selectionModel().selectedColumns():
            selected_columns.add(index.column())

        for column in selected_columns:
            self.tableEditTags.setColumnHidden(column, True)
            self.hiddencolumns.append(column)

        self.context_menu.close()


if __name__ == "__main__":
    import sys
    app = QtWidgets.QApplication(sys.argv)
    config_obj = configparser.ConfigParser()
    config_obj.read(r"C:\Program Files\ERP EIPSA\database.ini")
    dbparam = config_obj["postgresql"]
    # set your parameters for the database connection URI using the keys from the configfile.ini
    user_database = dbparam["user"]
    password_database = dbparam["password"]

    if not createConnection(user_database, password_database):
        sys.exit()

    EditTags_Window = Ui_EditTags_Window()
    EditTags_Window.show()
    sys.exit(app.exec())